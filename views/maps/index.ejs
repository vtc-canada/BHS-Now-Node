<%
    var translate = {
        'en' : {
            'You do not have sufficient privileges to access':'You do not have sufficient privileges to access',
            'Error':'Error',
            'Buildings':'Buildings',
            'Date':'Date',
            'Equipment':'Equipment',
            'Device':'Device',
            'Alarm Type':'Alarm Type',
            'System Health':'System Health',
            'System Throughput':'System Throughput',
            'Time In System':'Time In System',
            'BHS Overview':'BHS Overview',
            'Time':'Time',
            'Alarms':'Alarms',
            'Daily Reminders':'Daily Reminders',
            'Predictive Mainenance Tasks':'Predictive Mainenance Tasks',
            'DEVICE':'DEVICE',
            'REASON':'REASON',
            'Uptime':'Uptime',
            'Failsafe Rate':'Failsafe Rate',
            'Tracking Rate':'Tracking Rate',
            'Key Performance Indicators':'Key Performance Indicators',
            'Throughput (bph)':'Throughput (bph)',
            'State':'State',
            'Jam Rate':'Jam Rate',
            'ATR Read Rate':'ATR Read Rate',
            'Cancel':'Cancel',
            'Delete':'Delete',
            'To create a new owner':'To create a new owner, select the contact and/or company associated with this building',
            'To create a new sale':'To create a new sale, click create',
            'Create':'Create',
            'Contact':'Contact',
            'Company':'Company'
        },
        'es' : {
            'You do not have sufficient privileges to access':'Usted no tiene suficientes privilegios para acceder a',
            'Error':'Error',
            'Buildings':'Salpicadero',
            'Date':'Date',
            'Equipment':'Equipment',
            'Device':'Device',
            'REASON':'REASON',
            'Alarm Type':'Alarm Type',
            'System Health':'System Health',
            'System Throughput':'System Throughput',
            'Time In System':'Time In System',
            'BHS Overview':'BHS Overview',
            'Time':'Time',
            'Alarms':'Alarms',
            'Daily Reminders':'Daily Reminders',
            'Predictive Mainenance Tasks':'Predictive Mainenance Tasks',
            'DEVICE':'DEVICE',
            'Uptime':'Uptime',
            'Failsafe Rate':'Failsafe Rate',
            'Tracking Rate':'Tracking Rate',
            'Key Performance Indicators':'Key Performance Indicators',
            'Throughput (bph)':'Throughput (bph)',
            'State':'State',
            'Jam Rate':'Jam Rate',
            'ATR Read Rate':'ATR Read Rate',
            'Cancel':'Cancel',
            'Delete':'Delete',
            'To create a new owner':'To create a new owner, select the contact and/or company associated with this building',
            'To create a new sale':'To create a new sale, click create',
            'Create':'Create',
            'Contact':'Contact',
            'Company':'Company'
        }
    }
%>

<!--<div class="row-fluid page-banner">
    <div class="banner-div"><i class="icon-building icon-1x banner-icon-top"></i><div class="banner-div-text"><%= translate[req.session.user.locale]['Buildings'] %></div></div>
</div>
-->
        <!-- Throws in Error messages if they were passed in from the controller -->
<% if(typeof(errormessage)!='undefined'){ %>
<div class="alert alert-error" style="border-radius:0px;">
    <button type="button" class="close" data-dismiss="alert">Ã—</button>
    <strong><%= translate[req.session.user.locale]['Error'] %>:</strong>
    <%= translate[req.session.user.locale][errormessage] %><% if(typeof(errorurl)!='undefined'){ %> <%= errorurl %><% } %>
</div>
<% } %>

<div id="map_wrapper" style="width:100%;">

</div>

<div id="building_slideup_wrapper" style="width:100%;">

</div>


<!--<div class="row-fluid edit-item-section" style="margin-top:19px;">
    <div class="span10 offset1 page-controls-wrapper">
        <div class="row-fluid" id="reportheader"><span style="padding-left:10px;" id="building-section-title">Apartments</span>
        	<div class="pull-right" style="margin-right:10px;">Constrain Building Results to Visible Map Area</div>
        	<div class="pull-right"><input id="constrain_gps" type="checkbox" style="margin-right: 10px;margin-top: -3px;"></div>
  		 </div>
        <div class="row-fluid " id="iframediv" >
        	<div class="content-wrapper map-wrapper" >

            </div>
        </div>
    </div>
</div>
-->

<div id="search_controls" class="row-fluid" id="search_controls">
	
	<div class="row-fluid" id="search_toggler" style="position:relative" scrollstate="top">
		<div class="arrow-down search-toggler-arrow"><i class="icon-chevron-down icon-3x"></i></div>
		<div class="arrow-down scroll-icon"><i class="icon-search icon-3x"></i></div>
		<div class="arrow-up search-toggler-arrow"><i class="icon-chevron-up icon-3x"></i></div>
		<div class="arrow-up scroll-icon"><i class="icon-globe icon-3x"></i></div>
		
	</div>

    <div class="row-fluid">
        <div class="span8 offset2 create-report-controls" style="padding-top: 10px;">
           <div class="row-fluid" style="width: 95%;margin-left: 5%;">
               <div class="row">
                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_address">Address:</label></div>
                   <div class="span8 report-control-right-control">
                       <input type="text" id="search_address" value="">
                   </div>
               </div>
               <div class="row">
                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_contact">Owner:</label></div>
                   <div class="span8 report-control-right-control">
                       <input type="text" id="search_contact" value="">
                   </div>
               </div>
               <div class="row">
                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_company">Property Manager:</label></div>
                   <div class="span8 report-control-right-control">
                       <input type="text" id="search_company" value="">
                   </div>
               </div>
               <div class="row" style="margin-top:15px; display:none;">
                   <div class="span7 report-control-left-label">
                   		<a id="advanced_criteria_toggler" data-toggle="collapse" data-target="#collapseadvanced" style="text-decoration: none; color: #5a6573;">
							<div style="float:left;"></i><i class="icon-plus-sign icon-2x"></i></div><div style="float: left; padding-bottom: 20px;margin-top: -6px;margin-left: 20px;"><h4>Advanced Criteria</h4></div>
						</a>
                   </div>
               </div>
               <div class="row " id="collapseadvanced">
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="reporttype">Units:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left" style="width:35px;"><span id="units_min">0</span></div>
	                   			
	                   			<input id="units_slider" type="text" class="" value="" data-slider-min="0" data-slider-max="1000" data-slider-step="5" data-slider-value="[0,1000]"/>
	                   			&nbsp&nbsp
	                   			<span id="units_max">1000+</span>
	                   		</div>
	                   </div>
	                   
	               </div>
	               <div class="row-fluid">
	               		<div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;">
	               			<label for="start_time">Sale Date:</label>
	           			</div>
	           			<div class="input-append span3 report-control-right-control" id="start_time_gen">
	           				<input class="" data-format="yyyy-MM-dd" style="width:150px; max-width:70%;" id="start_time" type="text" value="">
	       					<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>
	       				</div>
	           			<div class="input-append span1 report-control-right-control">
	       					<span style="display: inline-block;width: auto;height: 20px;min-width: 16px;padding: 4px 5px;font-size: 14px;font-weight: normal;line-height: 20px;">to</span>
						</div>
	           			<div class="input-append span3 report-control-right-control" id="end_time_gen">
	           				<input class="" data-format="yyyy-MM-dd" style="width:150px; max-width:70%;" id="end_time" type="text" value="">
	   						<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>
	       				</div>
	       				
	   				</div>
	   			</div>
           </div>
        </div>
    </div>
</div>


<!-- There next templates are the pieces of the BHS Overview drawing -->
<!-- In order, they represent the columns across the diagram -->


<div id="table_controls" class="row-fluid" style="margin-top:0px;">
    <div class="span10 offset1 page-controls-wrapper">
        <div class="row-fluid" id="reportheader"><span style="padding-left:10px;">Buildings</span>
             <!--<div style="margin-right:10px;font-weight: 400;" class="btn btn-primary pull-right save_pull" id="create_building">Create New</div>-->
        
        </div>
        <div class="row-fluid " id="iframediv" style="padding: 0px;">
            <div class="row-fluid">
                <table id="buildings" class="display" cellspacing="0" width="100%">
			        <thead>
			            <tr>
			            	<th>Id<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Address<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Units<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Owner<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Property Manager<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Sale Date<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			            </tr>
			        </thead>
			 
			    </table>
            </div>
        </div>
    </div>
</div>



<script type="text/template" id="building-template">
	<div class="row-fluid building-map-details" style="position:relative; cursor:default;" building_id="{{=building_id}}">
		<div style="position: absolute;top: 0px;right: 0px;color: #C52D22;cursor: pointer;margin-right: 12px;margin-top: 7px;">
		<i class="icon-remove-sign icon-2x close-building-map-details"></i>
		</div>
		<div class="building-details-padder">	
			<div class="row-fluid" style="white-space:nowrap;">
				{{ var tempimages = JSON.parse(images); if(tempimages!=null&&tempimages.length>0){ }}
				<div class="building-card-images-wrapper">
					{{var images = JSON.parse(images); for( key in images){ }}
				 		<a href="{{=images[key].image}}" data-lightbox="{{=images[key].image}}" class="span2 building-overlay-block-picture"><img src="{{=images[key].thumb}}"></a>
					{{ } }}
				</div>
				{{ } }}
				<div class="span3 building-overlay-block-address">
					<div class="row-fluid">Address:</div>
					<div class="row-fluid block-value">{{=address_1}}</div>
					<div class="row-fluid block-value">{{=address_2}}</div>
					<div class="row-fluid block-value"><a href="/buildings/{{=building_id}}">View History</a></div>
				</div>
				
				<div class="span3 building-overlay-block-details">
					{{ for(var i=0; i<contacts.length; i++){ if(contacts[i].contact_type=='owner'){ }}
					<div class="row-fluid" contact_id="{{=contacts[i].contact_id}}">
						<div class="pull-left">Owner:</div>
						<div class="pull-right">{{=contacts[i].contact_name}}</div>
					</div>
					{{ } } }}
					{{ for(var i=0; i<contacts.length; i++){ if(contacts[i].contact_type=='seller'){ }}
					<div class="row-fluid" contact_id="{{=contacts[i].contact_id}}">
						<div class="pull-left">Seller:</div>
						<div class="pull-right">{{=contacts[i].contact_name}}</div>
					</div>
					{{ } } }}
					<div class="row-fluid">
						<div class="pull-left">Prop. Mngr:</div>
						<div class="pull-right">{{=property_mgmt_company}}</div>
					</div>
					<div class="row-fluid">
						<div class="pull-left">Price:</div>
						<div class="pull-right block-value">{{=last_sale_price}}</div>
					</div>
				</div>
				<div class="span3 building-overlay-block-details">
					<div class="row-fluid">
						<div class="pull-left">Amount of Suites:</div>
						<div class="pull-right block-value">{{=unit_quantity}}</div>
					</div>
					<div class="row-fluid">
						<div class="pull-left">Sale Date:</div>
						<div class="pull-right block-value">{{=sale_date}}</div>
					</div>
					<div class="row-fluid">
						<div class="pull-left">Price Per Unit:</div>
						<div class="pull-right block-value">{{=unit_price}}</div>
					</div>
					<div class="row-fluid">
						<div class="pull-left">Price:</div>
						<div class="pull-right block-value">{{=last_sale_price}}</div>
					</div>
					
				</div>
				<div class="span3 building-overlay-block-details">
					<div class="row-fluid">
						<div class="pull-left">Bachelor Rent:</div>
						<div class="pull-right block-value">{{=bachelor_price}}</div>
					</div>
					<div class="row-fluid">
						<div class="pull-left">1 Bdrm Rent:</div>
						<div class="pull-right block-value">{{=bedroom1_price}}</div>
					</div>
					<div class="row-fluid">
						<div class="pull-left">2 Bdrm Rent:</div>
						<div class="pull-right block-value">{{=bedroom2_price}}</div>
					</div>
					<div class="row-fluid">
						<div class="pull-left">3 Bdrm Rent:</div>
						<div class="pull-right block-value">{{=bedroom3_price}}</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</script>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAbxXYHzi3ypnRymTns27yE_o-fEyj6cIE"></script>



<script>



	var markers,map;
    var alarms;
    var minimumTableSize = 420;
    var layers = {}
        
    
    $(document).ready(function(){
    
    	var unitsMax = null;
    	var unitsMin = null;
    	var sliderLimit = 1000;
        var leaveSalesExpanded = false;
    
    	var buildingtemplate = _.template($('#building-template').html());
    	
    	
    	function buildingSelected(building_id){
    		//$('#building_slideup_wrapper').empty();
			setMapSize();
    		socket.get('/buildings/getbuilding/'+building_id,{},function(responseBuilding){
    			socket.get('/buildings/getcontacts/'+building_id,{},function(responseContacts){
    				if(typeof(responseContacts[0])!='undefined'){
    					responseBuilding.contacts = responseContacts[0];
    				}else{
    					responseBuilding.contacts = [];
    				}
    				$('#building_slideup_wrapper').empty();
    				responseBuilding.address_1=buildStreetString(responseBuilding.street_number_begin,responseBuilding.street_number_end,responseBuilding.street_name);
	    			responseBuilding.address_2=buildCityProvinceString(responseBuilding.city,responseBuilding.province);
	    			responseBuilding.sale_date=toDateTimeString(responseBuilding.sale_date);
	    			
    				responseBuilding.unit_price = responseBuilding.unit_price==null?'$0.00':'$'+responseBuilding.unit_price.toFixed(2);
    				responseBuilding.last_sale_price = responseBuilding.last_sale_price==null?'$0.00':'$'+responseBuilding.last_sale_price;
    				responseBuilding.bachelor_price = responseBuilding.bachelor_price==null?'$0.00':'$'+responseBuilding.bachelor_price;
    				responseBuilding.bedroom1_price = responseBuilding.bedroom1_price==null?'$0.00':'$'+responseBuilding.bedroom1_price;
    				responseBuilding.bedroom2_price = responseBuilding.bedroom2_price==null?'$0.00':'$'+responseBuilding.bedroom2_price;
    				responseBuilding.bedroom3_price = responseBuilding.bedroom3_price==null?'$0.00':'$'+responseBuilding.bedroom3_price;
    				
    				
	    			$('#building_slideup_wrapper').append(buildingtemplate(responseBuilding));
	    			$('.close-building-map-details').click(function(){
	    				$(this).parents('.building-map-details').remove();
	    				setMapSize();
	    			});
	    			setTimeout(function(){
						setMapSize();
	    			},500);
					setMapSize();
					
					markers.blockIdleEvent = true;
					map.panTo(markers.getPosition(building_id));
    			});
    			
    		});
    	
    		// if it's being filled for the first time:
    		//if($('#building_slideup_wrapper').html()!=''){
    		//	$('#map_wrapper').height($('#map_wrapper').height()-$('#building_slideup_wrapper').height()); //shrink the map height
    		//}
    	}
    	
    	$('#search_toggler').click(function(){
    		snapFar();
    	});
    
    
    	function Markers(){
    		var self = this;
    		
    		this.constrainGPS = false;
    		this.blockIdleEvent = true;
    		this.collection = {};
    		
    		this.clearMarkers = function (){
    			for(marker in self.collection){
    				self.collection[marker].destroy();
    			}
    			self.collection = {};
    		}
    		
    		this.addMarker = function(building)
    		{
    			if(building.latitude !=null)
    			{
    				self.collection[building.building_id] = (new ActiveMarker(building,map));
				}
    			//if(!constrainGPS&&!map.getBounds().contains(self.collection[building.building_id].googleMarker.getPosition())){
    				
    			//}
    		}
    		
    		this.checkMarkersBounded = function(){
    			for(marker in self.collection){
    				if(typeof(self.collection[marker].googleMarker)!='undefined'){
	    				if(!map.getBounds().contains(self.collection[marker].googleMarker.getPosition())){
	    					return false;
	    				}
    				}
    			}
    			return true;
    		}
    		
    		this.verifyBounds = function(){
				//  Create a new viewpoint bound
				if(!self.constrainGPS&&!self.checkMarkersBounded()){  // only attempting to check and correct position if we're not in lat/lng mode
    				self.blockIdleEvent = true;
    				var bounds = new google.maps.LatLngBounds ();
	    			for(marker in self.collection){
	    				if(typeof(self.collection[marker].googleMarker)!='undefined'){
	    					bounds.extend(self.collection[marker].googleMarker.getPosition());
	    				}
	    			}
					map.fitBounds(bounds);
				}
    		}
    		
			this.clearSelected = function(){
				for(marker in self.collection){
    				self.collection[marker].clearSelected();
    			}
			}
    		
    		this.toggle = function(building_id){
    			self.collection[building_id].toggle();
    		}
    		
    		this.getPosition = function(building_id){
    			return self.collection[building_id].getPosition();
    		}
    		
    	} 
    	
    	function ActiveMarker(building){
    		var self = this;
    		this.building = building;
    		this.googleMarker;
    		this.selected = false;
    		
    		var blueColor = "2F76EE"; // a random blue color that i picked
			this.blueImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + blueColor,
            new google.maps.Size(21, 34),
            new google.maps.Point(0,0),
            new google.maps.Point(10, 34));
            var redColor = "F75448"
            this.redImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + redColor,
            new google.maps.Size(21, 34),
            new google.maps.Point(0,0),
            new google.maps.Point(10, 34));
			this.pinShadow = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",
            new google.maps.Size(40, 37),
            new google.maps.Point(0, 0),
            new google.maps.Point(12, 35));
            
            this.getPosition = function(){
            	return self.googleMarker.getPosition();
            }
    		
    		if(building.latitude!=null)
			{
    			self.googleMarker = new google.maps.Marker({
				    position: new google.maps.LatLng(building.latitude,building.longitude),
				    map: map,
				    icon:this.redImage,
				    title:(typeof(building.street_number_begin)!='undefined'?building.street_number_begin:'')+(typeof(building.street_number_end)!='undefined'?'-'+building.street_number_end:'')+(typeof(building.street_name)!='undefined'?' '+building.street_name:'')
				});
				google.maps.event.addListener(self.googleMarker,'click',function(){
					self.toggle();
				});
			}
			this.clearSelected = function(){
				self.selected = false;
				$('#buildings > tbody > tr[building_id='+self.building.building_id+']').removeClass('selected');
				self.googleMarker.setIcon(self.redImage);
			}
			this.toggle = function(){
				self.selected = !self.selected;
				if(self.selected){
					markers.clearSelected();
					$('#buildings > tbody > tr[building_id='+self.building.building_id+']').addClass('selected');
					self.googleMarker.setIcon(self.blueImage);
					buildingSelected(self.building.building_id);
				}else{
					$('#buildings > tbody > tr[building_id='+self.building.building_id+']').removeClass('selected');
					self.googleMarker.setIcon(self.redImage);
				}
			}
			this.destroy = function(){
    				google.maps.event.clearListeners(self.googleMarker, 'click');
    				self.googleMarker.setMap(null);
    				self.googleMarker = null;
			}
    	}
    
    
    	function initMap(){
	    	var mapOptions = {
	          center: new google.maps.LatLng(43.7, -79.4),
	          zoom: 10,
	          panControl:false,
	          streetViewControl:false,
	          mapTypeControl:true,
	          mapTypeControlOptions: {
			        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
			        position: google.maps.ControlPosition.TOP_LEFT
			    },
	          overviewMapControl:false
	        };
    		
    		//$('#map_wrapper').height($('body').height()-$('.navbar-fixed-top').height()-50);
    		setMapSize();
    		
    		map = new google.maps.Map($('#map_wrapper')[0],mapOptions);
    		
    		layers.go = new google.maps.KmlLayer('http://isystemsnow.com/layers/go.kmz',{preserveViewport: true});
			layers.ttc = new google.maps.KmlLayer('http://isystemsnow.com/layers/ttc.kmz',{preserveViewport: true});
			layers.viva = new google.maps.KmlLayer('http://isystemsnow.com/layers/viva.kmz',{preserveViewport: true});
			
    		  // Create the DIV to hold the control and call the HomeControl() constructor
			  // passing in this DIV.
		  	var homeControlDiv = document.createElement('div');
		  	var homeControl = new HomeControl(homeControlDiv, map);
		
		  	homeControlDiv.index = 1;
		  	map.controls[google.maps.ControlPosition.RIGHT_TOP].push(homeControlDiv);
    		
			//var layerGo = new google.maps.KmlLayer('http://isystemsnow.com/layers/ttc.kmz');
			//layerGo.setMap(map);
    		
    		google.maps.event.addListener(map, 'tilesloaded', function() {
    			google.maps.event.clearListeners(map, 'tilesloaded');
    			initDataTable();
    			
				$('.title-collapse-wrapper').click(function(){
					if($('.map-collapse-content').css('display')=='none'){  //currently empty
		        		$('.title-collapse-wrapper > i.icon-plus-sign').removeClass('icon-plus-sign').addClass('icon-minus-sign');
		        	}else{  // currently shown
		        		$('.title-collapse-wrapper > i.icon-minus-sign').removeClass('icon-minus-sign').addClass('icon-plus-sign');
		        	}
		        	$('.map-collapse-content').slideToggle('medium',function(){
	
		        	});
				});
	        });
	        google.maps.event.addListener(map, 'idle', function() {  
	        	if(typeof(datatable)!='undefined')
	        	{
        			if(!markers.blockIdleEvent){
        				markers.constrainGPS = true;
        				$('#constrain_gps').prop('checked',true);
						datatable.api().ajax.reload();
        			}else{
        				markers.blockIdleEvent = false;
    				}
    			}
	        });
    		markers = new Markers();
    	}
    
    	google.maps.event.addDomListener(window, 'load', initMap);
    
	    $('#buildings').on('draw.dt',function(event,datatable){
	    		//if($('#building_slideup_wrapper').html()!='')
	    		//{
	    		
	    		//}
	    		$('#building_slideup_wrapper').empty();
				setMapSize();
				setMapTableSize();
	    		markers.clearMarkers();
		    	if(datatable.json.data instanceof Array)
		    	{
		    		for(var i=0; i< datatable.json.data.length; i++){
		    			markers.addMarker(datatable.json.data[i]);
		    		}
		    	}
		    	markers.verifyBounds();
    	});
    
    
    	
    
    
    
    
    	
    	
		
		
		
		var datatable 
		function initDataTable(){
			//return;
			//$('.main-content').animate({scrollTop:$(document).height()}, 'fast');
			
			//var calc_datatable_scroll_height = $('body').height()-$('.navbar-fixed-top').height()-$('#search_controls').height()-$('#table_controls').height()+$('#buildings_wrapper div.dataTables_scrollBody').height()-48;

        	//setMapSize();
			//$('#map_wrapper').height()
    		//search_controls
			
			datatable = $('#buildings').dataTable({
					"scrollX": true,
					"scrollY":        0+ "px",
			        "processing": true,
			        "serverSide": true,
			        "iDisplayLength": 50,
			        "dom":"ltipr",
			        "ajax": {
			        	"url":"/buildings/getajax",
		        		"data":function(d){
		        			d.address_search = $("#search_address").val();
		        			d.contact_search = $("#search_contact").val();
		        			d.company_search = $("#search_company").val();
		        			d.unitQuantityMin = unitsMin==0?null:unitsMin;
		        			d.unitQuantityMax = unitsMax==sliderLimit?null:unitsMax;
							d.saleDateRangeStart = $('#start_time').val()==''?null:typeof($('#start_time_gen').data('datetimepicker'))=='undefined'?null:$('#start_time_gen').data('datetimepicker').getLocalDate().toUTCString();	        			
        					d.saleDateRangeEnd =$('#end_time').val()==''?null: typeof($('#end_time_gen').data('datetimepicker'))=='undefined'?null:$('#end_time_gen').data('datetimepicker').getLocalDate().toUTCString();

		        			//d.length = $('#result_size').val();
		        			if(markers.constrainGPS)
		        			{
			        			d.boundsLatitudeMin = map.getBounds().getSouthWest().lat();
			        			d.boundsLatitudeMax = map.getBounds().getNorthEast().lat();
			        			d.boundsLongitudeMin = map.getBounds().getSouthWest().lng();
			        			d.boundsLongitudeMax = map.getBounds().getNorthEast().lng();
		        			}else{
			        			d.boundsLatitudeMin = null;
			        			d.boundsLatitudeMax = null;
			        			d.boundsLongitudeMin = null;
			        			d.boundsLongitudeMax = null;
		        			}
		        		},
		        		error: function(xhr, error, thrown){
		        			
		        		}
		        		
		        	},
			        "aoColumns":[
			        	{"mData":"building_id","visible":false}
			         	,{"mData":function(data,b){ 
				        	return "<b>"+buildAddressString(data)+"</b>"; }
				        }
				        ,{"mData":"units"}
				        ,{"mData":"owner"}
				        ,{"mData":"property_mgmt_company"}
				        ,{"mData":function(data,b){ 
				        	return "<b>"+toDateTimeString(data.sale_date)+"</b>"; }
				        	}
			        ],
			        "rowCallback": function( row, data, displayIndex ) {
						$(row).attr('building_id',data['building_id']);
						$(row).click(function(){
							markers.toggle(parseInt($(row).attr('building_id')));
	    					//building.fetch({id:parseInt($(row).attr('building_id'))});
	               		});
		               
			        }
		    });
		    $('#buildings_length select').attr('id','building_length_select');
		    
		    $('#result_size_wrapper').append($('#building_length_select'));
		    $('#buildings_length').remove();
		    //datatable.api().fnLengthChange($('#result_size').val());
		    
        
	        $('#buildings tbody').on('click', 'tr', function () {
	       // 	$(this).siblings().removeClass('selected');
	       // 	$(this).removeClass('selected').addClass('selected');
		    });
		    
			//$('#constrain_gps').click(function(){
				
			//});
	    }
	    
	    
	    function HomeControl(controlDiv, map) {
		
			  // Set CSS styles for the DIV containing the control
			  // Setting padding to 5 px will offset the control
			  // from the edge of the map.
			  controlDiv.style.padding = '5px';
			
			  // Set CSS for the control border.
			  var controlUI = document.createElement('div');
			  controlUI.id = 'map_control';
			  controlUI.className="map-overlay-controls";
			  controlDiv.appendChild(controlUI);
			  
			  var titlecollapsewrapper = document.createElement('div');
			  titlecollapsewrapper.className = 'title-collapse-wrapper';
			  controlUI.appendChild(titlecollapsewrapper);
			  
			  var collapseicon = document.createElement('i');
			  collapseicon.className = 'icon-plus-sign';
			  titlecollapsewrapper.appendChild(collapseicon);
			  
			  var mapcontrolstitlediv = document.createElement('div');
			  mapcontrolstitlediv.className = 'map-overlay-title-label';
			  mapcontrolstitlediv.innerHTML = 'Map Controls';
			  titlecollapsewrapper.appendChild(mapcontrolstitlediv);
			  
			  
			  
			  var collapsecontent = document.createElement('div');
			  collapsecontent.className = 'map-collapse-content';
			  collapsecontent.style.display='none';
			  controlUI.appendChild(collapsecontent);
			  
			  // Set CSS for the control interior.
			  var constrainLabel = document.createElement('label');
			  constrainLabel.htmlFor  = 'constrain_gps';
			  constrainLabel.className= 'map-overlay-label';
			  constrainLabel.innerHTML = 'Constrain result to map bounds';
			  
			  // Set CSS for the control interior.
			  var constrainGPSCheckbox = document.createElement('input');
			  constrainGPSCheckbox.id = 'constrain_gps'
			  constrainGPSCheckbox.type = 'checkbox';
			  constrainGPSCheckbox.className = 'map-overlay-checkbox';
			  var condiv = document.createElement('div');
			  condiv.className = 'map-control-row-wrapper';
			  condiv.appendChild(constrainGPSCheckbox);
			  condiv.appendChild(constrainLabel);
			  collapsecontent.appendChild(condiv);
			  
			  
			  
			  // Set CSS for the control interior.
			  var layerGo = document.createElement('label');
			  layerGo.htmlFor  = 'layer_go';
			  layerGo.className= 'map-overlay-label';
			  layerGo.innerHTML = 'Go Transit';
			  // Set CSS for the control interior.
			  var inputGo = document.createElement('input');
			  inputGo.id = 'layer_go'
			  inputGo.type = 'checkbox';
			  inputGo.className = 'map-overlay-checkbox';
			  
			  var godiv = document.createElement('div');
			  godiv.className = 'map-control-row-wrapper';
			  godiv.appendChild(inputGo);
			  godiv.appendChild(layerGo);
			  collapsecontent.appendChild(godiv);
			  
			  
			  
			  // Set CSS for the control interior.
			  var layerTTC = document.createElement('label');
			  layerTTC.htmlFor  = 'layer_ttc';
			  layerTTC.className= 'map-overlay-label';
			  layerTTC.innerHTML = 'TTC';
			  
			  // Set CSS for the control interior.
			  var inputTTC = document.createElement('input');
			  inputTTC.id = 'layer_ttc'
			  inputTTC.type = 'checkbox';
			  inputTTC.className = 'map-overlay-checkbox';
			  
			  var ttcdiv = document.createElement('div');
			  ttcdiv.className = 'map-control-row-wrapper';
			  ttcdiv.appendChild(inputTTC);
			  ttcdiv.appendChild(layerTTC);
			  collapsecontent.appendChild(ttcdiv);
			  
			  
			   // Set CSS for the control interior.
			  var layerViva = document.createElement('label');
			  layerViva.htmlFor  = 'layer_viva';
			  layerViva.className= 'map-overlay-label';
			  layerViva.innerHTML = 'VIVA';
			  
			  // Set CSS for the control interior.
			  var inputViva = document.createElement('input');
			  inputViva.id = 'layer_viva'
			  inputViva.type = 'checkbox';
			  inputViva.className = 'map-overlay-checkbox';
			  
			  var vivadiv = document.createElement('div');
			  vivadiv.className = 'map-control-row-wrapper';
			  vivadiv.appendChild(inputViva);
			  vivadiv.appendChild(layerViva);
			  collapsecontent.appendChild(vivadiv);
			  
			  
			  var resultSizeLabel = document.createElement('label');
			  resultSizeLabel.htmlFor  = 'building_length_select';
			  resultSizeLabel.className= 'map-overlay-label map-overlay-results-label';
			  resultSizeLabel.innerHTML = 'Result Size:';
			  
			  var resultsizediv = document.createElement('div');
			  resultsizediv.className = 'map-control-row-wrapper';
			  resultsizediv.id = 'result_size_wrapper';
			  resultsizediv.appendChild(resultSizeLabel);
			  collapsecontent.appendChild(resultsizediv);
			  			
			  
			google.maps.event.addDomListener(inputGo, 'change', function() {
				if(layers.go.getMap()==null){
					layers.go.setMap(map);
				}else{
					layers.go.setMap(null);
				}
			});
			google.maps.event.addDomListener(inputTTC, 'change', function() {
				if(layers.ttc.getMap()==null){
					layers.ttc.setMap(map);
				}else{
					layers.ttc.setMap(null);
				}
			});
			google.maps.event.addDomListener(inputViva, 'change', function() {
				if(layers.viva.getMap()==null){
					layers.viva.setMap(map);
				}else{
					layers.viva.setMap(null);
				}
			});
			google.maps.event.addDomListener(constrainGPSCheckbox, 'click', function() {
				markers.constrainGPS = $('#constrain_gps').is(':checked');
				if(markers.constrainGPS&&!markers.checkMarkersBounded()) //markers aren't bounded correct.
				{
					datatable.api().ajax.reload();
				}else if(!markers.constrainGPS){  // this is the case where maybe you've typed in new search terms.
					datatable.api().ajax.reload();
				}
			});
		}

		$('#search_address').keydown(function(){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		$('#search_contact').keydown(function(){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		$('#search_company').keydown(function(){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		
    	$('#units_slider').attr('data-slider-max',sliderLimit); // corrects limit
		$('#units_slider').slider({tooltip: 'disabled'});
		$('#units_slider').on('slide',function(slideEvt){
			unitsMin = slideEvt.value[0];
			unitsMax = slideEvt.value[1]
			$('#units_min').html(unitsMin);
			
			if(unitsMax==sliderLimit)
			{
				$('#units_max').html(unitsMax+'+');
			}else{
				$('#units_max').html(unitsMax);
			}
		});
		$('#units_slider').on('slideStop',function(slideEvt){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
        $(window).resize(function(){
        	if(typeof(markers)!='undefined'&&$('#building_slideup_wrapper').html()!=''){
				markers.blockIdleEvent = true;
				google.maps.event.trigger(map, "resize");
			}
        	setMapSize();
			setMapTableSize();
			
			snapClose();
			
        });
        
        $(window).scroll(function(){
        	if($(window).scrollTop()>($('#map_wrapper').height()+$('#building_slideup_wrapper').height())/2){
        		$('#search_toggler').attr('scrollstate','bottom');
			}else{
				$('#search_toggler').attr('scrollstate','top');
			}
        });
        
        $('.main-content').scroll(function(){
        	if($('.main-content').scrollTop()>($('#map_wrapper').height()+$('#building_slideup_wrapper').height())/2){
        		$('#search_toggler').attr('scrollstate','bottom');
			}else{
				$('#search_toggler').attr('scrollstate','top');
			}
    	});
        
        function snapFar(){
        	if($('body').width()>979){
    			if($('.main-content').scrollTop()>($('#map_wrapper').height()+$('#building_slideup_wrapper').height())/2){
    				//$('.main-content').scrollTop(0)
    				$('.main-content').animate({scrollTop:0}, 'fast');
    			}else{
    				//$('.main-content').scrollTop($('#map_wrapper').height()+$('#building_slideup_wrapper').height());
    				$('.main-content').animate({scrollTop:$('#map_wrapper').height()+$('#building_slideup_wrapper').height()}, 'fast');
    			}
    		}else{
    			if($(window).scrollTop()>($('#map_wrapper').height()+$('#building_slideup_wrapper').height())/2){
    				//$('body').scrollTop(0);
    				$('body,html').animate({scrollTop:0}, 'fast');
    			}else{
    				//$('body').scrollTop($('#map_wrapper').height()+$('#building_slideup_wrapper').height()+$('.navbar-fixed-top').height());
    				$('body,html').animate({scrollTop:$('#map_wrapper').height()+$('#building_slideup_wrapper').height()+$('.navbar-fixed-top').height()},'fast');
    			}
    		}
        }
        
        function snapClose(){
        	return;
        	if($('body').width()>979){
    			if($('.main-content').scrollTop()<($('#map_wrapper').height()+$('#building_slideup_wrapper').height())/2){
    				$('#search_toggler').attr('scrollstate','top');
					$('.main-content').animate({scrollTop:0}, 'fast');
    				//$('.main-content').scrollTop(0);
    			}else{
    				$('#search_toggler').attr('scrollstate','bottom');
    				$('.main-content').animate({scrollTop:$('#map_wrapper').height()+$('#building_slideup_wrapper').height()}, 'fast');
    				//$('.main-content').scrollTop($('#map_wrapper').height()+$('#building_slideup_wrapper').height());
    			}
    		}else{
    			if($('body').scrollTop()<($('#map_wrapper').height()+$('#building_slideup_wrapper').height())/2){
    				$('#search_toggler').attr('scrollstate','top');
    				//$('body').scrollTop(0);
    				$('body').animate({scrollTop:0}, 'fast');
    			}else{
    				$('#search_toggler').attr('scrollstate','bottom');
    				//$('body').scrollTop($('#map_wrapper').height()+$('#building_slideup_wrapper').height()+$('.navbar-fixed-top').height());    				
    				$('body').animate({scrollTop:$('#map_wrapper').height()+$('#building_slideup_wrapper').height()+$('.navbar-fixed-top').height()}, 'fast');
    			}
    		}        
        }
        
        function setMapTableSize(){
			var h = $('body').height()-$('#search_controls').height()-$('#table_controls').height()+$('#buildings_wrapper div.dataTables_scrollBody').height();
			if($('body').width()>979){
				h = h - $('.navbar-fixed-top').height();
			}
			if($('#buildings_wrapper div.dataTables_scrollBody').height()<1){
				setTimeout(function(){
					setMapTableSize();
				},100);
			}
			$('#buildings_wrapper div.dataTables_scrollBody').height(h>=minimumTableSize?h+1:minimumTableSize+'px');
        }
        
        function setMapSize(){
        	//if(typeof(markers)!='undefined'){
			//	markers.blockIdleEvent = true;
			//	google.maps.event.trigger(map, "resize");
			//	markers.blockIdleEvent = false;
			//}
			var mapheightval = $('body').height()-$('#building_slideup_wrapper').height()-$('.navbar-fixed-top').height()-50;
			$('#map_wrapper').height(mapheightval);

			
			
        }
	    
	    
        $("#start_time_gen" ).datetimepicker({
            language: 'en',
            format: 'yyyy-MM-dd hh:mm',
            pick12HourFormat: false,
            pickSeconds: false
        }).data('datetimepicker');

        $("#end_time_gen" ).datetimepicker({
            language: 'en',
            format: 'yyyy-MM-dd hh:mm',
            pick12HourFormat: false,
            pickSeconds: false
        }).data('datetimepicker');
        
        
		$("#start_time_gen" ).data('datetimepicker').$element.on('changeDate',function(e,y){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		$("#end_time_gen" ).data('datetimepicker').$element.on('changeDate',function(e,y){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
        
        
        
        
        function rebindDateTimePickerCloser(){
	        $('.bootstrap-datetimepicker-widget > div > div.close-datetime').unbind();
	        $('.bootstrap-datetimepicker-widget > div > div.close-datetime').click(function(){
	            $("#end_time_gen" ).data('datetimepicker').hide();
	            $("#start_time_gen" ).data('datetimepicker').hide();
	        });
        }
        rebindDateTimePickerCloser();
        
    	
    	
        
    });
</script>

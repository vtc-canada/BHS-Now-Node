<%
    var translate = {
        'en' : {
            'Users Administration':'Users Administration',
            'Users':'Users',
            'Save':'Save',
            'New User':'New User',
            'Changes Pending.':'Changes Pending.',
            'Username':'Username',
            'Security Level':'Security Level',
            'Save Dialog':'Save Dialog',
            'Cancel':'Cancel',
            'Confirm':'Confirm',
            'Change Password':'Change Password',
            'New Password':'New Password',
            'Confirm Password':'Confirm Password',
            'Set':'Set',
            'To create a new user, fill out the account information and select a security level.':'To create a new user, fill out the account information and select a security level.',
            'Account Information':'Account Information',
            'Password':'Password',
            'Password fields do not match.':'Password fields do not match.',
            'The username':'The username',
            'Please enter a value for Username.':'Please enter a value for Username.',
            'is already in use.':'is already in use.',
            'Password must be at least 1 character long.':'Password must be at least 1 character long.',
            'You are about to delete the following user(s)':'You are about to delete the following user(s)',
            'All messages associated with the user(s) will be deleted.':'All messages associated with the user(s) will be deleted.',
            'Are you sure you would like to make these changes?':'Are you sure you would like to make these changes?',
            'Operator':'Operator',
            'Admin':'Admin',
            'Manager':'Manager',
            'View Only':'View Only',
            'Delete':'Delete',
            'Please enter a new password for':'Please enter a new password for' ,
            'Group':'Group',
            'Username already Taken':'Username already Taken',
            'Error':'Error'
        },
        'es' : {
            'Users Administration':'Users Administration',
            'Users':'Users',
            'Save':'Save',
            'New User':'New User',
            'Changes Pending.':'Changes Pending.',
            'Username':'Username',
            'Security Level':'Security Level',
            'Save Dialog':'Save Dialog',
            'Cancel':'Cancel',
            'Confirm':'Confirm',
            'Change Password':'Change Password',
            'New Password':'New Password',
            'Confirm Password':'Confirm Password',
            'Set':'Set',
            'To create a new user, fill out the account information and select a security level.':'To create a new user, fill out the account information and select a security level.',
            'Account Information':'Account Information',
            'Password':'Password',
            'Password fields do not match.':'Password fields do not match.',
            'The username':'The username',
            'Please enter a value for Username.':'Please enter a value for Username.',
            'is already in use.':'is already in use.',
            'Password must be at least 1 character long.':'Password must be at least 1 character long.',
            'You are about to delete the following user(s)':'You are about to delete the following user(s)',
            'All messages associated with the user(s) will be deleted.':'All messages associated with the user(s) will be deleted.',
            'Are you sure you would like to make these changes?':'Are you sure you would like to make these changes?',
            'Operator':'Operator',
            'Admin':'Admin',
            'Manager':'Manager',
            'View Only':'View Only',
            'Delete':'Delete' ,
            'Please enter a new password for':'Please enter a new password for'  ,
            'Group':'Group'               ,
            'Username already Taken':'Username already Taken',
            'Error':'Error'
        }
    }
%>

<div class="row-fluid page-banner">
    <div class="banner-div"><i class="icon-group icon-1x banner-icon-top"></i><div class="banner-div-text"><%= translate[locale]['Users Administration'] %></div></div>
</div>

 <!-- The Main page Users Section -->
<div class="row-fluid" style="margin-top:20px;">
    <div class="span4 offset1 page-controls-wrapper">
        <div class="row-fluid" id="reportheader"><span style="padding-left:10px;"><%= translate[locale]['Users'] %></span>

            <div style="margin-right:10px;font-weight: 400;" class="btn btn-primary pull-right save_pull" id="add_user"><%= translate[locale]['New User'] %></div>
        </div>
        <div class="row-fluid" id="iframediv">
            <div class="row-fluid">
                <div class="adminusersheader">
                    <div class="row-fluid rowflu">
                        <!--<div class="span1 offset1">ID</div>-->
                        <div class="span4 offset1"><%= translate[locale]['Username'] %></div>
                        <div style="" class="span2"><%= translate[locale]['Security Level'] %></div>
                        <div class="span3"></div>
                        <div class="span2"></div>
                    </div>
                </div>
                <div id="adminusers">
                	<div class="row-fluid  odd" userid="1">
				        <!--<div class="span1 offset1"><span class="mobilelabel">ID:</span> 1</div>-->
				        <div class="span4 offset1"><span class="mobilelabel">Username:</span> admin</div>
				        <div class="span7"></div>
				    </div>
                </div>
                <div id="adminusers">
                	<div class="row-fluid  even" userid="1">
				        <!--<div class="span1 offset1"><span class="mobilelabel">ID:</span> 1</div>-->
				        <div class="span4 offset1"><span class="mobilelabel">Username:</span> admin</div>
				        <div class="span7"></div>
				    </div>
                </div>

            </div>
        </div>
    </div>
    
    <div class="span6 offset0 page-controls-wrapper">
        <div class="row-fluid" id="reportheader"><span style="padding-left:10px;"><%= translate[locale]['Users'] %></span>

            <div style="margin-right:10px;font-weight: 400;" class="btn btn-primary pull-right save_pull" id="save_users"><%= translate[locale]['Save'] %></div>

            <div style="margin-right:10px;font-weight: 400;" class="btn btn-primary pull-right save_pull" id="add_user"><%= translate[locale]['New User'] %></div>
            <div style="margin-right:10px; color:#990000; font-weight: 400; display:none;" class="pull-right save_pull" id="changes_pending">Changes Pending. &nbsp</div>
        </div>
        <div class="row-fluid" id="iframediv">
            <div class="row-fluid">
                <div class="adminusersheader">
                    <div class="row-fluid rowflu">
                        <!--<div class="span1 offset1">ID</div>-->
                        <div class="span4 offset1"><%= translate[locale]['Username'] %></div>
                        <div style="" class="span2"><%= translate[locale]['Security Level'] %></div>
                        <div class="span3"></div>
                        <div class="span2"></div>
                    </div>
                </div>
                <div id="adminusers"></div>

            </div>
        </div>
    </div>
    

    <!-- Modal - confirms you want to continue to delete users and complete other changes -->
    <div id="saveModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="myModalLabelsave"><%= translate[locale]['Save Dialog'] %></h3>
        </div>
        <div class="modal-body">
            <p>One fine body…</p>
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true"><%= translate[locale]['Cancel'] %></button>
            <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true" id="confirmdeletes"><%= translate[locale]['Confirm'] %></button>
        </div>
    </div>


    <!-- Modal  for changing password-->
    <div id="changeModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="myModalLabelChange"><%= translate[locale]['Change Password'] %></h3>
        </div>
        <div class="modal-body">
            <div class="row-fluid"><p id="newpasswordprompt"></p></div>
            <div class="row-fluid"><label class="change-label" for="newpassword"><%= translate[locale]['New Password'] %>:</label><input class="change-input" id="newpassword" type="password"></div>
            <div class="row-fluid"><label class="change-label" for="confirmpassword"><%= translate[locale]['Confirm Password'] %>:</label><input class="change-input"  id="confirmpassword" type="password"> </div>
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true"><%= translate[locale]['Cancel'] %></button>
            <button class="btn btn-primary" id="confirmchange"><%= translate[locale]['Set'] %></button>
        </div>
    </div>

    <!-- Modal  for creating new user -->
    <div id="addUserModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="myModalLabelAdd">New User</h3>
        </div>
        <div class="modal-body">
            <div class="row-fluid"><p><%= translate[locale]['To create a new user, fill out the account information and select a security level.'] %></p></div>
            <h4><%= translate[locale]['Account Information'] %></h4>
            <div class="row-fluid"><label class="change-label" for="addnewusername"><%= translate[locale]['Username'] %>:</label><input class="change-input" id="addnewusername" type="text"></div>

            <div class="row-fluid"><label class="change-label" for="newpassword"><%= translate[locale]['Password'] %>:</label><input class="change-input" id="addnewpassword" type="password"></div>
            <div class="row-fluid"><label class="change-label" for="confirmpassword"><%= translate[locale]['Confirm Password'] %>:</label><input class="change-input"  id="addconfirmpassword" type="password"> </div>
            <h4><%= translate[locale]['Security Level'] %></h4>
            <div class="row-fluid"><label class="change-label" for="newsecuritylevel"><%= translate[locale]['Group'] %>:</label>
                <select class="securityselect security-select-new change-input" style="margin-top:0px; height:30px;" id="newsecuritylevel">
                    <option value="admin"><%= translate[locale]['Admin'] %></option>
                    <option value="manager"><%= translate[locale]['Manager'] %></option>
                    <option value="operator" selected="selected"><%= translate[locale]['Operator'] %></option>
                    <option value="viewonly"><%= translate[locale]['View Only'] %></option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true"><%= translate[locale]['Cancel'] %></button>
            <button class="btn btn-primary" id="confirmadduser"><%= translate[locale]['Set'] %></button>
        </div>
    </div>

</div>



<!-- Admin Users Template - -->
<script type="text/template" id="adminuserlist-template">
    <div class="row-fluid {{ if(typeof(dodelete)!='undefined'){ }}user-delete{{ } }}" userid="{{= id}}">
        <!--<div class="span1 offset1"><span class="mobilelabel">ID:</span> {{= id }}</div>-->
        <div class="span4 offset1"><span class="mobilelabel"><%= translate[locale]['Username'] %>:</span> {{= username }}</div>
        <div class="span2"><span class="mobilelabel"><%= translate[locale]['Security Level'] %>:</span>
            <select class="securityselect">
                <option value="admin"{{ if(admin){ }} selected="selected"{{ } }}><%= translate[locale]['Admin'] %></option>
                <option value="manager"{{ if(manager){ }} selected="selected"{{ } }}><%= translate[locale]['Manager'] %></option>
                <option value="operator"{{ if(operator){ }} selected="selected"{{ } }}><%= translate[locale]['Operator'] %></option>
                <option value="viewonly"{{ if(viewonly){ }} selected="selected"{{ } }}><%= translate[locale]['View Only'] %></option>
            </select>
        </div>
        <div class="span3 user-changepassword-span"><div class="pull-right change-password btn btn-primary"><%= translate[locale]['Change Password'] %>{{ if(typeof(dopassword)!='undefined'){ }} <i class="icon-time"></i>{{ } }}</div></div>
        <div class="span2 user-delete-span"><div class="pull-right deleteadminuser btn {{ if(typeof(dodelete)!='undefined'){ }}btn-success{{ }else{ }}btn-danger{{ } }}">{{ if(typeof(dodelete)!='undefined'){ }}<%= translate[locale]['Cancel'] %>{{ }else{ }}<%= translate[locale]['Delete'] %>{{ } }}</div></div>
    </div>
</script>

<script>
var translate = {
    'en':{
        'Success':'Success',
        'SuccessMessage':'Changes have been saved.'
    },
    'es':{
        'Success':'Success',
        'SuccessMessage':'Changes have been saved.'
    }
}
$(document).ready(function(){

    
    // this object keeps track of the number of successful changes that happen out of all the changes
    // this is iteratively updated as the .save() function is called on each of the models in the collection
    // it displays a success message if it completes all the required saves
    /*saveObj = {
        changetotal:0,
        changecount:0,
        addcount:function(){
            this.changecount++;
            if(this.changecount>=this.changetotal){
                $('.alert-success').remove();
                $('.page-banner').after('<div class="alert alert-success fade in" style="border-radius:0px;">'+
                        '<button type="button" class="close" data-dismiss="alert">×</button>'+
                        '<strong>'+translate['<%= locale %>']['Success']+':&nbsp</strong>'+translate['<%= locale %>']['SuccessMessage']+'</div>');
                setTimeout(function(){
                    setTimeout(function(){
                        $('.alert-success').remove();
                    },500);
                    $('.alert-success').removeClass('in');
                },alert_fadeout_time);
            }
        }
    }*/

    // save password change event is attached to the button
    // it sets the dopassword and dosync flags on the model
    $('#confirmchange').click(function(event){
    /*
        $('#changeModal div.alert-error').remove();
        if($('#newpassword').val()!=$('#confirmpassword').val()){
            $('#changeModal div.modal-header').after(
                    '<div class="alert alert-error fade in" style="margin-bottom:0px;" style="border-radius:0px;"><button type="button" class="close" data-dismiss="alert">×</button><strong><%= translate[locale]['Error'] %>:&nbsp;</strong><%= translate[locale]['Password fields do not match.'] %></div>');
        }else if($('#newpassword').val()==''){
            $('#changeModal div.modal-header').after(
                    '<div class="alert alert-error fade in" style="margin-bottom:0px;" style="border-radius:0px;"><button type="button" class="close" data-dismiss="alert">×</button><strong><%= translate[locale]['Error'] %>:&nbsp;</strong><%= translate[locale]['Password must be at least 1 character long.'] %></div>');
        }else{
            socket.request('/admin/createhash',{password:$('#newpassword').val()},function(data){
                if(typeof(data.error)!='undefined'){
                    location.reload(); // Will boot back to login screen
                    return;
                }
                var newidtemp = '';
                var idstring = $(event.currentTarget).parent().parent().attr('userid');
                if(idstring=='new'){
                    newidtemp = $(event.currentTarget).parent().parent().attr('newid');
                    adminusers.findWhere({newid:parseInt(newidtemp)}).set({password:data.hash,dosync:1,dopassword:1});
                    $('#adminusers > div[userid='+idstring+'] div.user-changepassword-span div.change-password').html('<%= translate[locale]['Change Password'] %> <i class="icon-time"></i>');
                }else{
                    adminusers.get(idstring).set({password:data.hash,dosync:1,dopassword:1});
                    $('#adminusers > div[userid='+idstring+'] div.user-changepassword-span div.change-password').html('<%= translate[locale]['Change Password'] %> <i class="icon-time"></i>');
                }
                $('#changeModal').modal('hide');
                setChangesPending();
            });
        }*/
    });

    // binds saveChanges function to Deletes confirmation dialog.
    $('#confirmdeletes').click(function(event){
    //    saveChanges();
    });


    

     // pops the add new user dialog.
    $('#add_user').click(function(event){
        //$('#addnewusername').val('');
        //$('#newsecuritylevel').val('operator');
        //$('#addnewpassword').val('');
        //$('#addconfirmpassword').val('');
        ////$('#addUserModal div.modal-body .error-message').html('');
        //$('#addUserModal div.alert-error').remove();
        //$('#addUserModal').modal('show');

    });

    // this makes sure the new user has a propper username and password.
    // it adds it to the collection if it's successful.
    $('#confirmadduser').click(function(event){
        /*$('#addUserModal div.alert-error').remove();

        if($('#addnewusername').val()==''){
            $('#addUserModal div.modal-header').after(
                    '<div class="alert alert-error fade in" style="margin-bottom:0px;" style="border-radius:0px;"><button type="button" class="close" data-dismiss="alert">×</button><strong><%= translate[locale]['Error'] %>:&nbsp;</strong><%= translate[locale]['Please enter a value for Username.'] %></div>');
            return;
        }

        socket.request('/admin/checkusername',{username:$('#addnewusername').val()},function(data){
            if(typeof(data.error)!='undefined'){
                location.reload(); // Will boot back to login screen
                return;
            }
            if(typeof(data.taken)!='undefined'){ //if username was already taken
                $('#addUserModal div.modal-header').after(
                        '<div class="alert alert-error fade in" style="margin-bottom:0px;" style="border-radius:0px;"><button type="button" class="close" data-dismiss="alert">×</button><strong><%= translate[locale]['Error'] %>:&nbsp;</strong><%= translate[locale]['The username'] %> <b>'+$('#addnewusername').val()+'</b> <%= translate[locale]['is already in use.'] %></div>');
                return;
            }
            if(typeof(adminusers.findWhere({username:$('#addnewusername').val()}))!='undefined'){
                $('#addUserModal div.modal-header').after(
                        '<div class="alert alert-error fade in" style="margin-bottom:0px;" style="border-radius:0px;"><button type="button" class="close" data-dismiss="alert">×</button><strong><%= translate[locale]['Error'] %>:&nbsp;</strong><%= translate[locale]['The username'] %> <b>'+$('#addnewusername').val()+'</b> <%= translate[locale]['is already in use.'] %></div>');
                return;
            }
            if($('#addnewpassword').val()!=$('#addconfirmpassword').val()){
                $('#addUserModal div.modal-header').after(
                        '<div class="alert alert-error fade in" style="margin-bottom:0px;" style="border-radius:0px;"><button type="button" class="close" data-dismiss="alert">×</button><strong>:&nbsp;</strong><%= translate[locale]['Password fields do not match.'] %></div>');
                return;
            }
            if($('#addnewpassword').val()==''){
                $('#addUserModal div.modal-header').after(
                        '<div class="alert alert-error fade in" style="margin-bottom:0px;" style="border-radius:0px;"><button type="button" class="close" data-dismiss="alert">×</button><strong><%= translate[locale]['Error'] %>:&nbsp;</strong><%= translate[locale]['Password must be at least 1 character long.'] %></div>');
                return;
            }

            socket.request('/admin/createhash',{password:$('#addnewpassword').val()},function(data){
                if(typeof(data.error)!='undefined'){
                    location.reload(); // Will boot back to login screen
                    return;
                }
                if($('#newsecuritylevel').val()=='admin'){
                    adminusers.add({username:$('#addnewusername').val(),dosync:1, newid:Math.floor(Math.random()*65535),password:data.hash,admin:1,manager:0,operator:0,viewonly:0});
                }else if($('#newsecuritylevel').val()=='manager'){
                    adminusers.add({username:$('#addnewusername').val(),dosync:1, newid:Math.floor(Math.random()*65535),password:data.hash,admin:0,manager:1,operator:0,viewonly:0});
                }else if($('#newsecuritylevel').val()=='operator'){
                    adminusers.add({username:$('#addnewusername').val(),dosync:1, newid:Math.floor(Math.random()*65535),password:data.hash,admin:0,manager:0,operator:1,viewonly:0});
                }else if($('#newsecuritylevel').val()=='viewonly'){
                    adminusers.add({username:$('#addnewusername').val(),dosync:1, newid:Math.floor(Math.random()*65535),password:data.hash,admin:0,manager:0,operator:0,viewonly:1});
                }
                $('#addUserModal').modal('hide');
                adminusersView.render();
            });


        });
		*/
    });


    // this initial click on save users sets up the saveObj to track all the successes it will need.
    // it pops the delete modal confirmation if we're wanting to delete users.
    $('#save_users').click(function(event){
/*
        var changecount = 0;
        var deleteusersstring = '';
        $.each(adminusers.models,function(key,model){
            if(typeof(model.get('dodelete'))!='undefined'||typeof(model.get('dosync'))!='undefined'){
                changecount++;
                if(typeof(model.get('dodelete'))!='undefined'){
                     deleteusersstring+=model.get('username')+', ';
                }
            }
        });
        saveObj.changetotal =  changecount;
        saveObj.changecount = 0;


        if(deleteusersstring!=''){
            deleteusersstring = deleteusersstring.substring(0,deleteusersstring.length-2);
            $('#myModalLabelsave').html('Modify User Accounts');
            $('#saveModal > div.modal-body').html('<p><%= translate[locale]['You are about to delete the following user(s)'] %>: <b>'+deleteusersstring+'</b>. <%= translate[locale]['All messages associated with the user(s) will be deleted.'] %></p><p><%= translate[locale]['Are you sure you would like to make these changes?'] %></p>');
            $('#saveModal').modal('show');
        }
        else{
            saveChanges();
        }*/

    });


    // just shows the changes are pending, by scanning through the collection to see if that's the case.
    function setChangesPending(){
        /*var change = false;
        $.each(adminusers.models,function(key,model){
            if(model.isNew()||typeof(model.get('dodelete'))!='undefined'||typeof(model.get('dosync'))!='undefined'){
               change= true;
               return;
            }
        });
        if(change){
            $('#changes_pending').css('display','block');
        }
        else{
            $('#changes_pending').css('display','none');
        }*/
    }




});

</script>

<%
    var translate = {
        'en' : {
            'You do not have sufficient privileges to access':'You do not have sufficient privileges to access',
            'Error':'Error',
            'Buildings':'Buildings',
            'Date':'Date',
            'Equipment':'Equipment',
            'Device':'Device',
            'Alarm Type':'Alarm Type',
            'System Health':'System Health',
            'System Throughput':'System Throughput',
            'Time In System':'Time In System',
            'BHS Overview':'BHS Overview',
            'Time':'Time',
            'Alarms':'Alarms',
            'Daily Reminders':'Daily Reminders',
            'Predictive Mainenance Tasks':'Predictive Mainenance Tasks',
            'DEVICE':'DEVICE',
            'REASON':'REASON',
            'Uptime':'Uptime',
            'Failsafe Rate':'Failsafe Rate',
            'Tracking Rate':'Tracking Rate',
            'Key Performance Indicators':'Key Performance Indicators',
            'Throughput (bph)':'Throughput (bph)',
            'State':'State',
            'Jam Rate':'Jam Rate',
            'ATR Read Rate':'ATR Read Rate',
            'Cancel':'Cancel',
            'Delete':'Delete',
            'To create a new owner':'To create a new owner, select the contact and/or company associated with this building',
            'To create a new sale':'To create a new sale, click create',
            'Create':'Create',
            'Contact':'Contact',
            'Company':'Company'
        },
        'es' : {
            'You do not have sufficient privileges to access':'Usted no tiene suficientes privilegios para acceder a',
            'Error':'Error',
            'Buildings':'Salpicadero',
            'Date':'Date',
            'Equipment':'Equipment',
            'Device':'Device',
            'REASON':'REASON',
            'Alarm Type':'Alarm Type',
            'System Health':'System Health',
            'System Throughput':'System Throughput',
            'Time In System':'Time In System',
            'BHS Overview':'BHS Overview',
            'Time':'Time',
            'Alarms':'Alarms',
            'Daily Reminders':'Daily Reminders',
            'Predictive Mainenance Tasks':'Predictive Mainenance Tasks',
            'DEVICE':'DEVICE',
            'Uptime':'Uptime',
            'Failsafe Rate':'Failsafe Rate',
            'Tracking Rate':'Tracking Rate',
            'Key Performance Indicators':'Key Performance Indicators',
            'Throughput (bph)':'Throughput (bph)',
            'State':'State',
            'Jam Rate':'Jam Rate',
            'ATR Read Rate':'ATR Read Rate',
            'Cancel':'Cancel',
            'Delete':'Delete',
            'To create a new owner':'To create a new owner, select the contact and/or company associated with this building',
            'To create a new sale':'To create a new sale, click create',
            'Create':'Create',
            'Contact':'Contact',
            'Company':'Company'
        }
    }
%>

<div class="row-fluid page-banner">
    <div class="banner-div"><i class="icon-building icon-1x banner-icon-top"></i><div class="banner-div-text"><%= translate[req.session.user.locale]['Buildings'] %></div></div>
</div>

        <!-- Throws in Error messages if they were passed in from the controller -->
<% if(typeof(errormessage)!='undefined'){ %>
<div class="alert alert-error" style="border-radius:0px;">
    <button type="button" class="close" data-dismiss="alert">×</button>
    <strong><%= translate[req.session.user.locale]['Error'] %>:</strong>
    <%= translate[req.session.user.locale][errormessage] %><% if(typeof(errorurl)!='undefined'){ %> <%= errorurl %><% } %>
</div>
<% } %>


<div class="row-fluid create-report-controls-wrapper">
<div class="span10 offset1 report-control-left-label"  style="min-height: 30px;padding-top: 5px; font-size:18px; font-weight:bold;margin-top: 33px;">
	<i class="icon-search icon-2x banner-icon-top" style="margin-top: -12px; margin-right: 10px;"></i><div class="banner-div-text">Search Filters</div>

</div>
</div>

<div class="row-fluid create-report-controls-wrapper">
    <div class="row">
    	<div class="row-fluid">
	        <div class="span8 offset2 create-report-controls" style="padding-top: 20px;">
	           <div class="row-fluid">
	               <div class="row">
	                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_address">Address:</label></div>
	                   <div class="span8 report-control-right-control">
	                       <input type="text" id="search_address" value="">
	                   </div>
	               </div>
	               <div class="row">
	                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_contact">Contact:</label></div>
	                   <div class="span8 report-control-right-control">
	                       <input type="text" id="search_contact" value="">
	                   </div>
	               </div>
	               <div class="row">
	                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_company">Company:</label></div>
	                   <div class="span8 report-control-right-control">
	                       <input type="text" id="search_company" value="">
	                   </div>
	               </div>
	               <div class="row" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="reporttype">Units:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label" ><span id="units_min">0</span></div>
	                   			
	                   			<input id="units_slider" type="text" class="" value="" data-slider-min="0" data-slider-max="250" data-slider-step="5" data-slider-value="[0,250]"/>
	                   			&nbsp&nbsp
	                   			<span id="units_max">250+</span>
	                   		</div>
	                   </div>
	               </div>
	               <div class="row" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="reporttype">Unit Price:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label" ><span id="unit_price_min">0</span></div>
	                   			
	                   			<input id="unit_price_slider" type="text" class="" value="" data-slider-min="0" data-slider-max="250" data-slider-step="5" data-slider-value="[0,250]"/>
	                   			&nbsp&nbsp
	                   			<span id="unit_price_max">250+</span>
	                   		</div>
	                   </div>
	               </div>
	               <div class="row">
	               		<div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;">
	               			<label for="start_time">Sale Date:</label>
	           			</div>
	           			<div class="input-append span3 report-control-right-control" id="start_time_gen">
	           				<input class="" data-format="yyyy-MM-dd" style="width:150px; max-width:70%;" id="start_time" type="text" value="">
	       					<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>
	       				</div>
	           			<div class="input-append span1 report-control-right-control">
	       					<span style="display: inline-block;width: auto;height: 20px;min-width: 16px;padding: 4px 5px;font-size: 14px;font-weight: normal;line-height: 20px;">to</span>
						</div>
	           			<div class="input-append span3 report-control-right-control" id="end_time_gen">
	           				<input class="" data-format="yyyy-MM-dd" style="width:150px; max-width:70%;" id="end_time" type="text" value="">
	   						<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>
	       				</div>
	       				
	   				</div>
	   			</div>
	   		</div>
   		</div>
   	</div>
 </div>
 <div class="row-fluid">
    <div class="row-fluid span10 offset1 report-control-left-label" style="padding-top: 20px;">
   		<a id="advanced_criteria_toggler" data-toggle="collapse" data-target="#collapseadvanced" style="text-decoration: none; color: #5a6573;">
			<div style="float:left;"></i><i class="icon-plus-sign icon-2x"></i></div><div style="float: left; padding-bottom: 20px;margin-top: -6px;margin-left: 20px;"><h4>Advanced Criteria</h4></div>
		</a>
  	</div>
 </div>
 <div class="row-fluid create-report-controls-wrapper">
    <div class="row">
       <div class="row-fluid">
         <div class="span8 offset2 create-report-controls" style="padding-top: 20px;">
           <div class="row-fluid">
               <div class="row collapse" id="collapseadvanced">
               		
               		
               		<div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label>Building Type:</label></div>
	        			<div class="span8 report-control-right-control" style="margin-bottom:10px;">
							<% for(var i=0;i<building_types.length;i++){ %>
							<div class="row-fluid" style="margin-top: 5px;"><input type="checkbox" class="segment-form-radio building-type-checkboxes" name="building-type-radio" building_type="<%-building_types[i].id%>" id="building_type_<%-building_types[i].id%>">&nbsp;&nbsp;&nbsp;<label for="building_type_<%-building_types[i].id%>" style="display: inline;"><%-building_types[i].type%></label></div>
							<% } %>
						</div>   
	               </div>
               		
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_property_mgmt_company">Property Management:</label></div>
	                   <div class="span8 report-control-right-control">
	                       <input type="text" id="search_property_mgmt_company" value="">
	                   </div>
	               </div>
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_prev_property_mgmt_company">Previous Property Management:</label></div>
	                   <div class="span8 report-control-right-control">
	                       <input type="text" id="search_prev_property_mgmt_company" value="">
	                   </div>
	               </div>
               
               	   <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label>Heat System:</label></div>
	        			<div class="span8 report-control-right-control" style="margin-bottom:10px;">
							<% for(var i=0;i<heat_types.length;i++){ %>
							<div class="row-fluid" style="margin-top: 5px;"><input type="checkbox" class="segment-form-radio heating-type-checkboxes" name="heat-type-radio" heat_type="<%-heat_types[i].id%>" id="heat_type_<%-heat_types[i].id%>">&nbsp;&nbsp;&nbsp;<label for="heat_type_<%-heat_types[i].id%>" style="display: inline;"><%-heat_types[i].type%></label></div>
							<% } %>
						</div>   
	               </div>
               
           <!--- WHERE DO THESE two go?? -->
	               	<div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_elevator">Elevator:</label></div>
	                   <div class="span8 report-control-right-control" >
	                       <select id="search_elevator">
							<option value="null">Any</option>
							<option value="true">Yes</option>
							<option value="false">No</option>
						  </select>
	                   </div>
	               </div>
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="elevator_installed_year_slider">Elevator Installed:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="elevator_installed_year_min">0</span></div>
	                   			
	                   			<input id="elevator_installed_year_slider" type="text" class="" value="" data-slider-min="" data-slider-max="" data-slider-step="5" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="elevator_installed_year_max">250+</span>
	                   		</div>
	                   </div>
	               </div>
	               
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="elevator_upgrade_year_slider">Last Elevator Upgrade:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="elevator_upgrade_year_min">0</span></div>
	                   			
	                   			<input id="elevator_upgrade_year_slider" type="text" class="" value="" data-slider-min="" data-slider-max="" data-slider-step="5" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="elevator_upgrade_year_max">250+</span>
	                   		</div>
	                   </div>
	               </div>
	               
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="cap_rate_slider">CAP Rate:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="cap_rate_min">0</span></div>
	                   			
	                   			<input id="cap_rate_slider" type="text" class="" value="" data-slider-min="" data-slider-max="" data-slider-step="5" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="cap_rate_max">250+</span>
	                   		</div>
	                   </div>
	               </div>
      	 <!--- END WHERE DO THESE two go?? END -->
	               
	               
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="heat_age_slider">Heat System Installed:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="heat_age_min">0</span></div>
	                   			
	                   			<input id="heat_age_slider" type="text" class="" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="heat_age_max">+</span>
	                   		</div>
	                   </div>
	               </div>
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="boiler_installed_year_slider">Boiler Installed:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="boiler_installed_year_min">0</span></div>
	                   			
	                   			<input id="boiler_installed_year_slider" type="text" class="" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="boiler_installed_year_max">+</span>
	                   		</div>
	                   </div>
	               </div>
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="boiler_upgrade_slider">Last Boiler Upgrade:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="boiler_upgrade_min">0</span></div>
	                   			
	                   			<input id="boiler_upgrade_slider" type="text" class="" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="boiler_upgrade_max">+</span>
	                   		</div>
	                   </div>
	               </div>
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_isp">Cable Internet Provider:</label></div>
	                   <div class="span8 report-control-right-control">
	                       <input type="text" id="search_isp" value="">
	                   </div>
	               </div>
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="assessed_value_slider">Assessed Value:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="assessed_value_min">0</span></div>
	                   			
	                   			<input id="assessed_value_slider" type="text" class="" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="assessed_value_max">+</span>
	                   		</div>
	                   </div>
	               </div>
	               
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="bachelor_rent_slider">Bachelor Rent Price:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="bachelor_rent_min">0</span></div>
	                   			
	                   			<input id="bachelor_rent_slider" type="text" class="rent-slider" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="bachelor_rent_max">+</span>
	                   		</div>
	                   </div>
	               </div>

	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="bedroom1_rent_slider">1 Bedroom Rent Price:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="bedroom1_rent_min">0</span></div>
	                   			
	                   			<input id="bedroom1_rent_slider" type="text" class="rent-slider" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="bedroom1_rent_max">+</span>
	                   		</div>
	                   </div>
	               </div>
	               
   	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="bedroom2_rent_slider">2 Bedroom Rent Price:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="bedroom2_rent_min">0</span></div>
	                   			
	                   			<input id="bedroom2_rent_slider" type="text" class="rent-slider" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="bedroom2_rent_max">+</span>
	                   		</div>
	                   </div>
	               </div>	
	               
   	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="bedroom3_rent_slider">3 Bedroom Rent Price:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="bedroom3_rent_min">0</span></div>
	                   			
	                   			<input id="bedroom3_rent_slider" type="text" class="rent-slider" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="bedroom3_rent_max">+</span>
	                   		</div>
	                   </div>
	               </div>               
	               
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="bachelor_units_slider">Bachelor Units:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="bachelor_units_min">0</span></div>
	                   			
	                   			<input id="bachelor_units_slider" type="text" class="units-slider" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="bachelor_units_max">+</span>
	                   		</div>
	                   </div>
	               </div>

	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="bedroom1_units_slider">1 Bedroom Units:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="bedroom1_units_min">0</span></div>
	                   			
	                   			<input id="bedroom1_units_slider" type="text" class="units-slider" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="bedroom1_units_max">+</span>
	                   		</div>
	                   </div>
	               </div>
	               
   	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="bedroom2_units_slider">2 Bedroom Units:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="bedroom2_units_min">0</span></div>
	                   			
	                   			<input id="bedroom2_units_slider" type="text" class="units-slider" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="bedroom2_units_max">+</span>
	                   		</div>
	                   </div>
	               </div>	
	               
   	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="bedroom3_units_slider">3 Bedroom Units:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="bedroom3_units_min">0</span></div>
	                   			
	                   			<input id="bedroom3_units_slider" type="text" class="units-slider" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="bedroom3_units_max">+</span>
	                   		</div>
	                   </div>
	               </div> 
	               
   	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="building_income_slider">Building Income:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="building_income_min">0</span></div>
	                   			
	                   			<input id="building_income_slider" type="text" value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="building_income_max">+</span>
	                   		</div>
	                   </div>
	               </div> 
	               
	               
   	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="sale_price_slider">Last Sale Price:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="sale_price_min">0</span></div>
	                   			
	                   			<input id="sale_price_slider" type="text"  value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="sale_price_max">+</span>
	                   		</div>
	                   </div>
	               </div> 
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="sales_count_slider">Number of Sale History Records:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="sales_count_min">0</span></div>
	                   			
	                   			<input id="sales_count_slider" type="text"  value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="sales_count_max">+</span>
	                   		</div>
	                   </div>
	               </div> 
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label" style="min-height: 30px;padding-top: 5px;"><label for="windows_installed_year_slider">Windows Installed Year:</label></div>
	                   <div class="span7 report-control-right-control" style="min-height: 30px;padding-top: 5px;">
	                   		<div class="row-fluid">
	                   			<div class="pull-left slider-min-val-label"><span id="windows_installed_year_min">0</span></div>
	                   			
	                   			<input id="windows_installed_year_slider" type="text"  value="" data-slider-min="" data-slider-max="" data-slider-step="" data-slider-value=""/>
	                   			&nbsp&nbsp
	                   			<span id="windows_installed_year_max">+</span>
	                   		</div>
	                   </div>
	               </div> 
	               
	               <div class="row-fluid" style="min-height: 40px;">
	                   <div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;"><label for="search_mortgage">Mortgage Company:</label></div>
	                   <div class="span8 report-control-right-control">
	                       <input type="text" id="search_mortgage" value="">
	                   </div>
	               </div>
	               
	               <div class="row-fluid">
	               		<div class="span3 report-control-left-label"  style="min-height: 30px;padding-top: 5px;">
	               			<label for="start_mortgage_due_date">Mortgage Due Date:</label>
	           			</div>
	           			<div class="input-append span3 report-control-right-control" id="start_mortgage_due_date_gen">
	           				<input class="" data-format="yyyy-MM-dd" style="width:150px; max-width:70%;" id="start_mortgage_due_date" type="text" value="">
	       					<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>
	       				</div>
	           			<div class="input-append span1 report-control-right-control">
	       					<span style="display: inline-block;width: auto;height: 20px;min-width: 16px;padding: 4px 5px;font-size: 14px;font-weight: normal;line-height: 20px;">to</span>
						</div>
	           			<div class="input-append span3 report-control-right-control" id="end_mortgage_due_date_gen">
	           				<input class="" data-format="yyyy-MM-dd" style="width:150px; max-width:70%;" id="end_mortgage_due_date" type="text" value="">
	   						<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>
	       				</div>
	   				</div>
	               
	               
	   			</div>
           </div>
        </div>
        </div>
    </div>
</div>


<!-- There next templates are the pieces of the BHS Overview drawing -->
<!-- In order, they represent the columns across the diagram -->


<div class="row-fluid" style="margin-top:19px;">
    <div class="span10 offset1 page-controls-wrapper">
        <div class="row-fluid" id="reportheader"><span style="padding-left:10px;">Buildings</span>
             <% if(req.session.user.policy[req.route.path].update==1){ %><div style="margin-right:10px;font-weight: 400;" class="btn btn-primary pull-right save_pull" id="create_building">Create New</div><% } %>
        
        </div>
        <div class="row-fluid key-indicaters-frame" id="iframediv">
            <div class="row-fluid">
                <table id="buildings" class="display" cellspacing="0" width="100%">
			        <thead>
			            <tr>
			            	<th>Id<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Address<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Units<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Owner<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Property Manager<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Sale Date<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			            </tr>
			        </thead>
			 
			    </table>
            </div>
        </div>
    </div>
</div>


<div class="row-fluid edit-item-section" style="display:none; margin-top:19px;">
    <div class="span10 offset1 page-controls-wrapper">
        <div class="row-fluid" id="reportheader"><span style="padding-left:10px;" id="building-section-title">Edit Building Details</span>
         	<% if(req.session.user.policy[req.route.path].update==1){ %><button style="margin-right:10px;font-weight: 400;" class="btn btn-primary pull-right save_pull" id="save_building">Save</button><% } %>
         	<% if(req.session.user.policy[req.route.path].delete==1){ %><button style="margin-right:10px;font-weight: 400;" class="btn btn-danger pull-right save_pull" id="delete_building">Delete</button><% } %>
         	<button style="margin-right:10px;font-weight: 400;" class="btn pull-right save_pull" id="cancel_building">Cancel</button>
         	<% if(req.session.user.policy[req.route.path].update==1){ %><div style="margin-right: 10px; color: rgb(153, 0, 0); font-weight: 400; display: none;" class="pull-right save_pull" id="changes_pending">Changes Pending. &nbsp;</div><% } %>
  		 </div>
        <div class="row-fluid " id="iframediv" style="margin-bottom:100px;">
        	<div class="content-wrapper building-details-frame">
        		<div id="building-sales">
        			<div class="row-fluid">
						<div class="span12">
							<div class="row-fluid">
								<div class="row-category">
									<span class="" id="sales_title">
										<i class="icon-plus-sign" style="margin-right:10px; display:none;"></i>
										<i class="icon-pencil"></i> &nbsp&nbsp<b>Sales History</b>
									</span>
									<% if(req.session.user.policy[req.route.path].update==1){ %><div class="pull-right" style="height:40px;">
										<span class="row-category-button-wrapper">
											<span id="create_sale" class="btn btn-success">
							                    <i class="glyphicon glyphicon-plus"></i>
							                    <span>Create Sale</span>
							                </span>
										</span>
									</div>
									<div class="pull-right" style="height:40px; display:none;">
										<span  id="delete_sale" class="row-category-button-wrapper">
											<span class="btn btn-danger">
							                    <i class="glyphicon glyphicon-plus"></i>
							                    <span>Delete Sale</span>
							                </span>
										</span>
									</div><% } %>
								</div>
							</div>
						</div>
					</div>
				
				
	
					
				
				
					<div id="building-sales-wrapper" >
						<div id="notes-table-header" class="tableheader row-fluid">
							<div class="span3">
								Timestamp
							</div>
							<div class="span2">
								Owner
							</div>
							<div class="span2">
								Seller
							</div>
							<div class="span2">
								Agent
							</div>
							<div class="span3">
								Price
							</div>
						</div>
						<div id="building-sales-table" class="row-fluid">
						
						</div>
					</div>
        		</div>
        		<div id="main-building-details">
        		
        		</div>
            </div>
        </div>
    </div>
</div>

<!-- Modal  for creating new user -->
<div id="addSaleModal" class="modal hide fade " tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabelAdd">Create Sale</h3>
    </div>
    <div class="modal-body building-segment-wrapper">
        <div class="row-fluid"><p><%= translate[locale]['To create a new sale'] %></p></div>
        
		<div class="row-fluid">
			<div class="span5 segment-label">Sale Price:</div>
			<div class="span7"><input type="text" id="sale_price" value=""></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Sale Date:</div>
			
			<div class="span7">
				<div class="input-append span3 report-control-right-control" id="new_sale_date_gen">
       				<input class="" data-format="yyyy-MM-dd" style="width: 179px;" id="new_sale_date" type="text" value="">
   					<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>
   				</div>
   			</div>
		</div>
		
		<div class="row-fluid">
			<div class="span5 segment-label">Unit Price:</div>
			<div class="span7" style="margin-bottom:10px;">
				<div class="row-fluid" style="margin-top: 5px;"><input type="radio" class="segment-form-radio" name="new-unit-price-radio" id="new_unit_price_calculated_radio" checked="checked">&nbsp&nbsp&nbspCalculated - <span id="new_unit_price_calculated_radio_label"></span></div>
				<div class="row-fluid" style="margin-top: 5px;"><input type="radio" class="segment-form-radio" name="new-unit-price-radio" id="new_unit_price_manual_radio">&nbsp&nbsp&nbspManual - <input style="width:118px; margin-bottom:0px;" type="text" class="" id="new_unit_price"></div>
			</div>
		</div>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true"><%= translate[locale]['Cancel'] %></button>
        <button class="btn btn-primary" id="confirmaddsale"><%= translate[locale]['Create'] %></button>
    </div>
</div>

<!-- Modal  for creating new user -->
<div id="addContactModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabelAdd">Add Contact to Building</h3>
    </div>
    <div class="modal-body">
        <div class="row-fluid create-contact-message"><p><%= translate[locale]['To create a new owner'] %></p></div>
        
        <div class="row-fluid"> 
        	<div class="span6"  style="min-height:90px;">
        		<h4><%= translate[locale]['Contact'] %></h4>
		        <select class="contactscombobox">
				  <option></option>
				</select>
        	</div>
        	<div class="span6"  style="min-height:90px;">
        		<h4><%= translate[locale]['Company'] %></h4>
		        <select class="companiescombobox">
				  <option></option>
				</select>
        	</div>
        </div>
        <div>
	        <div class="row-fluid building-contact-wrapper" style="min-height: 190px;">
		
				<div class="row-fluid">
					<div class="span5 segment-label">Company:</div>
					
					<div class="span7 segment-label-value" id="mapping_new_company_name"></div>
				</div>
				<div class="row-fluid">
					<div class="span5 segment-label">Address:</div>
					<div class="span7" style="padding-top: 6px;" id="mapping_address">
						<div class="row-fluid" id="mapping_new_company_address_1"></div>
						<div class="row-fluid" id="mapping_new_company_address_2"></div>
						<div class="row-fluid" id="mapping_new_company_address_3"></div>
					</div>
				</div>
				<div class="row-fluid">
					<div class="span5 segment-label">Contact:</div>
					<div class="span7 segment-label-value" contact_id="" id="mapping_new_contact_name"></div>
				</div>
				<div class="row-fluid">
					<div class="span5 segment-label">Phone:</div>
					<div class="span7 segment-label-value" id="mapping_new_phone"></div>
				</div>
				<div class="row-fluid">
					<div class="span5 segment-label">Email:</div>
					<div class="span7 segment-label-value" id="mapping_new_email"></div>
				</div>
				
			</div>
		</div>
        
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true"><%= translate[locale]['Cancel'] %></button>
        <button class="btn btn-primary" id="confirmaddbuildingcontact">Add</button>
    </div>
</div>



<script type="text/template" id="building-photo-template">
	<div class="span3 buildingimage">
		<div class="row-fluid" style="position:relative;">
			<img src="{{=image}}" thumb="{{=thumb}}">
			{{if(enabled){ }}<div class="buildingimagetrash"><i class="icon-trash icon-2x"></i></div>{{ } }}
			
			<div id="UploadGif" style="margin: auto; display: none;">
                <div id="blockG_1" class="UploadGif_block">
                </div>
                <div id="blockG_2" class="UploadGif_block">
                </div>
                <div id="blockG_3" class="UploadGif_block">
                </div>
            </div>
			
		</div>
		<div class="row-fluid">
			<div class="progress" style="display: none; margin-bottom: 0px;">
				<div class="bar" style="width: 0%;"></div>
			</div>
		</div>
	</div>
</script>

<script type="text/template" id="building-details-template">



	
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid">
				<div class="row-category">
					<i class="icon-camera"></i> &nbsp&nbsp<b>Photo</b>
					<% if(req.session.user.policy[req.route.path].update==1){ %>
					<div class="pull-right" style="height:40px;">
						<span class="row-category-button-wrapper">
						
							<span class="btn btn-success fileinput-button">
			                    <i class="glyphicon glyphicon-plus"></i>
			                    <span>Add Photo</span>
			                </span>
						
							<div style='height: 0px;width:0px; overflow:hidden;'><input type="file" name="filesToUpload[]" id="filesToUpload" multiple="multiple"/></div>
    
						</span>
					</div>
					<% } %>
				</div>
			</div>
		</div>
	
	</div>
	<div class="row-fluid building-photo-wrapper">
	
	</div>	
	
	
	
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid" >
				<div class="row-category" >
					<i class="icon-home"></i> &nbsp&nbsp<b>Address</b>
				</div>
			</div>
		</div>
	</div>
	{{ if(building_id!='new'&&latitude==null){ }}
	<div class="alert fade in" style="margin-bottom:0px; border-radius:0px;">
		<!-- <button type="button" class="close" data-dismiss="alert">&times</button>-->
		<strong>Warning:&nbsp;</strong>This address is invalid and cannot be geocoded by Google Maps. This address will not display on the maps screen.
	</div>
	{{ } }}
	
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid" >
				<div class="row-category" >
    			</div>
			</div>
		</div>
	</div>
    		
	
	<div class="row-fluid building-segment-wrapper">
		<div class="row-fluid">
			<div class="span5 segment-label">Street Number Begin:</div>
			
			<div class="span7"><input type="hidden" id="building_id" value="{{=building_id}}"><input type="text" id="street_number_begin" {{=typeof(sale_id)!='undefined'?'disabled="disabled"':''}} value="{{=street_number_begin}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Street Number End:</div>
			<div class="span7"><input type="text" id="street_number_end" value="{{=street_number_end}}"  {{=typeof(sale_id)!='undefined'?'disabled="disabled"':''}}></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Street Name:</div>
			<div class="span7"><input type="text" id="street_name" value="{{=street_name}}"  {{=typeof(sale_id)!='undefined'?'disabled="disabled"':''}}></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Postal Code:</div>
			<div class="span7"><input type="text" id="postal_code" value="{{=postal_code}}"  {{=typeof(sale_id)!='undefined'?'disabled="disabled"':''}}></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">City:</div>
			<div class="span7"><input type="text" id="city" value="{{=city}}"  {{=typeof(sale_id)!='undefined'?'disabled="disabled"':''}}></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Province:</div>
			<div class="span7"><select id="province" {{=typeof(sale_id)!='undefined'?'disabled="disabled"':''}}>
			<option value="AB" {{if(province=='AB'){ }}selected="selected"{{ } }}>AB</option>
			<option value="BC" {{if(province=='BC'){ }}selected="selected"{{ } }}>BC</option>
			<option value="MB" {{if(province=='MB'){ }}selected="selected"{{ } }}>MB</option>
			<option value="NB" {{if(province=='NB'){ }}selected="selected"{{ } }}>NB</option>
			<option value="NL" {{if(province=='NL'){ }}selected="selected"{{ } }}>NL</option>
			<option value="NS" {{if(province=='NS'){ }}selected="selected"{{ } }}>NS</option>
			<option value="NT" {{if(province=='NT'){ }}selected="selected"{{ } }}>NT</option>
			<option value="NU" {{if(province=='NU'){ }}selected="selected"{{ } }}>NU</option>
			<option value="ON" {{if(province=='ON'){ }}selected="selected"{{ } }}>ON</option>
			<option value="PE" {{if(province=='PE'){ }}selected="selected"{{ } }}>PE</option>
			<option value="QC" {{if(province=='QC'){ }}selected="selected"{{ } }}>QC</option>
			<option value="SK" {{if(province=='SK'){ }}selected="selected"{{ } }}>SK</option>
			<option value="YT" {{if(province=='YT'){ }}selected="selected"{{ } }}>YT</option>
			
			</select></div>
		</div>
	</div>	
	
	
	
		
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid">
				<div class="row-category">
					<i class="icon-credit-card"></i> &nbsp&nbsp<b>Owners</b>
					
					{{if(typeof(sale_id)=='undefined'){ }}
					<% if(req.session.user.policy[req.route.path].update==1){ %>
					<div class="pull-right" style="height:40px;">
						<span class="row-category-button-wrapper">
							<span id="add_owner" class="btn btn-success">
			                    <i class="glyphicon glyphicon-plus"></i>
			                    <span>Add Owner</span>
			                </span>
						</span>
					</div>
					<% } %>
					{{ } }}
				</div>
			</div>
		</div>
	
	</div>
	
	<div class="row-fluid" id="building-owners-wrapper">
	
	</div>
	
		
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid">
				<div class="row-category">
					<i class="icon-legal"></i> &nbsp&nbsp<b>Sellers</b>
					
					{{if(typeof(sale_id)=='undefined'){ }}
					<% if(req.session.user.policy[req.route.path].update==1){ %>
					<div class="pull-right" style="height:40px;">
						<span class="row-category-button-wrapper">
							<span id="add_seller" class="btn btn-success">
			                    <i class="glyphicon glyphicon-plus"></i>
			                    <span>Add Seller</span>
			                </span>
						</span>
					</div>
					<% } %>
					{{ } }}
				</div>
			</div>
		</div>
	
	</div>
	
	<div class="row-fluid" id="building-sellers-wrapper">
	
	</div>
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid">
				<div class="row-category">
					<i class="icon-legal"></i> &nbsp&nbsp<b>Agents</b>
					{{if(typeof(sale_id)=='undefined'){ }}
					<% if(req.session.user.policy[req.route.path].update==1){ %>
					<div class="pull-right" style="height:40px;">
						<span class="row-category-button-wrapper">
							<span id="add_agent" class="btn btn-success">
			                    <i class="glyphicon glyphicon-plus"></i>
			                    <span>Add Agent</span>
			                </span>
						</span>
					</div>
					<% } %>
					{{ } }}
				</div>
			</div>
		</div>
	
	</div>
	
	<div class="row-fluid" id="building-agents-wrapper">
	
	</div>
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid">
				<div class="row-category">
					<i class="icon-building"></i> &nbsp&nbsp<b>Building Details</b>
				</div>
			</div>
		</div>
	</div>
	<div class="row-fluid building-segment-wrapper">
		<div class="row-fluid">
			<div class="span5 segment-label">Building Type:</div>
			<div class="span7">
			
				<select type="text" id="building_type"><% for(var i=0;i<building_types.length;i++){ %><%-'<option value="'+building_types[i].id+'" {{ if(building_type=='+building_types[i].id+'){ }} selected="selected"{{ } }}  >'+building_types[i].type+'</option>'%><% } %></select>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Property Management:</div>
			<div class="span7"><input type="text" id="property_mgmt_company" value="{{=property_mgmt_company}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Previous Property Management:</div>
			<div class="span7"><input type="text" id="prev_property_mgmt_company" value="{{=prev_property_mgmt_company}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Heat System:</div>
			<div class="span7"><select type="text" id="heat_system_type"><% for(var i=0;i<heat_types.length;i++){ %><%-'<option value="'+heat_types[i].id+'" {{ if(heat_system_type=='+heat_types[i].id+'){ }} selected="selected"{{ } }}>'+heat_types[i].type+'</option>'%><% } %></select>

		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Heat System Installed:</div>
			<div class="span7"><input type="text" min="1900" max="2099" pattern="[0-9]{4}" id="heat_system_age" value="{{=heat_system_age}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Boiler Installed:</div>
			<div class="span7"><input type="text" min="1900" max="2099" pattern="[0-9]{4}" id="boiler_installed_year" value="{{=boiler_installed_year}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Last Boiler Upgrade:</div>
			<div class="span7"><input type="text" min="1900" max="2099" pattern="[0-9]{4}" id="last_boiler_upgrade_year" value="{{=last_boiler_upgrade_year}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Cable Internet Provider:</div>
			<div class="span7"><input type="text" id="cable_internet_provider" value="{{=cable_internet_provider}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Has Elevator:</div>
			<div class="span7" style="min-height:40px;">
			<input type="checkbox" {{if(has_elevator){ }}checked="checked" {{ } }}id="has_elevator"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Elevator Installed Year:</div>
			<div class="span7"><input type="text" min="1900" max="2099" pattern="[0-9]{4}" id="elevator_installed_year" value="{{=elevator_installed_year}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Last Elevator Upgrade Year:</div>
			<div class="span7"><input type="text" min="1900" max="2099" pattern="[0-9]{4}" id="last_elevator_upgrade_year" value="{{=last_elevator_upgrade_year}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Windows Installed Year:</div>
			<div class="span7"><input type="text" min="1900" max="2099" pattern="[0-9]{4}" id="windows_installed_year" value="{{=windows_installed_year}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Total Units:</div>
			<div class="span7"><input type="text" min="0" max="999999" id="unit_quantity" value="{{=unit_quantity}}"></div>
		</div>
	</div>
	
	
	
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid">
				<div class="row-category">
					<i class="icon-money"></i> &nbsp&nbsp<b>Equity Details</b>
				</div>
			</div>
		</div>
	</div>
	<div class="row-fluid building-segment-wrapper">
		<div class="row-fluid">
			<div class="span5 segment-label">Assessed Value:</div>
			<div class="span7"><input type="text" id="assessed_value" value="{{=assessed_value}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Mortgage Company:</div>
			<div class="span7"><input type="text" id="mortgage_company" value="{{=mortgage_company}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Mortgage Due Date:</div>
			
			<div class="span7">
				<div class="input-append span3 report-control-right-control" id="mortgage_due_date_gen">
       				<input class="" data-format="yyyy-MM-dd" style="width: 179px;" id="mortgage_due_date" type="text" value="">
   					<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>
   				</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Bachelor Rent Price:</div>
			<div class="span7"><input type="text" class="unit-price-dependant" id="bachelor_price" value="{{=bachelor_price}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">1 Bedroom Rent Price:</div>
			<div class="span7"><input type="text" class="unit-price-dependant" id="bedroom1_price" value="{{=bedroom1_price}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">2 Bedroom Rent Price:</div>
			<div class="span7"><input type="text" class="unit-price-dependant" id="bedroom2_price" value="{{=bedroom2_price}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">3 Bedroom Rent Price:</div>
			<div class="span7"><input type="text" class="unit-price-dependant" id="bedroom3_price" value="{{=bedroom3_price}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Bachelor Units:</div>
			<div class="span7"><input type="text" class="unit-price-dependant total-units-dependant" id="bachelor_units" value="{{=bachelor_units}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">1 Bedroom Units:</div>
			<div class="span7"><input type="text" class="unit-price-dependant total-units-dependant" id="bedroom1_units" value="{{=bedroom1_units}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">2 Bedroom Units:</div>
			<div class="span7"><input type="text" class="unit-price-dependant total-units-dependant" id="bedroom2_units" value="{{=bedroom2_units}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">3 Bedroom Units:</div>
			<div class="span7"><input type="text" class="unit-price-dependant total-units-dependant" id="bedroom3_units" value="{{=bedroom3_units}}"></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Building Income:</div>
			<div class="span7" style="margin-bottom:10px;">
				<div class="row-fluid" style="margin-top: 5px;"><input type="radio" class="segment-form-radio" name="building-income-radio" id="income_calculated_radio" {{ if(!building_income_manual_mode){ }}checked="checked"{{ } }}>&nbsp&nbsp&nbspCalculated - <span id="income_calculated_radio_label">{{ if(!building_income_manual_mode){ }}{{='$'+(building_income==null?'0.00':building_income.toFixed(2))}}{{ } }}</span></div>
				<div class="row-fluid" style="margin-top: 5px;"><input type="radio" class="segment-form-radio" name="building-income-radio" id="income_manual_radio" {{ if(building_income_manual_mode){ }}checked="checked"{{ } }}>&nbsp&nbsp&nbspManual - <input style="width:118px; margin-bottom:0px;" type="text" class="" id="building_income" {{ if(!building_income_manual_mode){ }}disabled="disabled" {{ }else{ }}value="{{=building_income}}"{{ } }}></div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Unit Price:</div>
			<div class="span7" style="margin-bottom:10px;">
				<div class="row-fluid" style="margin-top: 5px;"><input type="radio" class="segment-form-radio" name="unit-price-radio" id="unit_price_calculated_radio" {{ if(!unit_price_manual_mode){ }}checked="checked"{{ } }}>&nbsp&nbsp&nbspCalculated - <span id="unit_price_calculated_radio_label">{{ if(!unit_price_manual_mode){ }}{{='$'+(unit_price==null?'0.00':unit_price.toFixed(2))}}{{ } }}</span></div>
				<div class="row-fluid" style="margin-top: 5px;"><input type="radio" class="segment-form-radio" name="unit-price-radio" id="unit_price_manual_radio" {{ if(unit_price_manual_mode){ }}checked="checked"{{ } }}>&nbsp&nbsp&nbspManual - <input style="width:118px; margin-bottom:0px;" type="text" class="" id="unit_price" {{ if(!unit_price_manual_mode){ }}disabled="disabled" {{ }else{ }}value="{{=unit_price}}"{{ } }}></div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">CAP Rate:</div>
			<div class="span7 cap-rate"><span id="cap_rate">%{{=cap_rate}}</span></div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">{{if(typeof(sale_id)=='undefined'){ }}Last {{ } }}Sale Date:</div>
			<div class="span7">
				<div class="input-append span3 report-control-right-control" id="last_sale_date_gen" >
       				<input class="" data-format="yyyy-MM-dd" {{if(typeof(sale_id)!='undefined'){ }}style="width: 179px;"{{ }else{ }}style="width: 206px;"{{ } }} id="sale_date" type="text" value="" {{if(typeof(sale_id)=='undefined'){ }}disabled="disabled"{{ } }}>
   					{{if(typeof(sale_id)!='undefined'){ }}<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>{{ } }}
   				</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">{{if(typeof(sale_id)=='undefined'){ }}Last {{ } }}Sale Price:</div>
			<div class="span7"><input type="text" id="last_sale_price" value="{{=last_sale_price}}" {{if(typeof(sale_id)=='undefined'){ }}disabled="disabled"{{ } }}></div>
		</div>
	</div>
	{{ if(typeof(sale_id)=='undefined'&&building_id!='new'){ }}
	<div class="row-fluid">
		<div class="span12">
			<div class="row-fluid">
				<div class="row-category">
					<i class="icon-pencil"></i> &nbsp&nbsp<b>Note History</b>
					<div class="pull-right" style="height:40px;">
						<span class="row-category-button-wrapper">
							<span id="create_note" class="btn btn-success">
			                    <span>Create Note</span>
			                </span>
						</span>
					</div>
         	<% if(req.session.user.policy[req.route.path].delete==0){ %>
					<div class="pull-right" style="height:40px;">
						<span class="row-category-button-wrapper" id="save_note_parent">
							<span id="save_notes" class="btn btn-primary">
			                    <span>Save Notes</span>
			                </span>
						</span>
					</div>
         	<% } %>
					
         	<% if(req.session.user.policy[req.route.path].update==0){ %>
         	<div style="margin-right: 10px; color: rgb(153, 0, 0); font-weight: 400; display: none;" class="pull-right save_pull" id="changes_pending">Changes Pending. &nbsp;</div>
         	<% } %>
					
					
					
					
				</div>
			</div>
		</div>
	</div>
	
	<div id="notes-table-header" class="tableheader row-fluid">
		<div class="span2">
			Timestamp
		</div>
		<div class="span2">
			User
		</div>
		<div class="span6">
			Details
		</div>
		<div class="span2">
			Modify
		</div>
	</div>
	<div id="building-notes-wrapper" class="row-fluid css-notes-wrapper">
	
	</div>
	{{ } }}
</script>

<script type="text/template" id="building-notes-template">
	<div class="row-fluid building-note" noteid="{{=id}}">
		<div class="span2">
			<span class="mobilelabel">Timestamp:</span>{{=note_datetime}}
		</div>
		<div class="span2">
			<span class="mobilelabel">User:</span>{{=user}}
		</div>
		<div class="span6"><span class="mobilelabel">Details:</span><div class="note-editable">{{=note}}</div></div>
		<div class="span2" style="padding-top:0px;">
			<div class="row-fluid" style="padding:6px;">
				{{ if(user=='<%=req.session.user.username%>'||<%=req.session.user.policy[req.route.path].update==1%>){ }}<a class="edit-note" style="color:#0F74BC;cursor:pointer;padding-right:6px;"><i class="icon-edit icon-2x"></i></a> {{ } }}
				{{ if(user=='<%=req.session.user.username%>'||<%=req.session.user.policy[req.route.path].update==1%>){ }}<a class="delete-note" style="color:red;cursor:pointer;"><i class="icon-remove-sign icon-2x"></i></a>{{ } }}
			</div>
		</div>
	</div>
</script>

<script type="text/template" id="building-contact-template">
	<div class="row-fluid building-contact-wrapper" contact_mapping_id="{{=mapping_id}}" contact_id="{{=contact_id}}" {{ if(typeof(dodelete)!='undefined'){ }}style="display:none;"{{ } }}>

		<div class="row-fluid">
			<div class="span5 segment-label">Company:</div>
			<div class="span7 segment-label-value">{{=cur_company_name}}</div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Address:</div>
			<div class="span7" style="padding-top: 6px;">
				<div class="row-fluid">{{=(street_number_begin==null?'':street_number_begin)+(street_number_end==''||street_number_end==null||street_number_end=='null'?'':' - '+street_number_end)+(street_name==''||street_name==null||street_name=='null'?'':' '+street_name)}}</div>
				<div class="row-fluid">{{=(city==''||city==null||city=='null'?'':city)+(province==''||province==null||province=='null'?'':(city==''||city==null||city=='null'?'':', ')+province)}}</div>
				<div class="row-fluid">{{=postal_code==null||postal_code=='null'||postal_code==''?'':postal_code}}</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Contact:</div>
			<div class="span7 segment-label-value">{{=contact_name}}</div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Phone:</div>
			<div class="span7 segment-label-value">{{=phone_number}}</div>
		</div>
		<div class="row-fluid">
			<div class="span5 segment-label">Email:</div>
			<div class="span7 segment-label-value">{{=email}}</div>
		</div>
		
		{{if(typeof(sale_id)=='undefined'){ }}
		<% if(req.session.user.policy[req.route.path].update==1){ %>
		<div class="row-fluid">
			<div class="span12 "><a class="btn btn-danger pull-right remove-building-contact">Delete</a></div>
		</div>
		<% } %>
		{{ } }}
		
	</div>
</script>


<script type="text/template" id="building-sale-template">
	<div class="row-fluid building-sale-wrapper generic-table-styling {{=typeof(selected)!='undefined'&&selected?'table-row-selected':''}}" sale_id="{{=sale_id}}" building_id="{{=building_id}}">
		<div class="row-fluid">
			<div class="span3">{{=sale_datestring}}</div>
			<div class="span2">{{=owner}}</div>
			<div class="span2">{{=seller}}</div>
			<div class="span2">{{=agent}}</div>
			<div class="span3">{{=formatted_sale_price}}</div>
		</div>
	</div>
</script>


<!-- Modal - confirms you want to continue to delete contact -->
<div id="deleteModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabeldelete"></h3>
    </div>
    <div class="modal-body">
        <p>One fine body…</p>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true"><%= translate[locale]['Cancel'] %></button>
        <button class="btn btn-danger" data-dismiss="modal" aria-hidden="true" id="confirmdelete"><%= translate[locale]['Delete'] %></button>
    </div>
</div>

<!-- Modal - confirms you want to continue to delete contact -->
<div id="deleteSaleModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabeldeleteSale"></h3>
    </div>
    <div class="modal-body">
        <p>One fine body…</p>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true"><%= translate[locale]['Cancel'] %></button>
        <button class="btn btn-danger" data-dismiss="modal" aria-hidden="true" id="confirmdeletesale"><%= translate[locale]['Delete'] %></button>
    </div>
</div>
<script>


    var alarms;
    $(document).ready(function(){
    
    	var unitsMax = null;
    	var unitsMin = null;
    	var building_income_max = null;
		var elevator_installed_year_max = null;
		var unit_price_max = null;
		var elevator_upgrade_year_max = null;
		var cap_rate_max = null;
		var sale_price_max = null;
		var assessed_value_max = null;
		var boiler_installed_year_max = null;
		var boiler_upgrade_max = null;
		var heat_age_max = null;
		var sales_count_max = null;
		var windows_installed_year_max = null;
		var windows_installed_year_max;
		
    	var building_income_min = null;
		var elevator_installed_year_min = null;
		var unit_price_min = null;
		var elevator_upgrade_year_min = null;
		var cap_rate_min = null;
		var sale_price_min = null;
		var assessed_value_min = null;
		var boiler_installed_year_min = null;
		var boiler_upgrade_min = null;
		var heat_age_min = null;
		var sales_count_min = null;
		var windows_installed_year_min = null;
		var windows_installed_year_min;
    	
    	var bachelor_units_min = null;
    	var bachelor_units_max = null;
    	var bedroom1_units_min = null;
    	var bedroom1_units_max = null;
    	var bedroom2_units_min = null;
    	var bedroom2_units_max = null;
    	var bedroom3_units_min = null;
    	var bedroom3_units_max = null;
    	
    	var bachelor_rent_min = null;
    	var bachelor_rent_max = null;
    	var bedroom1_rent_min = null;
    	var bedroom1_rent_max = null;
    	var bedroom2_rent_min = null;
    	var bedroom2_rent_max = null;
    	var bedroom3_rent_min = null;
    	var bedroom3_rent_max = null;
    	
    	var sliderLimit = 250;
    	var bucketPrefix = "https://s3-us-west-2.amazonaws.com/credimages/";
    	var tempImg = null;
    	var lastImageUrl = "";
    	var lastThumbUrl = "";
        var MAX_WIDTH = 500;
        var MAX_HEIGHT = 400;
        var THMB_WIDTH = 125;
        var THMB_HEIGHT = 125;
        var leaveSalesExpanded = false;
        var triggerScroll = false;
    	var init_id = <%=typeof(init_id)!='undefined'?init_id:null%>;
    	var salepicker;
    	var MAX_CAP_RATE = 500;
    	var MIN_CAP_RATE = 0;
    	var STEP_CAP_RATE = 10;
    	var MIN_HEAT_AGE = 1900;
    	var MAX_HEAT_AGE = 2038;
    	var STEP_HEAT_AGE = 10;
    	var MIN_BOILER_INSTALLED_YEAR = 1900;
    	var MAX_BOILER_INSTALLED_YEAR = 2100;
    	var STEP_BOILER_INSTALLED_YEAR = 10;
    	var MIN_BOILER_UPGRADE = 1900;
    	var MAX_BOILER_UPGRADE = 2100;
    	var STEP_BOILER_UPGRADE = 10;
    	
    	var MIN_ASSESSED_VALUE = 0;
    	var MAX_ASSESSED_VALUE = 1000000;
    	var STEP_ASSESSED_VALUE = 1000;
    	
    	var MIN_ROOM_RENT = 0;
    	var MAX_ROOM_RENT = 10000;
    	var STEP_ROOM_RENT = 100;
    	var MIN_ROOM_UNITS = 0;
    	var MAX_ROOM_UNITS = 1000;
    	var STEP_ROOM_UNITS = 1;
    	
    	var MIN_BUILDING_INCOME = 0;
    	var MAX_BUILDING_INCOME = 1000000;
    	var STEP_BUILDING_INCOME = 1000;
    	
    	var MIN_UNIT_PRICE = 0;
    	var MAX_UNIT_PRICE = 1000000;
    	var STEP_UNIT_PRICE = 1000;

    	var MIN_SALE_PRICE = 0;
    	var MAX_SALE_PRICE = 10000000;
    	var STEP_SALE_PRICE = 1000;
    	
    	var MIN_SALES_COUNT = 0;
    	var MAX_SALES_COUNT = 10;
    	var STEP_SALES_COUNT = 1;
    	
    	var MIN_WINDOWS_INSTALLED_YEAR = 1900;
    	var MAX_WINDOWS_INSTALLED_YEAR = 2100;
    	var STEP_WINDOWS_INSTALLED_YEAR = 1;
    	
    	var MIN_ELEVATOR_UPGRADE_YEAR = 1900;
    	var MAX_ELEVATOR_UPGRADE_YEAR = 2100;
    	var STEP_ELEVATOR_UPGRADE_YEAR = 1;
    	
    	var MIN_ELEVATOR_INSTALLED_YEAR = 1900;
    	var MAX_ELEVATOR_INSTALLED_YEAR = 2100;
    	var STEP_ELEVATOR_INSTALLED_YEAR = 1;
    	
    	
    	var buildingphototemplate = _.template($('#building-photo-template').html());
    	
    	//var buildingtemplate = _.template($('#building-details-template').html());
    	//$('.building-details-frame').append(buildingtemplate());
    	
		$('#create_building').click(function(){
		
			$('.edit-item-section').css('display','none');
			$('#delete_building').css('display','none');
			$('#buildings tbody tr.selected').removeClass('selected');
			building.clear();
			building = new BuildingModel({building_id:'new',street_number_begin:'',street_number_end:'',street_name:'',city:'',province:'',postal_code:'',building_type:1
										,property_mgmt_company:null,prev_property_mgmt_company:null,heat_system_age:null,heat_system_type:null,boiler_installed_year:null,elevator_installed_year:null,windows_installed_year:null,cable_internet_provider:'',assessed_value:null
										,bachelor_price:null,bedroom1_price:null,bedroom2_price:null,bedroom3_price:null,bachelor_units:null,bedroom1_units:null,bedroom2_units:null,bedroom3_units:null,building_income:null
										,building_income_manual_mode:false,unit_price:null,unit_price_manual_mode:false,unit_quantity:null
										,last_boiler_upgrade_year:null,has_elevator:false, latitude:null, longitude:null, last_elevator_upgrade_year:null
										,sale_date:null,last_sale_price:null,images:'',mortgage_company:null,mortgage_due_date:null,cap_rate:null});
			$('#building-sales').css('display','none');
			buildingcontacts.reset();
			if(buildingcontactsView==null)
            {
            	buildingcontactsView = new BuildingContactsBackboneView({collection: buildingcontacts});
        	}
        	buildingnotes.reset();
        	//if(buildingnotesView==null)
        	//{
        	//	buildingnotesView = new BuildingNotesBackboneView({collection: buildingnotes});
        	//}         
        	
			
            if(buildingView==null){
            	buildingView = new BuildingBackboneView();
            	buildingView.render();
            }else{
            	buildingView.render();
            }
            setTimeout(function(){
				if($('body').width()>979){
					$('.main-content').animate({
				        scrollTop: $(".edit-item-section").offset().top - $('.navbar-fixed-top').height()
				    }, 500);
				}else{
					$('html, body').animate({
				        scrollTop: $(".edit-item-section").offset().top
				    }, 500);
				}
            },100);
		
		});
		
		$('#delete_building').click(function(){
	            $('#myModalLabeldelete').html('Delete Building');
	            $('#deleteModal > div.modal-body').html('<p>Are you sure you want to delete this building<b>'+'</b>?</p>');
	            $('#deleteModal').modal('show');
		});
		
		$('#confirmdelete').click(function(){
			socket.get('/buildings/deletebuilding',{building_id:building.get('building_id')},function(response){
				datatable.api().ajax.reload(function(){},false);
				$('#delete_building').css('display','none');
				$('.edit-item-section').css('display','none');			
				//contact = new ContactModel({contact_id:'new',contact_name:'',email:'',phone_number:''});
				//contactView.render();
				//companies.reset();
				//companyView.render();
			});
		});
		$('#confirmdeletesale').click(function(){
			socket.get('/buildings/deletesale/'+building.get('sale_id'),[],function(deleteResponse){
		        	
        		leaveSalesExpanded = true;
        		building.fetch({id:parseInt(building.get('building_id'))});
        	});
		});
		
		        	
		
		$('#cancel_building').click(function(){
			$('.edit-item-section').css('display','none');
			$('#delete_building').css('display','none');
			$('#buildings tbody tr').removeClass('selected');
		});
		

		var datatable = $('#buildings').dataTable({
		        "processing": true,
		        "serverSide": true,
		        "dom":"tipr",
		        "ajax": {
		        	"url":"/buildings/getajax",
	        		"data":function(d){
	        			d.address_search = $("#search_address").val();
	        			d.contact_search = $("#search_contact").val();
	        			d.company_search = $('#search_company').val();
	        			d.mortgage_search = $('#search_mortgage').val();
	        			
	        			d.unitQuantityMin = unitsMin==0?null:unitsMin;
	        			d.unitQuantityMax = unitsMax==sliderLimit?null:unitsMax;
	        			d.unit_price_min = unit_price_min==0?null:unit_price_min;
	        			d.unit_price_max = unit_price_max==MAX_UNIT_PRICE?null:unit_price_max;
	        			
	        			d.saleDateRangeStart = $('#start_time').val();
	        			d.saleDateRangeEnd = $('#end_time').val();
	        			
	        			d.has_elevator = ($('#search_elevator').val()=='null'||$('#search_elevator').val()==null)?null:($('#search_elevator').val()=='true'||$('#search_elevator').val()==true?true:false);
	        			d.elevator_installed_year_min = elevator_installed_year_min==MIN_ELEVATOR_INSTALLED_YEAR?null:elevator_installed_year_min;
	        			d.elevator_installed_year_max = elevator_installed_year_max==MAX_ELEVATOR_INSTALLED_YEAR?null:elevator_installed_year_max;
	        			d.elevator_upgrade_year_min = elevator_upgrade_year_min==MIN_ELEVATOR_UPGRADE_YEAR?null:elevator_upgrade_year_min;
	        			d.elevator_upgrade_year_max = elevator_upgrade_year_max==MAX_ELEVATOR_UPGRADE_YEAR?null:elevator_upgrade_year_max;
	        			
	        			d.cap_rate_min = cap_rate_min==MIN_CAP_RATE?null:cap_rate_min;
	        			d.cap_rate_max = cap_rate_max==MAX_CAP_RATE?null:cap_rate_max;
	        			d.search_property_mgmt_company = $('#search_property_mgmt_company').val();
	        			d.search_prev_property_mgmt_company = $('#search_prev_property_mgmt_company').val();
	        			d.heat_age_min = heat_age_min==MIN_HEAT_AGE?null:heat_age_min;
	        			d.heat_age_max = heat_age_max==MAX_HEAT_AGE?null:heat_age_max;
	        			
	        			d.boiler_installed_year_min = boiler_installed_year_min==MIN_BOILER_INSTALLED_YEAR?null:boiler_installed_year_min;
	        			d.boiler_installed_year_max = boiler_installed_year_max==MAX_BOILER_INSTALLED_YEAR?null:boiler_installed_year_max;
	        			
	        			d.boiler_upgrade_min = boiler_upgrade_min==MIN_BOILER_UPGRADE?null:boiler_upgrade_min;
	        			d.boiler_upgrade_max = boiler_upgrade_max==MAX_BOILER_UPGRADE?null:boiler_upgrade_max;
	        			
	        			d.assessed_value_min = assessed_value_min==MIN_ASSESSED_VALUE?null:assessed_value_min;
	        			d.assessed_value_max = assessed_value_max==MAX_ASSESSED_VALUE?null:assessed_value_max;
	        			
	        			d.building_income_min = building_income_min==MIN_BUILDING_INCOME?null:building_income_min;
	        			d.building_income_max = building_income_max==MAX_BUILDING_INCOME?null:building_income_max;
	        			
	        			d.sale_price_min = sale_price_min==MIN_SALE_PRICE?null:sale_price_min;
	        			d.sale_price_max = sale_price_max==MAX_SALE_PRICE?null:sale_price_max;
	        			
	        			d.bachelor_units_min = bachelor_units_min==MIN_ROOM_UNITS?null:bachelor_units_min;
	        			d.bachelor_units_max = bachelor_units_max==MAX_ROOM_UNITS?null:bachelor_units_max;
	        			
	        			d.bedroom1_units_min = bedroom1_units_min==MIN_ROOM_UNITS?null:bedroom1_units_min;
	        			d.bedroom1_units_max = bedroom1_units_max==MAX_ROOM_UNITS?null:bedroom1_units_max;
	        			
	        			d.bedroom2_units_min = bedroom2_units_min==MIN_ROOM_UNITS?null:bedroom2_units_min;
	        			d.bedroom2_units_max = bedroom2_units_max==MAX_ROOM_UNITS?null:bedroom2_units_max;
	        			
	        			d.bedroom3_units_min = bedroom3_units_min==MIN_ROOM_UNITS?null:bedroom3_units_min;
	        			d.bedroom3_units_max = bedroom3_units_max==MAX_ROOM_UNITS?null:bedroom3_units_max;
	        			
	        			d.bachelor_rent_min = bachelor_rent_min==MIN_ROOM_RENT?null:bachelor_rent_min;
	        			d.bachelor_rent_max = bachelor_rent_max==MAX_ROOM_RENT?null:bachelor_rent_max;
	        			
	        			d.bedroom1_rent_min = bedroom1_rent_min==MIN_ROOM_RENT?null:bedroom1_rent_min;
	        			d.bedroom1_rent_max = bedroom1_rent_max==MAX_ROOM_RENT?null:bedroom1_rent_max;
	        			
	        			d.bedroom2_rent_min = bedroom2_rent_min==MIN_ROOM_RENT?null:bedroom2_rent_min;
	        			d.bedroom2_rent_max = bedroom2_rent_max==MAX_ROOM_RENT?null:bedroom2_rent_max;
	        			
	        			d.bedroom3_rent_min = bedroom3_rent_min==MIN_ROOM_RENT?null:bedroom3_rent_min;
	        			d.bedroom3_rent_max = bedroom3_rent_max==MAX_ROOM_RENT?null:bedroom3_rent_max;
	        			
	        			d.windows_installed_year_min = windows_installed_year_min==MIN_WINDOWS_INSTALLED_YEAR?null:windows_installed_year_min;
	        			d.windows_installed_year_max = windows_installed_year_max==MAX_WINDOWS_INSTALLED_YEAR?null:windows_installed_year_max;
	        			
	        			d.cable_internet_provider = $('#search_isp').val();
	        			
	        			
	        			d.start_mortgage_due_date = $('#start_mortgage_due_date').val();
	        			d.end_mortgage_due_date = $('#end_mortgage_due_date').val();
	        			
	        			d.sales_count_min = sales_count_min==MIN_SALES_COUNT?null:sales_count_min;
	        			d.sales_count_max = sales_count_max==MAX_SALES_COUNT?null:sales_count_max;
	        			var checkbox_building_types = '';
	        			$('.building-type-checkboxes').each(function(){
	        				if($(this).is(':checked')){
	        					if(checkbox_building_types != ''){
	        						checkbox_building_types = checkbox_building_types + ',';
	        					}
	        					checkbox_building_types = checkbox_building_types + $(this).attr('building_type');
	        				}
	        			});	        			
	        			if(checkbox_building_types!=''){
	        				checkbox_building_types = "'"+checkbox_building_types+"'";
	        			}
	        			d.checkbox_building_types = checkbox_building_types;
	        			
	        			var checkbox_heating_types = '';
	        			$('.heating-type-checkboxes').each(function(){
	        				if($(this).is(':checked')){
	        					if(checkbox_heating_types != ''){
	        						checkbox_heating_types = checkbox_heating_types + ',';
	        					}
	        					checkbox_heating_types = checkbox_heating_types + $(this).attr('heat_type');
	        				}
	        			});        			
	        			if(checkbox_heating_types!=''){
	        				checkbox_heating_types = "'"+checkbox_heating_types+"'";
	        			}
	        			d.checkbox_heating_types = checkbox_heating_types;
	        		},
	        		error: function(xhr, error, thrown){
	        			
	        		}
	        	},
		        "aoColumns":[
		        	{"mData":"building_id","visible":false}
		         	,{"mData":function(data,b){ 
			        	return "<b>"+data.street_number_begin+" "+data.street_name+", "+data.city+"</b>"; }
			        }
			        ,{"mData":"units"}
			        ,{"mData":"owner"}
			        ,{"mData":"property_mgmt_company"}
			        ,{"mData":function(data,b){
			        	if(data.sale_date==null)
			        		return '';
			        	return toDateTimeString(new Date(data.sale_date));
			        }}
		        ],
		        "rowCallback": function( row, data, displayIndex ) {
					$(row).attr('building_id',data['building_id']);
					$(row).click(function(){
						$('#delete_building').css('display','');
    					building.fetch({id:parseInt($(row).attr('building_id'))});
               		});
	               
		        }
	    });
	    $('select[name=buildings_length]').css('margin-top','10px');
	    $('#buildings_length label').css('margin-bottom','0px');
	    
	     $('#buildings').on('draw.dt',function(event,datatable){
	     	if(init_id){
				building.fetch({id:init_id});
	     		init_id = null;
	     		leaveSalesExpanded = true;
	     		triggerScroll = true;
	     	}
	     	
	     	if(!isNaN(parseInt(building.get('building_id')))){
	     		$('#buildings tbody tr[building_id='+building.get('building_id')+']').addClass('selected');
	     	}
    	});
    	
    	

		$('#search_address').keydown(function(){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		$('#search_contact').keydown(function(){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		$('#search_company').keydown(function(){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		$('#search_mortgage').keydown(function(){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		
		$('.building-type-checkboxes').click(function(){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		
		});
		$('.heating-type-checkboxes').click(function(){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		
		});
		$('#search_elevator').change(function(){
			datatable.api().ajax.reload();
		});
		
		
		function initSliders(){
		
		
		
			$('.rent-slider').attr('data-slider-min',MIN_ROOM_RENT); // corrects limit
			$('.rent-slider').attr('data-slider-max',MAX_ROOM_RENT); // corrects limit
			$('.rent-slider').attr('data-slider-step',STEP_ROOM_RENT); // corrects limit
			$('.rent-slider').attr('data-slider-value','['+MIN_ROOM_RENT+','+MAX_ROOM_RENT+']');
			$('.rent-slider').slider({tooltip: 'disabled'});
			$('.units-slider').attr('data-slider-min',MIN_ROOM_UNITS); // corrects limit
			$('.units-slider').attr('data-slider-max',MAX_ROOM_UNITS); // corrects limit
			$('.units-slider').attr('data-slider-step',STEP_ROOM_UNITS); // corrects limit
			$('.units-slider').attr('data-slider-value','['+MIN_ROOM_UNITS+','+MAX_ROOM_UNITS+']');
			$('.units-slider').slider({tooltip: 'disabled'});
			
			
			$('#bachelor_rent_min').html(MIN_ROOM_RENT);
			$('#bachelor_rent_max').html(MAX_ROOM_RENT+'+');
			$('#bachelor_rent_slider').on('slide',function(slideEvt){
				bachelor_rent_min = slideEvt.value[0];
				bachelor_rent_max = slideEvt.value[1];
				$('#bachelor_rent_min').html(bachelor_rent_min);
				
				if(bachelor_rent_max==MAX_ROOM_RENT)
				{
					$('#bachelor_rent_max').html(bachelor_rent_max+'+');
				}else{
					$('#bachelor_rent_max').html(bachelor_rent_max);
				}
			});
			$('#bachelor_rent_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			$('#bedroom1_rent_min').html(MIN_ROOM_RENT);
			$('#bedroom1_rent_max').html(MAX_ROOM_RENT+'+');
			$('#bedroom1_rent_slider').on('slide',function(slideEvt){
				bedroom1_rent_min = slideEvt.value[0];
				bedroom1_rent_max = slideEvt.value[1];
				$('#bedroom1_rent_min').html(bedroom1_rent_min);
				
				if(bedroom1_rent_max==MAX_ROOM_RENT)
				{
					$('#bedroom1_rent_max').html(bedroom1_rent_max+'+');
				}else{
					$('#bedroom1_rent_max').html(bedroom1_rent_max);
				}
			});
			$('#bedroom1_rent_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			$('#bedroom2_rent_min').html(MIN_ROOM_RENT);
			$('#bedroom2_rent_max').html(MAX_ROOM_RENT+'+');
			$('#bedroom2_rent_slider').on('slide',function(slideEvt){
				bedroom2_rent_min = slideEvt.value[0];
				bedroom2_rent_max = slideEvt.value[1];
				$('#bedroom2_rent_min').html(bedroom2_rent_min);
				
				if(bedroom2_rent_max==MAX_ROOM_RENT)
				{
					$('#bedroom2_rent_max').html(bedroom2_rent_max+'+');
				}else{
					$('#bedroom2_rent_max').html(bedroom2_rent_max);
				}
			});
			$('#bedroom2_rent_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			$('#bedroom3_rent_min').html(MIN_ROOM_RENT);
			$('#bedroom3_rent_max').html(MAX_ROOM_RENT+'+');
			$('#bedroom3_rent_slider').on('slide',function(slideEvt){
				bedroom3_rent_min = slideEvt.value[0];
				bedroom3_rent_max = slideEvt.value[1];
				$('#bedroom3_rent_min').html(bedroom3_rent_min);
				
				if(bedroom3_rent_max==MAX_ROOM_RENT)
				{
					$('#bedroom3_rent_max').html(bedroom3_rent_max+'+');
				}else{
					$('#bedroom3_rent_max').html(bedroom3_rent_max);
				}
			});
			$('#bedroom3_rent_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			
			// Units
			$('#bachelor_units_min').html(MIN_ROOM_RENT);
			$('#bachelor_units_max').html(MAX_ROOM_UNITS+'+');
			$('#bachelor_units_slider').on('slide',function(slideEvt){
				bachelor_units_min = slideEvt.value[0];
				bachelor_units_max = slideEvt.value[1];
				$('#bachelor_units_min').html(bachelor_units_min);
				
				if(bachelor_units_max==MAX_ROOM_UNITS)
				{
					$('#bachelor_units_max').html(bachelor_units_max+'+');
				}else{
					$('#bachelor_units_max').html(bachelor_units_max);
				}
			});
			$('#bachelor_units_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			$('#bedroom1_units_min').html(MIN_ROOM_UNITS);
			$('#bedroom1_units_max').html(MAX_ROOM_UNITS+'+');
			$('#bedroom1_units_slider').on('slide',function(slideEvt){
				bedroom1_units_min = slideEvt.value[0];
				bedroom1_units_max = slideEvt.value[1];
				$('#bedroom1_units_min').html(bedroom1_units_min);
				
				if(bedroom1_units_max==MAX_ROOM_UNITS)
				{
					$('#bedroom1_units_max').html(bedroom1_units_max+'+');
				}else{
					$('#bedroom1_units_max').html(bedroom1_units_max);
				}
			});
			$('#bedroom1_units_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			$('#bedroom2_units_min').html(MIN_ROOM_UNITS);
			$('#bedroom2_units_max').html(MAX_ROOM_UNITS+'+');
			$('#bedroom2_units_slider').on('slide',function(slideEvt){
				bedroom2_units_min = slideEvt.value[0];
				bedroom2_units_max = slideEvt.value[1];
				$('#bedroom2_units_min').html(bedroom2_units_min);
				
				if(bedroom2_units_max==MAX_ROOM_UNITS)
				{
					$('#bedroom2_units_max').html(bedroom2_units_max+'+');
				}else{
					$('#bedroom2_units_max').html(bedroom2_units_max);
				}
			});
			$('#bedroom2_units_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			$('#bedroom3_units_min').html(MIN_ROOM_UNITS);
			$('#bedroom3_units_max').html(MAX_ROOM_UNITS+'+');
			$('#bedroom3_units_slider').on('slide',function(slideEvt){
				bedroom3_units_min = slideEvt.value[0];
				bedroom3_units_max = slideEvt.value[1];
				$('#bedroom3_units_min').html(bedroom3_units_min);
				
				if(bedroom3_units_max==MAX_ROOM_UNITS)
				{
					$('#bedroom3_units_max').html(bedroom3_units_max+'+');
				}else{
					$('#bedroom3_units_max').html(bedroom3_units_max);
				}
			});
			
			$('#bedroom3_units_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			
			$('#building_income_slider').attr('data-slider-min',MIN_BUILDING_INCOME); // corrects limit
			$('#building_income_slider').attr('data-slider-max',MAX_BUILDING_INCOME); // corrects limit
			$('#building_income_slider').attr('data-slider-step',STEP_BUILDING_INCOME); // corrects limit
			$('#building_income_min').html(MIN_BUILDING_INCOME);
			$('#building_income_max').html(MAX_BUILDING_INCOME+'+');
			$('#building_income_slider').attr('data-slider-value','['+MIN_BUILDING_INCOME+','+MAX_BUILDING_INCOME+']');
			$('#building_income_slider').slider({tooltip: 'disabled'});
			$('#building_income_slider').on('slide',function(slideEvt){
				building_income_min = slideEvt.value[0];
				building_income_max = slideEvt.value[1];
				$('#building_income_min').html(building_income_min);
				
				if(building_income_max==MAX_BUILDING_INCOME)
				{
					$('#building_income_max').html(building_income_max+'+');
				}else{
					$('#building_income_max').html(building_income_max);
				}
			});
			$('#building_income_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			
			$('#elevator_installed_year_slider').attr('data-slider-min',MIN_ELEVATOR_INSTALLED_YEAR); // corrects limit
			$('#elevator_installed_year_slider').attr('data-slider-max',MAX_ELEVATOR_INSTALLED_YEAR); // corrects limit
			$('#elevator_installed_year_slider').attr('data-slider-step',STEP_ELEVATOR_INSTALLED_YEAR); // corrects limit
			$('#elevator_installed_year_min').html(MIN_ELEVATOR_INSTALLED_YEAR);
			$('#elevator_installed_year_max').html(MAX_ELEVATOR_INSTALLED_YEAR+'+');
			$('#elevator_installed_year_slider').attr('data-slider-value','['+MIN_ELEVATOR_INSTALLED_YEAR+','+MAX_ELEVATOR_INSTALLED_YEAR+']');
			$('#elevator_installed_year_slider').slider({tooltip: 'disabled'});
			$('#elevator_installed_year_slider').on('slide',function(slideEvt){
				elevator_installed_year_min = slideEvt.value[0];
				elevator_installed_year_max = slideEvt.value[1];
				$('#elevator_installed_year_min').html(elevator_installed_year_min);
				
				if(elevator_installed_year_max==MAX_ELEVATOR_INSTALLED_YEAR)
				{
					$('#elevator_installed_year_max').html(elevator_installed_year_max+'+');
				}else{
					$('#elevator_installed_year_max').html(elevator_installed_year_max);
				}
			});
			$('#elevator_installed_year_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			$('#unit_price_slider').attr('data-slider-min',MIN_UNIT_PRICE); // corrects limit
			$('#unit_price_slider').attr('data-slider-max',MAX_UNIT_PRICE); // corrects limit
			$('#unit_price_slider').attr('data-slider-step',STEP_UNIT_PRICE); // corrects limit
			$('#unit_price_min').html(MIN_UNIT_PRICE);
			$('#unit_price_max').html(MAX_UNIT_PRICE+'+');
			$('#unit_price_slider').attr('data-slider-value','['+MIN_UNIT_PRICE+','+MAX_UNIT_PRICE+']');
			$('#unit_price_slider').slider({tooltip: 'disabled'});
			$('#unit_price_slider').on('slide',function(slideEvt){
				unit_price_min = slideEvt.value[0];
				unit_price_max = slideEvt.value[1];
				$('#unit_price_min').html(unit_price_min);
				
				if(unit_price_max==MAX_UNIT_PRICE)
				{
					$('#unit_price_max').html(unit_price_max+'+');
				}else{
					$('#unit_price_max').html(unit_price_max);
				}
			});
			$('#unit_price_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			
			$('#elevator_upgrade_year_slider').attr('data-slider-min',MIN_ELEVATOR_UPGRADE_YEAR); // corrects limit
			$('#elevator_upgrade_year_slider').attr('data-slider-max',MAX_ELEVATOR_UPGRADE_YEAR); // corrects limit
			$('#elevator_upgrade_year_slider').attr('data-slider-step',STEP_ELEVATOR_UPGRADE_YEAR); // corrects limit
			$('#elevator_upgrade_year_min').html(MIN_ELEVATOR_UPGRADE_YEAR);
			$('#elevator_upgrade_year_max').html(MAX_ELEVATOR_UPGRADE_YEAR+'+');
			$('#elevator_upgrade_year_slider').attr('data-slider-value','['+MIN_ELEVATOR_UPGRADE_YEAR+','+MAX_ELEVATOR_UPGRADE_YEAR+']');
			$('#elevator_upgrade_year_slider').slider({tooltip: 'disabled'});
			$('#elevator_upgrade_year_slider').on('slide',function(slideEvt){
				elevator_upgrade_year_min = slideEvt.value[0];
				elevator_upgrade_year_max = slideEvt.value[1];
				$('#elevator_upgrade_year_min').html(elevator_upgrade_year_min);
				
				if(elevator_upgrade_year_max==MAX_ELEVATOR_UPGRADE_YEAR)
				{
					$('#elevator_upgrade_year_max').html(elevator_upgrade_year_max+'+');
				}else{
					$('#elevator_upgrade_year_max').html(elevator_upgrade_year_max);
				}
			});
			$('#elevator_upgrade_year_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			
			$('#cap_rate_slider').attr('data-slider-min',MIN_CAP_RATE); // corrects limit
			$('#cap_rate_slider').attr('data-slider-max',MAX_CAP_RATE); // corrects limit
			$('#cap_rate_slider').attr('data-slider-step',STEP_CAP_RATE); // corrects limit
			$('#cap_rate_min').html(MIN_CAP_RATE);
			$('#cap_rate_max').html(MAX_CAP_RATE+'+');
			$('#cap_rate_slider').attr('data-slider-value','['+MIN_CAP_RATE+','+MAX_CAP_RATE+']');
			$('#cap_rate_slider').slider({tooltip: 'disabled'});
			$('#cap_rate_slider').on('slide',function(slideEvt){
				cap_rate_min = slideEvt.value[0];
				cap_rate_max = slideEvt.value[1];
				$('#cap_rate_min').html(cap_rate_min);
				
				if(cap_rate_max==MAX_CAP_RATE)
				{
					$('#cap_rate_max').html(cap_rate_max+'+');
				}else{
					$('#cap_rate_max').html(cap_rate_max);
				}
			});
			$('#cap_rate_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			
			$('#sale_price_slider').attr('data-slider-min',MIN_SALE_PRICE); // corrects limit
			$('#sale_price_slider').attr('data-slider-max',MAX_SALE_PRICE); // corrects limit
			$('#sale_price_slider').attr('data-slider-step',STEP_SALE_PRICE); // corrects limit
			$('#sale_price_min').html(MIN_SALE_PRICE);
			$('#sale_price_max').html(MAX_SALE_PRICE+'+');
			$('#sale_price_slider').attr('data-slider-value','['+MIN_SALE_PRICE+','+MAX_SALE_PRICE+']');
			$('#sale_price_slider').slider({tooltip: 'disabled'});
			$('#sale_price_slider').on('slide',function(slideEvt){
				sale_price_min = slideEvt.value[0];
				sale_price_max = slideEvt.value[1];
				$('#sale_price_min').html(sale_price_min);
				
				if(sale_price_max==MAX_SALE_PRICE)
				{
					$('#sale_price_max').html(sale_price_max+'+');
				}else{
					$('#sale_price_max').html(sale_price_max);
				}
			});
			$('#sale_price_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
		
		
			$('#assessed_value_slider').attr('data-slider-min',MIN_ASSESSED_VALUE); // corrects limit
			$('#assessed_value_slider').attr('data-slider-max',MAX_ASSESSED_VALUE); // corrects limit
			$('#assessed_value_slider').attr('data-slider-step',STEP_ASSESSED_VALUE); // corrects limit
			$('#assessed_value_min').html(MIN_ASSESSED_VALUE);
			$('#assessed_value_max').html(MAX_ASSESSED_VALUE+'+');
			$('#assessed_value_slider').attr('data-slider-value','['+MIN_ASSESSED_VALUE+','+MAX_ASSESSED_VALUE+']');
			$('#assessed_value_slider').slider({tooltip: 'disabled'});
			$('#assessed_value_slider').on('slide',function(slideEvt){
				assessed_value_min = slideEvt.value[0];
				assessed_value_max = slideEvt.value[1];
				$('#assessed_value_min').html(assessed_value_min);
				
				if(assessed_value_max==MAX_ASSESSED_VALUE)
				{
					$('#assessed_value_max').html(assessed_value_max+'+');
				}else{
					$('#assessed_value_max').html(assessed_value_max);
				}
			});
			$('#assessed_value_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			$('#boiler_installed_year_slider').attr('data-slider-min',MIN_BOILER_INSTALLED_YEAR); // corrects limit
			$('#boiler_installed_year_slider').attr('data-slider-max',MAX_BOILER_INSTALLED_YEAR); // corrects limit
			$('#boiler_installed_year_slider').attr('data-slider-step',STEP_BOILER_INSTALLED_YEAR); // corrects limit
			$('#boiler_installed_year_min').html(MIN_BOILER_INSTALLED_YEAR);
			$('#boiler_installed_year_max').html(MAX_BOILER_INSTALLED_YEAR+'+');
			$('#boiler_installed_year_slider').attr('data-slider-value','['+MIN_BOILER_INSTALLED_YEAR+','+MAX_BOILER_INSTALLED_YEAR+']');
			$('#boiler_installed_year_slider').slider({tooltip: 'disabled'});
			$('#boiler_installed_year_slider').on('slide',function(slideEvt){
				boiler_installed_year_min = slideEvt.value[0];
				boiler_installed_year_max = slideEvt.value[1];
				$('#boiler_installed_year_min').html(boiler_installed_year_min);
				
				if(boiler_installed_year_max==MAX_BOILER_INSTALLED_YEAR)
				{
					$('#boiler_installed_year_max').html(boiler_installed_year_max+'+');
				}else{
					$('#boiler_installed_year_max').html(boiler_installed_year_max);
				}
			});
			$('#boiler_installed_year_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			$('#boiler_upgrade_slider').attr('data-slider-min',MIN_BOILER_UPGRADE); // corrects limit
			$('#boiler_upgrade_slider').attr('data-slider-max',MAX_BOILER_UPGRADE); // corrects limit
			$('#boiler_upgrade_slider').attr('data-slider-step',STEP_BOILER_UPGRADE); // corrects limit
			$('#boiler_upgrade_min').html(MIN_BOILER_UPGRADE);
			$('#boiler_upgrade_max').html(MAX_BOILER_UPGRADE+'+');
			$('#boiler_upgrade_slider').attr('data-slider-value','['+MIN_BOILER_UPGRADE+','+MAX_BOILER_UPGRADE+']');
			$('#boiler_upgrade_slider').slider({tooltip: 'disabled'});
			$('#boiler_upgrade_slider').on('slide',function(slideEvt){
				boiler_upgrade_min = slideEvt.value[0];
				boiler_upgrade_max = slideEvt.value[1];
				$('#boiler_upgrade_min').html(boiler_upgrade_min);
				
				if(boiler_upgrade_max==MAX_BOILER_UPGRADE)
				{
					$('#boiler_upgrade_max').html(boiler_upgrade_max+'+');
				}else{
					$('#boiler_upgrade_max').html(boiler_upgrade_max);
				}
			});
			$('#boiler_upgrade_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
		
			$('#heat_age_slider').attr('data-slider-min',MIN_HEAT_AGE); // corrects limit
			$('#heat_age_slider').attr('data-slider-max',MAX_HEAT_AGE); // corrects limit
			$('#heat_age_slider').attr('data-slider-step',STEP_HEAT_AGE); // corrects limit
			$('#heat_age_min').html(MIN_HEAT_AGE);
			$('#heat_age_max').html(MAX_HEAT_AGE+'+');
			$('#heat_age_slider').attr('data-slider-value','['+MIN_HEAT_AGE+','+MAX_HEAT_AGE+']');
			$('#heat_age_slider').slider({tooltip: 'disabled'});
			$('#heat_age_slider').on('slide',function(slideEvt){
				heat_age_min = slideEvt.value[0];
				heat_age_max = slideEvt.value[1];
				$('#heat_age_min').html(heat_age_min);
				
				if(heat_age_max==MAX_HEAT_AGE)
				{
					$('#heat_age_max').html(heat_age_max+'+');
				}else{
					$('#heat_age_max').html(heat_age_max);
				}
			});
			$('#heat_age_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
		
			$('#sales_count_slider').attr('data-slider-min',MIN_SALES_COUNT); // corrects limit
			$('#sales_count_slider').attr('data-slider-max',MAX_SALES_COUNT); // corrects limit
			$('#sales_count_slider').attr('data-slider-step',STEP_SALES_COUNT); // corrects limit
			$('#sales_count_min').html(MIN_SALES_COUNT);
			$('#sales_count_max').html(MAX_SALES_COUNT+'+');
			$('#sales_count_slider').attr('data-slider-value','['+MIN_SALES_COUNT+','+MAX_SALES_COUNT+']');
			$('#sales_count_slider').slider({tooltip: 'disabled'});
			$('#sales_count_slider').on('slide',function(slideEvt){
				sales_count_min = slideEvt.value[0];
				sales_count_max = slideEvt.value[1]
				$('#sales_count_min').html(sales_count_min);
				
				if(sales_count_max==MAX_SALES_COUNT)
				{
					$('#sales_count_max').html(sales_count_max+'+');
				}else{
					$('#sales_count_max').html(sales_count_max);
				}
			});
			$('#sales_count_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			$('#windows_installed_year_slider').attr('data-slider-min',MIN_WINDOWS_INSTALLED_YEAR); // corrects limit
			$('#windows_installed_year_slider').attr('data-slider-max',MAX_WINDOWS_INSTALLED_YEAR); // corrects limit
			$('#windows_installed_year_slider').attr('data-slider-step',STEP_WINDOWS_INSTALLED_YEAR); // corrects limit
			$('#windows_installed_year_min').html(MIN_WINDOWS_INSTALLED_YEAR);
			$('#windows_installed_year_max').html(MAX_WINDOWS_INSTALLED_YEAR+'+');
			$('#windows_installed_year_slider').attr('data-slider-value','['+MIN_WINDOWS_INSTALLED_YEAR+','+MAX_WINDOWS_INSTALLED_YEAR+']');
			$('#windows_installed_year_slider').slider({tooltip: 'disabled'});
			$('#windows_installed_year_slider').on('slide',function(slideEvt){
				windows_installed_year_min = slideEvt.value[0];
				windows_installed_year_max = slideEvt.value[1]
				$('#windows_installed_year_min').html(windows_installed_year_min);
				
				if(windows_installed_year_max==MAX_WINDOWS_INSTALLED_YEAR)
				{
					$('#windows_installed_year_max').html(windows_installed_year_max+'+');
				}else{
					$('#windows_installed_year_max').html(windows_installed_year_max);
				}
			});
			$('#windows_installed_year_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
			
			
		
			$('#units_slider').attr('data-slider-max',sliderLimit); // corrects limit
			$('#units_slider').slider({tooltip: 'disabled'});
			$('#units_slider').on('slide',function(slideEvt){
				unitsMin = slideEvt.value[0];
				unitsMax = slideEvt.value[1]
				$('#units_min').html(unitsMin);
				
				if(unitsMax==sliderLimit)
				{
					$('#units_max').html(unitsMax+'+');
				}else{
					$('#units_max').html(unitsMax);
				}
			});
			$('#units_slider').on('slideStop',function(slideEvt){
				setTimeout(function(){
					datatable.api().ajax.reload();
				},10);
			});
		}
		initSliders();
    	
        $(window).resize(function(){
        });
        
        $('#buildings tbody').on('click', 'tr', function () {
        	$(this).siblings().removeClass('selected');
        	$(this).removeClass('selected').addClass('selected');
	    });
	    
	    
        $("#start_time_gen" ).datetimepicker({
            language: 'en',
            format: 'yyyy-MM-dd hh:mm',
            pick12HourFormat: false,
            pickSeconds: false
        }).data('datetimepicker');
		$("#start_time_gen" ).data('datetimepicker').$element.on('changeDate',function(e,y){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		$('.bootstrap-datetimepicker-widget:not([picker_name])').attr('picker_name','start_time_gen');

        $("#end_time_gen" ).datetimepicker({
            language: 'en',
            format: 'yyyy-MM-dd hh:mm',
            pick12HourFormat: false,
            pickSeconds: false
        }).data('datetimepicker');
		$("#end_time_gen" ).data('datetimepicker').$element.on('changeDate',function(e,y){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		$('.bootstrap-datetimepicker-widget:not([picker_name])').attr('picker_name','end_time_gen');
		
		$("#start_mortgage_due_date_gen" ).datetimepicker({
            language: 'en',
            format: 'yyyy-MM-dd hh:mm',
            pick12HourFormat: false,
            pickSeconds: false
        }).data('datetimepicker');
		$("#start_mortgage_due_date_gen" ).data('datetimepicker').$element.on('start_mortgage_due_date_gen',function(e,y){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		$('.bootstrap-datetimepicker-widget:not([picker_name])').attr('picker_name','start_time_gen');
		
        $("#end_mortgage_due_date_gen" ).datetimepicker({
            language: 'en',
            format: 'yyyy-MM-dd hh:mm',
            pick12HourFormat: false,
            pickSeconds: false
        }).data('datetimepicker');
        $("#end_mortgage_due_date_gen" ).data('datetimepicker').setDate(null);
		$("#end_mortgage_due_date_gen" ).data('datetimepicker').$element.on('changeDate',function(e,y){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});
		$('.bootstrap-datetimepicker-widget:not([picker_name])').attr('picker_name','end_mortgage_due_date_gen');
		
        
        
        
        salepicker = $("#new_sale_date_gen" ).datetimepicker({
            language: 'en',
            format: 'yyyy-MM-dd hh:mm',
            pick12HourFormat: false,
            pickSeconds: false
        }).data('datetimepicker');
		$('.bootstrap-datetimepicker-widget:not([picker_name])').attr('picker_name','new_sale_date_gen');
        
        $('#sale_price').keyup(function(){
          	var priceperunit = 0 ;
	        if(!isNaN(parseInt(building.get('unit_quantity')))&&!isNaN(parseInt($('#sale_price').autoNumeric('get')))){
	        	priceperunit = (parseInt($('#sale_price').autoNumeric('get')) / parseInt(building.get('unit_quantity'))).toFixed(2);			        	
	        }
        	$('#new_unit_price_calculated_radio_label').html('$'+priceperunit);//.formatMoney(2,'.',','));
    	});
    	
    	$('#confirmaddsale').click(function(){
    		//var options = {
    		//	sale_price : $('#sale_price').val();
    		//	sale_date : $('#new_sale_date').val();
    		//	unit_price : $('#new_unit_price_manual_radio').is(':checked')?$('#new_unit_price').val():null;
    		//	building : building.toJSON();
    		//}
    		building.set('sale_id','new');
    		building.set('last_sale_price',parseInt($('#sale_price').autoNumeric('get')));
    		building.set('sale_date',$('#new_sale_date').val());
    		//building.set('buildingcontacts',buildingcontacts);
    		if($('#new_unit_price_manual_radio').is(':checked')&&!isNaN(parseFloat($('#new_unit_price').autoNumeric('get')))){
    			building.set('unit_price', parseFloat($('#new_unit_price').autoNumeric('get')));
    		}else{
    			building.set('unit_price',null);
    		}
    		//new_unit_price
    		
    		$('#save_building').click();
    		
			//socket.request('/building/edit',options,function(response){
			
			//});
			$('#addSaleModal').modal('hide');
		});
        
        function rebindDateTimePickerCloser(){
	        $('.bootstrap-datetimepicker-widget > div > div.close-datetime').unbind();
	        $('.bootstrap-datetimepicker-widget > div > div.close-datetime').click(function(){
	        	
	            $("#"+$(this).parent().parent().attr('picker_name')+"" ).data('datetimepicker').hide();
	        });
        }
        rebindDateTimePickerCloser();
        
        $('#advanced_criteria_toggler').click(function(){
        	if($('#collapseadvanced').height()<=0){
        		$('#advanced_criteria_toggler > div > i').removeClass('icon-plus-sign').removeClass('icon-minus-sign').addClass('icon-minus-sign');
        	}else{
        		$('#advanced_criteria_toggler > div > i').removeClass('icon-minus-sign').removeClass('icon-plus-sign').addClass('icon-plus-sign');
        	}
    	});
    	
    	
    	
    	function fileSelect(evt) {
		   if (window.File && window.FileReader && window.FileList && window.Blob) {
		        var files = document.getElementById('filesToUpload').files;
		        for(var i = 0; i < files.length; i++) {
		            resizeAndUpload(files[i]);
		        }
			} else {
				var files = document.getElementById('filesToUpload').files;
		        for(var i = 0; i < files.length; i++) {
		            upload(files[i],function(){
		            
		            });
		        }
			}
		}
		
		function upload(file,cb){
			socket.get('/upload/getPolicy',{},function(policy){
			 		
		 		if(lastImageUrl==''){
		 			lastImageUrl =  bucketPrefix + policy.filename+'.jpg';
		 		}else{
		 			lastThumbUrl = bucketPrefix + policy.filename+'.jpg';
		 		}
	 				 		
			 	var xhr =  new XMLHttpRequest();
				fd = new FormData();
			 
	    		xhr.upload.addEventListener("progress", uploadProgress, false);
				xhr.upload.addEventListener("load", transferComplete, false);
				xhr.upload.addEventListener("error", transferFailed, false);
	    		xhr.upload.addEventListener("loadstart", transferStart, false);
				
				// Populate the Post paramters.
				fd.append('key', policy.filename+'.jpg');
				fd.append('AWSAccessKeyId', policy.key);
				fd.append('acl', 'private');
				fd.append('success_action_status', "200");
				fd.append('policy', policy.policy);
				fd.append('signature',policy.signature);
				fd.append('file', file);
				xhr.open('POST', '//s3-us-west-2.amazonaws.com/credimages', true);
				xhr.send(fd);
				
				cb();
	 		});
		}
		
		function canvasResize(width,height){
		 	var tempW = tempImg.width;
	        var tempH = tempImg.height;
	        if (tempW > tempH) {
	            if (tempW > width) {
	               tempH *= width / tempW;
	               tempW = width;
	            }
	        } else {
	            if (tempH > height) {
	               tempW *= height / tempH;
	               tempH = height;
	            }
	        }
	 
	        var canvas = document.createElement('canvas');
	        canvas.width = tempW;
	        canvas.height = tempH;
	        var ctx = canvas.getContext("2d");
	        ctx.drawImage(tempImg, 0, 0, tempW, tempH);
	        
	        return dataURItoBlob(canvas.toDataURL("image/jpeg"));
		}
		
		function resizeAndUpload(file) {
			var reader = new FileReader();
		    reader.onloadend = function() {
			 
			    tempImg = new Image();
			    tempImg.src = reader.result;
			    tempImg.onload = function() {
			    
			    	upload(canvasResize(MAX_WIDTH,MAX_HEIGHT),function(){
			    	
			    	});
			 		
				}
		   }
		   reader.readAsDataURL(file);
		}
		
		function uploadProgress(evt){
			if (evt.lengthComputable) {
			
				if(lastThumbUrl==''){ //(uploading main image)
					$('.building-photo-wrapper > .span3:last').find('.progress > .bar').css('width',Math.round(evt.loaded * 75 / evt.total)+'%');
				}else{
					$('.building-photo-wrapper > .span3:last').find('.progress > .bar').css('width',(75+Math.round(evt.loaded * 25 / evt.total))+'%');
				}
			}
		}
		
		function transferStart(evt){
			if(lastThumbUrl==''){
				$('.building-photo-wrapper').append(buildingphototemplate({image:'',thumb:'',enabled:true}));
				$('.building-photo-wrapper > .span3:last').find('#UploadGif').css('display','block');
				$('.building-photo-wrapper > .span3:last').find('.progress').css('display','block');
				$('.building-photo-wrapper > .span3:last').find('.UploadGif_block').css('height',(parseInt($('.building-photo-wrapper').css('width'))/11) +'px');
				
			}
		}
		
		function transferComplete(evt){
			if(lastThumbUrl==''&&window.File && window.FileReader && window.FileList && window.Blob){
		    	upload(canvasResize(THMB_WIDTH,THMB_HEIGHT),function(){
		    	});
			}else{
				setTimeout(function(){
					$('.building-photo-wrapper > .span3:last').find('.progress > .bar').css('width',100+'%');
					$('.building-photo-wrapper > .span3:last').css('min-height',$('.building-photo-wrapper > .span3:last').height());
					
					$('.building-photo-wrapper > .span3:last').find('img').css('display','none');
					$('.building-photo-wrapper > .span3:last').find('img').attr('src',lastImageUrl);
					$('.building-photo-wrapper > .span3:last').find('img').attr('thumb',lastThumbUrl);
					
					var tmpSlide = new Image();
		            tmpSlide.onload = function () {
						$('.building-photo-wrapper > .span3:last').find('#UploadGif').css('display','none');
						$('.building-photo-wrapper > .span3:last').find('.progress').css('display','none');
						$('.building-photo-wrapper > .span3:last').find('img').css('display','block');
		            	$('.building-photo-wrapper > .span3:last').css('min-height','');
		            };
		            tmpSlide.src = $('.building-photo-wrapper > .span3:last').find('img').attr('src');
					
					building.set('dosync',true);
					setChangesPending();
					
					lastThumbUrl = '';  // reset the thumbnail url's for next uploads
					lastImageUrl = '';
					$('.fileinput-button').removeAttr('disabled');
					$('.building-photo-wrapper > .span3:last').find('.buildingimagetrash').click(function(){
						$(this).parents('.buildingimage').remove();
					});
				},500);
			}
			
		}
		
		function transferFailed(evt){
			console.log('transfer failed');
		}
		
		
		function dataURItoBlob(dataURI) {
		    var binary = atob(dataURI.split(',')[1]);
		    var array = [];
		    for(var i = 0; i < binary.length; i++) {
		        array.push(binary.charCodeAt(i));
		    }
		    return new Blob([new Uint8Array(array)], {type: 'image/jpeg'});
		}
    	
    	
    	
	    	 // just shows the changes are pending, by scanning through the collection to see if that's the case.
	    function setChangesPending(){
	        var change = false;
            if(typeof(building.get('dosync'))!='undefined'){
               change= true;
            }
            buildingcontacts.each(function(bcontact){
            	if(typeof(bcontact.get('dodelete'))!='undefined'||typeof(bcontact.get('dosync'))!='undefined')
            	{
            		change = true;
            	}
            });
            if(typeof($('#save_building')[0])!='undefined'){
	        	$('#save_building')[0].disabled = !change;
            }
            if(typeof($('#save_notes')[0])!='undefined'){
            	if(!change){
            		$('#save_notes').addClass('disabled');
        		}else{
            		$('#save_notes').removeClass('disabled');
        		}
            }
	        if(change){
	            $('#changes_pending').css('display','block');
	        }
	        else{
	            $('#changes_pending').css('display','none');
	        }
	    }
    	
    	function parseBuildingImages(){
    		var response = [];
    		$('.buildingimage img').each(function(){
    			response.push({image:$(this).attr('src'),thumb:$(this).attr('thumb')});
    		});
    		return response;
    	}
    	
    	$('#save_building').click(function(){
    		building.set('images',parseBuildingImages());
    		var wasnew = building.get('building_id')=='new'?true:false;
    		var sendobj = {building:building, buildingnotes : buildingnotes, buildingcontacts:buildingcontacts};
    		socket.get('/buildings/savebuilding',sendobj,function(response){
    		
                $('.alert-success').remove();
                $('.page-banner').after('<div class="alert alert-success fade in" style="border-radius:0px;">'+
                        '<button type="button" class="close" data-dismiss="alert">×</button>'+
                        '<strong>'+'Success'+':&nbsp</strong>'+'Changes have been saved'+'</div>');
                $('.main-content')[0].scrollTop=0;
                
                setTimeout(function(){ // wait for database to be ready
                	if(wasnew){
						$('.edit-item-section').css('display','none');
						$('#delete_building').css('display','none');
                	}else{
		                if(typeof(building.get('sale_id'))!='undefined'){
		                	building.fetch({id:response.building_id, sale_id: building.get('sale_id')=='new'?response.sale_id:parseInt(building.get('sale_id'))});  
		                }else{
		                	building.fetch({id:response.building_id});  
		                }
                	}
	                datatable.api().ajax.reload(function(){},false);
                },100);
                
                
                        
                setTimeout(function(){
                    setTimeout(function(){
                        $('.alert-success').remove();
                    },500);
                    $('.alert-success').removeClass('in');
                },alert_fadeout_time);
    		});
		});
    	
    	
		///////////////////////////
	    /// BUILDING       ////////
	    ///////////////////////////
	    	
	    	
		var BuildingModel = Backbone.Model.extend({
	        urlRoot: '/buildings/getbuilding',
	        socket:null,
	        sync:function(method,model,options){
	        	var where = options;
	            if(typeof this.urlRoot === "string" && this.urlRoot !== "") {
	                this.socket = socket;
	            	var collectionid = where.id?'/'+where.id:'';
	                this.socket.request(this.urlRoot+collectionid, where, _.bind(function(building){
	                    if(building.error != undefined){  // USER NO LONGER LOGGED IN!!!!!
	                        location.reload(); // Will boot back to login screen
	                    }
	                    this.clear();
	                    this.set(building);
	                    if(buildingView==null){
	                    	buildingView = new BuildingBackboneView();
	                    	buildingView.render();
	                    }else{
	                    	buildingView.render();
	                    }
	                }, this));
	            }
	        
	        }
	    });
	
	
	    var building = new BuildingModel();
	
	
	
	
	
	    	//var buildingtemplate = _.template($('#building-details-template').html());
	    	//$('.building-details-frame').append(buildingtemplate());
	    	
	    ///////////////////////////
	    /// Building      View ////
	    ///////////////////////////
	
	    var BuildingBackboneView = Backbone.View.extend({
	        el: '#main-building-details',
	        events: {
	            "keyup .building-segment-wrapper input" : "inputChange",
	            "change .building-segment-wrapper input" : "inputChange",
	            "change .building-segment-wrapper select" : "inputChange",
	            "keyup .unit-price-dependant" : "unitPriceChange",
	            "keyup .total-units-dependant": "roomUnitsChange",
	            "keyup #unit_quantity":"unitQuantityChange",
	            "keyup #building_income":"updateCapRate",
	            "keyup #last_sale_price":"updateCapRate"
	        },
	        updateCapRate:function(event){
	        	var calculatedCapRate = ((building.get('building_income')/building.get('last_sale_price'))*100).toFixed(0);
	        	building.set('cap_rate',calculatedCapRate);
	        	$('#cap_rate').html(isNaN(calculatedCapRate)?(0+'%'):(calculatedCapRate+'%'));
	        },
	        unitQuantityChange:function(event){
	        	//if(!building.get('building_income_manual_mode')){  // if automatic mode 
	        		// Calculate the Average unit price.
	        		this.updateBuildingIncome();
	        		
	        	//}else{
	        	//	this.unitQuantityChange();
	        	//}
	        },
	        unitPriceChange:function(event){
	        	if(!building.get('unit_price_manual_mode')){  // if automatic mode 
	        		// Calculate the Average unit price.
	        		this.updateCalculatedPrice();
	        	}
	        },
	        roomUnitsChange:function(event){
	        	$('#unit_quantity').val(parseInt($('#bachelor_units').val())+parseInt($('#bedroom1_units').val())+parseInt($('#bedroom2_units').val())+parseInt($('#bedroom3_units').val()));
	        	building.set('unit_quantity',$('#unit_quantity').val());
	        	this.unitQuantityChange();
	        },
	        updateCalculatedPrice : function(){
	        		var bachelorRent = isNaN(parseFloat($('#bachelor_price').autoNumeric('get')))?0:parseFloat($('#bachelor_price').autoNumeric('get'));
	        		var bedroom1Rent = isNaN(parseFloat($('#bedroom1_price').autoNumeric('get')))?0:parseFloat($('#bedroom1_price').autoNumeric('get'));
	        		var bedroom2Rent = isNaN(parseFloat($('#bedroom2_price').autoNumeric('get')))?0:parseFloat($('#bedroom2_price').autoNumeric('get'));
	        		var bedroom3Rent = isNaN(parseFloat($('#bedroom3_price').autoNumeric('get')))?0:parseFloat($('#bedroom3_price').autoNumeric('get'));
	        		
	        		var bachelorUnits = isNaN(parseInt($('#bachelor_units').val()))?0:parseInt($('#bachelor_units').val());
	        		var bedroom1Units = isNaN(parseInt($('#bedroom1_units').val()))?0:parseInt($('#bedroom1_units').val());
	        		var bedroom2Units = isNaN(parseInt($('#bedroom2_units').val()))?0:parseInt($('#bedroom2_units').val());
	        		var bedroom3Units = isNaN(parseInt($('#bedroom3_units').val()))?0:parseInt($('#bedroom3_units').val());
	        		
	        		var averagePrice = 0;
	        		if((bachelorUnits+bedroom1Units+bedroom2Units+bedroom3Units)!=0){
	        			averagePrice = (((bachelorRent*bachelorUnits)+(bedroom1Rent*bedroom1Units)+(bedroom2Rent*bedroom2Units)+(bedroom3Rent*bedroom3Units))/(bachelorUnits+bedroom1Units+bedroom2Units+bedroom3Units)).toFixed(2);
	        		
	        		}
	        		$('#unit_price_calculated_radio_label').html('$'+(isNaN(parseFloat(averagePrice))?'0.00':parseFloat(averagePrice).toFixed(2)));
	        		building.set('unit_price',parseFloat(averagePrice));
	        		this.unitQuantityChange();
	        },
	        updateBuildingManualPrice:function(){
	        
	        },
	        updateBuildingIncome : function(){
	        	if(!building.get('building_income_manual_mode')){
	        		var averageUnitPrice = isNaN(parseInt(building.get('unit_price')))?0:parseInt(building.get('unit_price'));
	        		var numberOfUnits = isNaN(parseInt(building.get('unit_quantity')))?0:parseInt(building.get('unit_quantity'));
	        		
	        		
	        		var buildingIncome = (averageUnitPrice*numberOfUnits*12).toFixed(2);
	        		
	        		$('#income_calculated_radio_label').html('$'+parseFloat(buildingIncome).toFixed(2));
	        		building.set('building_income',parseFloat(buildingIncome));
	        		this.updateCapRate();
        		}else{
	        		this.updateCapRate();
        		
        		}
	        },
	        inputChange:function(event){
	        	building.set('dosync',true);
	        	if(typeof(building.get($(event.target).attr('id')))!='undefined'){
	        		var targetId = $(event.target).attr('id');
	        		if(['assessed_value','last_sale_price','building_income','unit_price','bachelor_price','bedroom1_price','bedroom2_price','bedroom3_price'].indexOf($(event.target).attr('id'))>-1){
	        			building.set($(event.target).attr('id'),parseFloat($(event.target).autoNumeric('get')));
	        			this.unitQuantityChange();
	        		}else if(['heat_system_type'].indexOf($(event.target).attr('id'))>-1){
	        			building.set($(event.target).attr('id'),parseInt($(event.target).val()));
	        			
	        		}else if($(event.target).attr('type')=='checkbox'){
	        			building.set($(event.target).attr('id'),($(event.target).is(':checked')?1:0));
	        		}else{
	        			building.set($(event.target).attr('id'),$(event.target).val());
	        		}
	        	}else if($(event.target).attr('id')=='income_calculated_radio'){
	        		building.set('building_income_manual_mode',false);
	        		$('#building_income').attr('disabled','disabled');
	        		$('#building_income').val('');
	        		this.updateBuildingIncome();
	        	}else if($(event.target).attr('id')=='income_manual_radio'){
	        		building.set('building_income_manual_mode',true);
	        		$('#building_income').removeAttr('disabled');
	        		$('#building_income').val('$'+(building.get('building_income')==null?'0.00':building.get('building_income').toFixed(2)));
	        		$('#income_calculated_radio_label').empty();
	        	}else if($(event.target).attr('id')=='unit_price_calculated_radio'){
	        		building.set('unit_price_manual_mode',false);
	        		$('#unit_price').attr('disabled','disabled');
	        		$('#unit_price').val('');
	        		this.updateCalculatedPrice();
	        		this.unitQuantityChange();
	        	}else if($(event.target).attr('id')=='unit_price_manual_radio'){
	        		building.set('unit_price_manual_mode',true);
	        		$('#unit_price').removeAttr('disabled');
	        		$('#unit_price').val('$'+(building.get('unit_price')==null?'0.00':building.get('unit_price').toFixed(2)));
	        		$('#unit_price_calculated_radio_label').empty();
	        	}
	        	setChangesPending();
	        },
	        initialize: function () {
	            //this.render();
	        },
	        template: _.template($('#building-details-template').html()),
	        render: function () {
	        
	        	if($("#last_sale_date_gen").data('datetimepicker')!=null){
	        		$("#last_sale_date_gen").data('datetimepicker').destroy();
        		}
	        	if($("#mortgage_due_date_gen").data('datetimepicker')!=null){
	        		$("#mortgage_due_date_gen").data('datetimepicker').destroy();
        		}
	            this.$el.html("");
	            
	            if(typeof(building.get('sale_id'))!='undefined'){
	            	$('#building-section-title').html('Sales History Details');
	            }else if(building.get('building_id')=='new'){
	            	$('#building-section-title').html('Create Building');
	            }else{
	            	$('#building-section-title').html('Edit Building Details');
	            }
	            
	            
	            this.$el.append(this.template(building.toJSON()));
	            if(user.policy.update==0){
		        	$('#main-building-details input').attr('disabled','disabled');
		        	$('#main-building-details select').attr('disabled','disabled');
		        	
		        	
		        	$('#save_notes').click(function(){
		        		if($(this).hasClass('disabled')){
		        			return;
		        		}
			    		var sendobj = {building:building, buildingnotes : buildingnotes};
			    		socket.get('/buildings/savebuilding',sendobj,function(response){
			    		
			                $('.alert-success').remove();
			                $('.page-banner').after('<div class="alert alert-success fade in" style="border-radius:0px;">'+
			                        '<button type="button" class="close" data-dismiss="alert">×</button>'+
			                        '<strong>'+'Success'+':&nbsp</strong>'+'Changes have been saved'+'</div>');
			                $('.main-content')[0].scrollTop=0;
		                	building.fetch({id:response.building_id});
			                        
			                setTimeout(function(){
			                    setTimeout(function(){
			                        $('.alert-success').remove();
			                    },500);
			                    $('.alert-success').removeClass('in');
			                },alert_fadeout_time);
			    		});
					});
	            }
	            $('.edit-item-section').css('display','block');
	         
	         	$('#heat_system_age').autoNumeric('init',{vMin: '0', vMax: '2099', mDec: '0',aSep: ''});
	         	$('#boiler_installed_year').autoNumeric('init',{vMin: '0', vMax: '2099', mDec: '0',aSep: ''});
	         	$('#windows_installed_year').autoNumeric('init',{vMin: '0', vMax: '2099', mDec: '0',aSep: ''});
	         	$('#elevator_installed_year').autoNumeric('init',{vMin: '0', vMax: '2099', mDec: '0',aSep: ''});
	         	$('#last_elevator_upgrade_year').autoNumeric('init',{vMin: '0', vMax: '2099', mDec: '0',aSep: ''});
	         	
	         	
	         	$('#last_boiler_upgrade_year').autoNumeric('init',{vMin: '0', vMax: '2099', mDec: '0',aSep: ''});
	         	$('#unit_quantity').autoNumeric('init',{vMin: '0', vMax: '9999', mDec: '0',aSep: '',wEmpty: 'zero'});
	         	$('#unit_price').autoNumeric('init',{aSign: '$', vMin: '0', vMax: '999999', mDec: '2',aSep: '',wEmpty: 'zero'});
	         	$('#building_income').autoNumeric('init',{aSign: '$', vMin: '0', vMax: '99999999999', mDec: '2',aSep: '',wEmpty: 'zero'});
	         	$('#last_sale_price').autoNumeric('init',{aSign: '$', vMin: '0', vMax: '99999999999', mDec: '2',aSep: '',wEmpty: 'zero'});
	         	$('#assessed_value').autoNumeric('init',{aSign: '$', vMin: '0', vMax: '99999999999', mDec: '2',aSep: '',wEmpty: 'zero'});
	         	$('#bachelor_price').autoNumeric('init',{aSign: '$', vMin: '0', vMax: '99999', mDec: '2',aSep: ',',wEmpty: 'zero'});
	         	$('#bedroom1_price').autoNumeric('init',{aSign: '$', vMin: '0', vMax: '99999', mDec: '2',aSep: ',',wEmpty: 'zero'});
	         	$('#bedroom2_price').autoNumeric('init',{aSign: '$', vMin: '0', vMax: '99999', mDec: '2',aSep: ',',wEmpty: 'zero'});
	         	$('#bedroom3_price').autoNumeric('init',{aSign: '$', vMin: '0', vMax: '99999', mDec: '2',aSep: ',',wEmpty: 'zero'});
	         	
	         	$('#bachelor_price').autoNumeric('update');
	         	$('#bedroom1_price').autoNumeric('update');
	         	$('#bedroom2_price').autoNumeric('update');
	         	$('#bedroom3_price').autoNumeric('update');
	         	$('#assessed_value').autoNumeric('update');
	         	$('#last_sale_price').autoNumeric('update');
	         	
	         	$('#bachelor_units').autoNumeric('init',{vMin: '0', vMax: '9999', mDec: '0',aSep: '',wEmpty: 'zero'});
	         	$('#bedroom1_units').autoNumeric('init',{vMin: '0', vMax: '9999', mDec: '0',aSep: '',wEmpty: 'zero'});
	         	$('#bedroom2_units').autoNumeric('init',{vMin: '0', vMax: '9999', mDec: '0',aSep: '',wEmpty: 'zero'});
	         	$('#bedroom3_units').autoNumeric('init',{vMin: '0', vMax: '9999', mDec: '0',aSep: '',wEmpty: 'zero'});
	         	if(triggerScroll){
		            if($('body').width()>979){
						$('.main-content').animate({
					        scrollTop: $(".edit-item-section").offset().top - $('.navbar-fixed-top').height()
					    }, 1000);
					}else{
						$('html, body').animate({
					        scrollTop: $(".edit-item-section").offset().top
					    }, 1000);
					}
					triggerScroll = false;
				}
	            
	            
	            if(typeof(building.get('sale_id'))=='undefined'){
					buildingnotes.fetch({id:building.get('building_id')});
					buildingcontacts.fetch({id:building.get('building_id')});
					$('.fileinput-button').removeAttr('disabled');
	            }else{
					buildingcontacts.fetch({id:building.get('building_id'),sale_id:building.get('sale_id')});
					$('.fileinput-button').attr('disabled','disabled');
	            }
				buildingsales.fetch({id:building.get('building_id')});
	            
	            if(building.get('images')!=''&&building.get('images')!='images'){
		            var images = $.parseJSON(building.get('images'));
		            for(var image in images){
						$('.building-photo-wrapper').append(buildingphototemplate({image:images[image].image,thumb:images[image].thumb,enabled:typeof(building.get('sale_id'))=='undefined'}));
						$('.building-photo-wrapper > .span3:last').find('.buildingimagetrash').click(function(){
							$(this).parents('.buildingimage').remove();
							building.set('dosync',true);
							setChangesPending();
						});
		            }
	            }
	        
	            
		    	$('.fileinput-button').click(function(){
		    		if(typeof($(this).attr('disabled'))=='undefined')
		    		{
		    			$('#filesToUpload').val('');
			    		$('#filesToUpload').click();
		    		}
		    	});
		    	
				$('#filesToUpload').change(function(){
		    		if($(this).val()!='')
		    		{
			    		$('.fileinput-button').attr('disabled','disabled');
						fileSelect();
		    		}
				});
				
					
			    $('#create_note').click(function(){
			    	if(typeof(buildingnotes)!='undefined'){
			    		var noteid = 'new_'+Math.floor((Math.random() * 1000000) + 1);
			    		var newbuildingnote = new BuildingNotesModel({id:noteid,note:'',timestamp:new Date(),user:'<%=req.session.user.username%>'});
			    		buildingnotes.add(newbuildingnote);
			    		buildingnotesView.render();
			    		
			        	
			    		$('.building-note[noteid='+noteid+'] .edit-note').click();
			    	}	
				});	
				
				
		        $("#last_sale_date_gen").datetimepicker({
		            language: 'en',
		            format: 'yyyy-MM-dd hh:mm',
		            pick12HourFormat: false,
		            pickSeconds: false
		        }).on('changeDate',function(e){
		        	building.set('sale_date',$("#last_sale_date_gen").data('datetimepicker').getLocalDate());//$('#sale_date').val());
		        	building.set('dosync',true);
		        	setChangesPending();
		        });
				$('.bootstrap-datetimepicker-widget:not([picker_name])').attr('picker_name','last_sale_date_gen');
		        var saleDate = new Date(building.get('sale_date'));
				$("#last_sale_date_gen").data('datetimepicker').setLocalDate(saleDate);

	            if(user.policy.update==1){
			        $('#last_sale_date_gen .add-on').click(function(){
			         	building.set('dosync',true);
			         });
			         $('#sale_date').click(function(){
			         	building.set('dosync',true);
			         });
			        
			        $("#mortgage_due_date_gen").datetimepicker({
			            language: 'en',
			            format: 'yyyy-MM-dd hh:mm',
			            pick12HourFormat: false,
			            pickSeconds: false
			        }).on('changeDate',function(e){
			        	building.set('mortgage_due_date',$("#mortgage_due_date_gen").data('datetimepicker').getLocalDate());//$('#sale_date').val());
			        	building.set('dosync',true);
			        	setChangesPending();
			        });
					$('.bootstrap-datetimepicker-widget:not([picker_name])').attr('picker_name','mortgage_due_date_gen');
			        var mortgageDate = new Date(building.get('mortgage_due_date'));
					$("#mortgage_due_date_gen").data('datetimepicker').setLocalDate(mortgageDate);
	
			        $('#mortgage_due_date_gen .add-on').click(function(){
			         	building.set('dosync',true);
			         });
			         $('#mortgage_due_date').click(function(){
			         	building.set('dosync',true);
			         });
			        
			        
			        
			        rebindDateTimePickerCloser();
		        }
		        
		        
		        
		        $('#create_sale').click(function(){
		        	$('#addSaleModal div.alert-error').remove();
			        $('#addSaleModal').modal('show');
			        $('#addSaleModal #myModalLabelAdd').html('Add Sale to Building');
			        $('#sale_price').val(building.get('last_sale_price'));
			        $('#sale_price').autoNumeric('update');
			        //$('#new_sale_date').val(new Date().toLocaleString());
			        salepicker.setLocalDate(new Date());
			        $('#new_unit_price_calculated_radio').click();
			        $('#new_unit_price').val('0');
			        $('#new_unit_price').autoNumeric('update');
			        $('#new_unit_price_calculated_radio')[0].checked = true;
			        
			        $('#sale_price').change();
			      
	        	});
	            
	            $('#add_owner').click(function(){
			        $('#addContactModal div.alert-error').remove();
			        $('.create-contact-message').html('To create a new owner, select the contact and/or company associated with this building.');
			        $('#addContactModal').modal('show');
			        $('#addContactModal #myModalLabelAdd').html('Add Owner to Building');
			        $('#confirmaddbuildingcontact').unbind();
			        
			        bindAddBuildingContactModal();
			        
			        $('#confirmaddbuildingcontact').click(function(){
	        	        $('#addContactModal div.alert-error').remove();
						if(newContactId==null&&newCompanyId==null)
						{
							$('#addContactModal div.modal-header').after(
	                    '<div class="alert alert-error fade in" style="margin-bottom:0px;" style="border-radius:0px;"><button type="button" class="close" data-dismiss="alert">×</button><strong>Error:&nbsp;</strong>Please select a Contact, Company or both.</div>');
	            			return;
						}
						
					
						buildingcontacts.add({
							mapping_id: 'new_'+Math.floor((Math.random() * 1000000) + 1)
							,contact_id: $('#mapping_new_contact_name').attr('contact_id')
							,dosync : true
							,contact_name: $('#mapping_new_contact_name').html()
							, contact_type:'owner'
							, cur_company_name:$('#mapping_new_company_name').html()
							, company_id : newCompanyId
							, email: $('#mapping_new_email').html()
							, phone_number: $('#mapping_new_phone').html()
							, street_number_begin:$('#mapping_address').attr('mapping_street_number_begin')
							, street_number_end:$('#mapping_address').attr('mapping_street_number_end')
							, street_name:$('#mapping_address').attr('mapping_street_name')
							, city:$('#mapping_address').attr('mapping_city')
							, province: $('#mapping_address').attr('mapping_province')
							, postal_code: $('#mapping_address').attr('mapping_postal_code')
						});
						buildingcontactsView.render();
            			$('#addContactModal').modal('hide');
						
					});
		        });
		        $('#add_seller').click(function(){
			        $('#addContactModal div.alert-error').remove();
			        $('.create-contact-message').html('To create a new seller, select the contact and/or company associated with this building.');
			        $('#addContactModal').modal('show');
			        $('#addContactModal #myModalLabelAdd').html('Add Seller to Building');
			        $('#confirmaddbuildingcontact').unbind();
			        
			        bindAddBuildingContactModal();
			        
			        $('#confirmaddbuildingcontact').click(function(){
	        	        $('#addContactModal div.alert-error').remove();
						if(newContactId==null&&newCompanyId==null)
						{
							$('#addContactModal div.modal-header').after(
	                    '<div class="alert alert-error fade in" style="margin-bottom:0px;" style="border-radius:0px;"><button type="button" class="close" data-dismiss="alert">×</button><strong>Error:&nbsp;</strong>Please select a Contact, Company or both.</div>');
	            			return;
						}
						
					
						buildingcontacts.add({
							mapping_id: 'new_'+Math.floor((Math.random() * 1000000) + 1)
							,contact_id: $('#mapping_new_contact_name').attr('contact_id')
							,dosync : true
							,contact_name: $('#mapping_new_contact_name').html()
							, contact_type:'seller'
							, cur_company_name:$('#mapping_new_company_name').html()
							, company_id : newCompanyId
							, email: $('#mapping_new_email').html()
							, phone_number: $('#mapping_new_phone').html()
							, street_number_begin:$('#mapping_address').attr('mapping_street_number_begin')
							, street_number_end:$('#mapping_address').attr('mapping_street_number_end')
							, street_name:$('#mapping_address').attr('mapping_street_name')
							, city:$('#mapping_address').attr('mapping_city')
							, province: $('#mapping_address').attr('mapping_province')
							, postal_code: $('#mapping_address').attr('mapping_postal_code')
						});
						buildingcontactsView.render();
            			$('#addContactModal').modal('hide');
						
					});
		        });
		        $('#add_agent').click(function(){
			        $('#addContactModal div.alert-error').remove();
			        $('.create-contact-message').html('To create a new agent, select the contact and/or company associated with this building.');
			        $('#addContactModal').modal('show');
			        $('#addContactModal #myModalLabelAdd').html('Add Agent to Building');
			        $('#confirmaddbuildingcontact').unbind();
			        
			        bindAddBuildingContactModal();
			        
			        $('#confirmaddbuildingcontact').click(function(){
	        	        $('#addContactModal div.alert-error').remove();
						if(newContactId==null&&newCompanyId==null)
						{
							$('#addContactModal div.modal-header').after(
	                    '<div class="alert alert-error fade in" style="margin-bottom:0px;" style="border-radius:0px;"><button type="button" class="close" data-dismiss="alert">×</button><strong>Error:&nbsp;</strong>Please select a Contact, Company or both.</div>');
	            			return;
						}
						
					
						buildingcontacts.add({
							mapping_id: 'new_'+Math.floor((Math.random() * 1000000) + 1)
							,contact_id: $('#mapping_new_contact_name').attr('contact_id')
							,dosync : true
							,contact_name: $('#mapping_new_contact_name').html()
							, contact_type:'agent'
							, cur_company_name:$('#mapping_new_company_name').html()
							, company_id : newCompanyId
							, email: $('#mapping_new_email').html()
							, phone_number: $('#mapping_new_phone').html()
							, street_number_begin:$('#mapping_address').attr('mapping_street_number_begin')
							, street_number_end:$('#mapping_address').attr('mapping_street_number_end')
							, street_name:$('#mapping_address').attr('mapping_street_name')
							, city:$('#mapping_address').attr('mapping_city')
							, province: $('#mapping_address').attr('mapping_province')
							, postal_code: $('#mapping_address').attr('mapping_postal_code')
						});
						buildingcontactsView.render();
            			$('#addContactModal').modal('hide');
						
					});
		        });
		        this.updateCapRate();
	            setChangesPending();
	        }
	    });
	    var buildingView;
	    var contactscombobox=null;	
	   	var contactssearchtimer = null;
	   	var curcontactsval = '';
	   	var newCompanyId = null;
	   	var companiescombobox=null;
	   	var curcompaniesval = '';
	   	var newContactId = null;
	    	
	    function bindAddBuildingContactModal(){
	    	// get the original data
	        socket.get('/buildings/getcontactsbycompanyid',{},function(res){
	        	$('select.contactscombobox').empty();
	        	for(var i=0;i<res.length;i++){
	        		$('select.contactscombobox').append('<option email="'+res[i].email+'" phone_number="' + res[i].phone_number + '" contact_id="'+res[i].contact_id+'" value="'+res[i].contact+'">'+res[i].contact+'</option');
	        	}
		        if(contactscombobox==null){
		        	contactscombobox = $('select.contactscombobox').combobox();
		        	$('input.contactscombobox').val('');
		        	$('input.contactscombobox').on('keyup',function(e){
		        		if(curcontactsval!=$('input.contactscombobox').val()&&e.keyCode!=9&&e.keyCode!=13&&e.keyCode!=27)
		        		{
		        			curcontactsval =  $('input.contactscombobox').val();
		        			updateContactsCombobox();
	        			}
		        		
	        		});
	        		
	        		$('input.contactscombobox').change(function(){
	        			var selectedoption = $('select.contactscombobox option[value="'+$('input.contactscombobox').val()+'"]');
	        			if(selectedoption.length==1)
	        			{
	        				newContactId =  parseInt(selectedoption.attr('contact_id'));
	        				console.log(newContactId);
	        				
	        				$('#mapping_new_contact_name').html(selectedoption.attr('value'));
	        				$('#mapping_new_contact_name').attr('contact_id',selectedoption.attr('contact_id'));
	        				$('#mapping_new_phone').html(selectedoption.attr('phone_number'));
	        				$('#mapping_new_email').html(selectedoption.attr('email'));
	        			}else{
	        				newContactId = null;
	        				console.log('cleared contact');
	        				updateContactsCombobox();
	        				
	        				$('#mapping_new_contact_name').attr('contact_id','');
	        				$('#mapping_new_contact_name').html('');
	        				$('#mapping_new_phone').html('');
	        				$('#mapping_new_email').html('');
	        			}
        			});
        			$('.contactscombobox').siblings('.add-on').find('.icon-remove').click(function(){
        				$('input.contactscombobox').val('');
        				$('input.contactscombobox').change();
    				});
        			$('.contactscombobox').siblings('.add-on').find('.caret').click(function(){
        				$('input.contactscombobox').val('');
        				$('input.contactscombobox').change();
    				});
        			$('.contactscombobox').siblings('.add-on').click(function(){
        				$('input.contactscombobox').val('');
        				$('input.contactscombobox').change();
    				});
    				
		        }else{
		        
					newCompanyId = null;
		        	newContactId=null;
		        	$('input.contactscombobox').val('');
		        	contactscombobox.data('combobox').refresh(); 
		        	$('input.contactscombobox').val('');
					
    				$('#mapping_new_contact_name').attr('contact_id','');
    				$('#mapping_new_contact_name').html('');
    				$('#mapping_new_phone').html('');
    				$('#mapping_new_email').html('');
		        }
	        });
	        
	        
	        
	        socket.get('/buildings/getcompaniesbycontactid',{},function(res){
	        	$('select.companiescombobox').empty();
	        	for(var i=0;i<res.length;i++){
	        		$('select.companiescombobox').append(
		        		'<option mapping_street_number_begin="'+res[i].street_number_begin+'" mapping_street_number_end="'+ res[i].street_number_end+'"'
		        		+ ' mapping_street_name="'+res[i].street_name+'"'
		        		+ ' mapping_city="'+res[i].city+'"' + ' mapping_province="'+res[i].province+'"'
		        		+ ' mapping_postal_code="'+res[i].postal_code + '"'
		        		+' company_id="'+res[i].company_id+'" value="'+res[i].company_name+'">'+res[i].company_name+'</option');
	        	
	        	}
		        if(companiescombobox==null){
		        	companiescombobox = $('select.companiescombobox').combobox();
		        	$('input.companiescombobox').val('');
		        	$('input.companiescombobox').on('keyup',function(e){
		        		if(curcompaniesval!=$('input.companiescombobox').val()&&e.keyCode!=9&&e.keyCode!=13&&e.keyCode!=27)
		        		{
							curcompaniesval =  $('input.companiescombobox').val();
							updateCompaniesCombobox();
	        			}
	        		});
	        		$('input.companiescombobox').change(function(){
	        			var selectedoption = $('select.companiescombobox option[value="'+$('input.companiescombobox').val()+'"]');
	        			if(selectedoption.length==1)
	        			{
	        				newCompanyId = parseInt(selectedoption.attr('company_id'));
	        				console.log(newCompanyId);
	        				//updateContactsCombobox();
	        				
	        				$('#mapping_new_company_name').html(selectedoption.attr('value'));
	        				$('#mapping_address').attr('mapping_street_number_begin',selectedoption.attr('mapping_street_number_begin'));
	        				$('#mapping_address').attr('mapping_street_number_end',selectedoption.attr('mapping_street_number_end'));
	        				$('#mapping_address').attr('mapping_street_name',selectedoption.attr('mapping_street_name'));
	        				$('#mapping_address').attr('mapping_city',selectedoption.attr('mapping_city'));
	        				$('#mapping_address').attr('mapping_province',selectedoption.attr('mapping_province'));
	        				$('#mapping_address').attr('mapping_postal_code',selectedoption.attr('mapping_postal_code'));
	        				
	        				
	        				$('#mapping_new_company_address_1').html(buildStreetString(selectedoption.attr('mapping_street_number_begin'),selectedoption.attr('mapping_street_number_end'),selectedoption.attr('mapping_street_name')));
	        				$('#mapping_new_company_address_2').html(buildCityProvinceString(selectedoption.attr('mapping_city'),selectedoption.attr('mapping_province')));
	        				$('#mapping_new_company_address_3').html(buildPostalCodeString(selectedoption.attr('mapping_postal_code')));
	        			}else{
        					newCompanyId = null;
        					updateCompaniesCombobox();
        					
	        				$('#mapping_new_company_name').html('');
	        				$('#mapping_address').attr('mapping_street_number_begin','');
	        				$('#mapping_address').attr('mapping_street_number_end','');
	        				$('#mapping_address').attr('mapping_street_name','');
	        				$('#mapping_address').attr('mapping_city','');
	        				$('#mapping_address').attr('mapping_province','');
	        				$('#mapping_address').attr('mapping_postal_code','');
	        				$('#mapping_address').attr('mapping_contact_id','');
	        				$('#mapping_new_company_address_1').html('');
	        				$('#mapping_new_company_address_2').html('');
	        				$('#mapping_new_company_address_3').html('');
        				}
        			});
        			$('.companiescombobox').siblings('.add-on').find('.icon-remove').click(function(){
        				$('input.companiescombobox').val('');
        				$('input.companiescombobox').change();
    				});
        			$('.companiescombobox').siblings('.add-on').find('.caret').click(function(){
        				$('input.companiescombobox').val('');
        				$('input.companiescombobox').change();
    				});
        			$('.companiescombobox').siblings('.add-on').click(function(){
        				$('input.companiescombobox').val('');
        				$('input.companiescombobox').change();
    				});
        			
		        }else{
					newCompanyId = null;
		        	newContactId=null;
		        	$('input.companiescombobox').val('');
		        	companiescombobox.data('combobox').refresh(); 
		        	$('input.companiescombobox').val('');
					
    				$('#mapping_new_company_name').html('');
    				$('#mapping_new_company_address_1').html('');
    				$('#mapping_new_company_address_2').html('');
    				$('#mapping_new_company_address_3').html('');
		        }
	        });
        }
	    	
	    function updateContactsCombobox(){
    		clearTimeout(contactssearchtimer);
    		contactssearchtimer = setTimeout(function(){
    			socket.get('/buildings/getcontactsbycompanyid',{search:curcontactsval,companyId:newCompanyId},function(res){
    				var tempval = $('input.contactscombobox').val();
        			$('select.contactscombobox').empty();
		        	for(var i=0;i<res.length;i++){
		        		$('select.contactscombobox').append('<option email="'+res[i].email+'" phone_number="'+res[i].phone_number+'" contact_id="'+res[i].contact_id+'" value="'+res[i].contact+'">'+res[i].contact+'</option');
		        	}
        			contactscombobox.data('combobox').refresh(); 
        			$('input.contactscombobox').val(tempval);
        			contactscombobox.data('combobox').lookup();
    			});
    		},100);
	    }
	    	
	    function updateCompaniesCombobox(){
	    	clearTimeout(contactssearchtimer);
    		contactssearchtimer = setTimeout(function(){		        	
    			socket.get('/buildings/getcompaniesbycontactid',{search:curcompaniesval,contactId:newContactId},function(res){
        			var tempval = $('input.companiescombobox').val();
        			$('select.companiescombobox').empty();
		        	for(var i=0;i<res.length;i++){
		        		
		        		$('select.companiescombobox').append(
			        		'<option mapping_street_number_begin="'+res[i].street_number_begin+'" mapping_street_number_end="'+ res[i].street_number_end+'"'
			        		+ ' mapping_street_name="'+res[i].street_name+'"'
			        		+ ' mapping_city="'+res[i].city+'"' + ' mapping_province="'+res[i].province+'"'
			        		+ ' mapping_postal_code="'+res[i].postal_code + '"'
			        		+' company_id="'+res[i].company_id+'" value="'+res[i].company_name+'">'+res[i].company_name+'</option');
		        	}
        			companiescombobox.data('combobox').refresh(); 
        			$('input.companiescombobox').val(tempval);
        			companiescombobox.data('combobox').lookup();
    			});
			},100);
		}
	    	
	    	
	    	
	    ///////////////////////////
	    /// BUILDING NOTES ////////
	    ///////////////////////////
	    	
		var BuildingNotesModel = Backbone.Model.extend({
	        urlRoot: '/buildings/note'
	    });
	
	    var BuildingNotesCollection = Backbone.Collection.extend({
	        sailsCollection: "",
	        socket: null,
	        sync: function(method, model, options){
	            var where = {};
	            if (options.where) {
	                where = {
	                    where: options.where
	                }
	            }
	            if(options.id){
	            	where.id = options.id;
	        	}
	            if(typeof this.sailsCollection === "string" && this.sailsCollection !== "") {
	                this.socket = socket;
	            	var collectionid = where.id?'/'+where.id:'';
	                this.socket.request("/" + this.sailsCollection+collectionid, where, _.bind(function(notes){
	                    if(notes.error != undefined){  // USER NO LONGER LOGGED IN!!!!!
	                        location.reload(); // Will boot back to login screen
	                    }
	                    this.set(notes);
	                    buildingnotesView = new BuildingNotesBackboneView({collection: buildingnotes});
	                }, this));
	            }
	        }
	    });
	
	    var BuildingNotesCollection = BuildingNotesCollection.extend({
	        sailsCollection: 'buildings/notes',
	        model: BuildingNotesModel
	    });
	
	    var buildingnotes = new BuildingNotesCollection();
	    //buildingnotes.fetch({id:11});
	
	
	
	
	
	    ///////////////////////////
	    /// BuildingNotes View ////
	    ///////////////////////////
	
	    var BuildingNotesBackboneView = Backbone.View.extend({
	        el: '#building-notes-wrapper',
	        events: {
	            //"change select.securityselect"   : "changeSecurity",
	            "click a.delete-note"   : "deleteNote",
	            "click a.edit-note" : "editNote"
	
	        },
	        editNote:function(event){
	        	var self = this;
	        	var blurTimeout;
	        	var trackdetailstyping = '';
	        	//event.target.parent('.building-note').find();
	        	var $notelement = $(event.target).parents('.building-note');
	        	var noteid= $notelement.attr('noteid');
	        	//var currentnote = $(event.target).parents('.building-note').find('.note-editable').html();
	        	//this.collection.get(noteid)
	        	$('.no-notes-remove').remove();
	        	$notelement.find('.note-editable').replaceWith('<div class="row-fluid"><div class="row-fluid"><textarea maxlength=512" class="note-textarea-editable">'+this.collection.get(noteid).get('note')+'</textarea></div><div class="row-fluid"><button class="save-note-textarea-editable btn btn-primary">Set</button><button class="cancel-note-textarea-editable btn ">Cancel</button></div></div>');
	        	
	        	//setTimeout(function(){
        		$notelement.find('.save-note-textarea-editable').unbind();
	        	$notelement.find('.save-note-textarea-editable').click(function(){
	        		self.collection.get(noteid).set('note', trackdetailstyping);//$notelement.find('.note-textarea-editable').val());
	        		self.collection.get(noteid).set('modified', true);
	        		building.set('dosync',true);
	        		setChangesPending();
	    		});
	    		$notelement.find('.note-textarea-editable').unbind();
	        	$notelement.find('.note-textarea-editable').blur(function(){
		        	blurTimeout = setTimeout(function(){
		        		self.render();
		        	},200);
	        	});
	        	$notelement.find('.note-textarea-editable').keyup(function(){
	        		trackdetailstyping = $notelement.find('.note-textarea-editable').val();
	        	});
	        	
	        	trackdetailstyping = $notelement.find('.note-textarea-editable').val();
	        	$notelement.find('.note-textarea-editable').focus();
		        	
	    		//},100);
	        	
	        },
	        deleteNote:function(event){
	        
	        
	        	var $notelement = $(event.target).parents('.building-note');
	        	var noteid= $notelement.attr('noteid');
	        	if($notelement.attr('noteid').indexOf("new")>-1){
	        		this.collection.remove(noteid);
	        		this.render();
	        	}else{
	        		this.collection.get(noteid).set('deleted',true);
	        		this.render();
	        	}
	        	building.set('dosync',true);
        		setChangesPending();
	        },
	        initialize: function () {
	            this.render();
	        },
	        template: _.template($('#building-notes-template').html()),
	        render: function () {
	            this.$el.html("");
	            
	        	if(building.get('building_id')!='new'){
	        		//$('#building-sales').css('display','')
	        	}
	            var tcollection = this.collection.sortBy(function(notes){
	                return notes.get("timestamp").toString().toUpperCase();
	            });
	
	            for(var i=0; i<tcollection.length; i++)
	            {
	                //if(!tcollection[i].isNew()){
	                if(typeof(tcollection[i].get('deleted'))=='undefined'){
	                	tcollection[i].set('note_datetime',toDateTimeString(tcollection[i].get('timestamp')));
	                	this.$el.prepend(this.template(tcollection[i].toJSON()));
	            	}
	                //}else{
	                //    this.$el.append(this.newusertemplate(tcollection[i].toJSON()));
	                //}
	            }
	            if(tcollection.length==0){
	            	this.$el.append('<div class="no-notes-remove">No Notes Found.</div>');
	            }
	            
	            
	            
	/*
	            // sorts by username
	            var tcollection = this.collection.sortBy(function(message){
	                return message.get("username").toString().toUpperCase();
	            });
	
	            for(var i=0; i<tcollection.length; i++)
	            {
	                if(!tcollection[i].isNew()){
	                    this.$el.append(this.template(tcollection[i].toJSON()));
	                }else{
	                    this.$el.append(this.newusertemplate(tcollection[i].toJSON()));
	                }
	            }
	            $('#adminusers > div.row-fluid:even').addClass('odd');
	            $('#adminusers > div.row-fluid:odd').addClass('even');
	*/
	            //setChangesPending();  // recalculates and displays if changes are pending
	        }
	    });
	    var buildingnotesView;
	    
	    	
	    	
	    	
	    	
	    	
	    	
	    	
	    	
	    	
	    	
	    	
	    /////////////////////////////////////////
	    ////// BUiLDING CONTACTS ////////////////
	    /////////////////////////////////////////
	    
	    
	    
	    var BuildingContactsModel = Backbone.Model.extend({
	        urlRoot: '///'
	    });
	
	    var BuildingContactsCollection = Backbone.Collection.extend({
	        sailsCollection: "",
	        socket: null,
	        sync: function(method, model, options){
	            var where = options;
	            if(typeof this.sailsCollection === "string" && this.sailsCollection !== "") {
	                this.socket = socket;
	            	var collectionid = where.id?'/'+where.id:'';
	                this.socket.request("/" + this.sailsCollection+collectionid, where, _.bind(function(contacts){
	                    if(contacts.error != undefined){  // USER NO LONGER LOGGED IN!!!!!
	                        location.reload(); // Will boot back to login screen
	                    }
	                    this.set(contacts[0]);
	                    if(buildingcontactsView==null)
	                    {
	                    	buildingcontactsView = new BuildingContactsBackboneView({collection: buildingcontacts});
                    	}
                    	else
                    	{
                    		buildingcontactsView.render();
                    	}
	                }, this));
	            }
	        }
	    });
	
	    var BuildingContactsCollection = BuildingContactsCollection.extend({
	        sailsCollection: 'buildings/getcontacts',
	        model: BuildingContactsModel
	    });
	
	    var buildingcontacts = new BuildingContactsCollection();
	
	
	
	
	
	    //////////////////////////////
	    /// BuildingContacts View ////
	    //////////////////////////////
	
	    var BuildingContactsBackboneView = Backbone.View.extend({
	        elowners: '#building-owners-wrapper',
	        elsellers: '#building-sellers-wrapper',
	        elagents: '#building-agents-wrapper',
	        events: {
	            //"change select.securityselect"   : "changeSecurity",
	            //"click a.remove-building-contact" : "deleteContact"
	        },
	        initialize: function () {
	            this.render();
	        },
	        template: _.template($('#building-contact-template').html()),
	        render: function () {
	            $(this.elowners).html("");
	            $(this.elsellers).html("");
	            $(this.elagents).html("");
	            
	            var tcollection = this.collection.sortBy(function(contacts){
	                return contacts.get("contact_name").toString().toUpperCase();
	            });
	
	            for(var i=0; i<tcollection.length; i++)
	            {
	            	tcollection[i].set('sale_id',building.get('sale_id'));
	               if(tcollection[i].get('contact_type')=='owner'){
	                	$(this.elowners).append(this.template(tcollection[i].toJSON()));
	            	}else if(tcollection[i].get('contact_type')=='seller'){
	                   $(this.elsellers).append(this.template(tcollection[i].toJSON()));
	                }else if(tcollection[i].get('contact_type')=='agent'){
	                   $(this.elagents).append(this.template(tcollection[i].toJSON()));
	                }
	            }
	            
	            $('a.remove-building-contact').unbind();
	            
	            $('a.remove-building-contact').click(function(){
	            	var newidtemp = '';
	            	var idstring = $(this).parents('.building-contact-wrapper').attr('contact_mapping_id');	            	
		            var modtemp  = buildingcontacts.findWhere({'mapping_id':idstring.indexOf('new')>-1?idstring:parseInt(idstring)});
		            if(idstring.indexOf('new')>-1){
		                buildingcontacts.remove(modtemp);
		            }else{
		                modtemp.set({dodelete:1});
		            }
	                buildingcontactsView.render();
		
		            setChangesPending();
	            	
	            	
            	});
            	setChangesPending();
	        }
	    });
	    var buildingcontactsView;	
	    	
    	
    	
    	
    	/////////////////////////////////////////
	    ////// BUiLDING SALES    ////////////////
	    /////////////////////////////////////////
	    
	    
	    
	    var BuildingSalesModel = Backbone.Model.extend({
	        urlRoot: '///'
	    });
	
	    var BuildingSalesCollection = Backbone.Collection.extend({
	        sailsCollection: "",
	        socket: null,
	        sync: function(method, model, options){
	            var where = {};
	            if (options.where) {
	                where = {
	                    where: options.where
	                }
	            }
	            if(options.id){
	            	where.id = options.id;
	        	}
	            if(typeof this.sailsCollection === "string" && this.sailsCollection !== "") {
	                this.socket = socket;
	            	var collectionid = where.id?'/'+where.id:'';
	                this.socket.request("/" + this.sailsCollection+collectionid, where, _.bind(function(sales){
	                    if(sales.error != undefined){  // USER NO LONGER LOGGED IN!!!!!
	                        location.reload(); // Will boot back to login screen
	                    }
	                    this.set(sales[0]);
	                    if(buildingsalesView==null)
	                    {
	                    	buildingsalesView = new BuildingSalesBackboneView({collection: buildingsales});
	                    
	                    }else{
	                    	buildingsalesView.render();
	                    }

	                }, this));
	            }
	        }
	    });
	
	    var BuildingSalesCollection = BuildingSalesCollection.extend({
	        sailsCollection: 'buildings/getsales',
	        model: BuildingSalesModel
	    });
	
	    var buildingsales = new BuildingSalesCollection();
	
	
	
	
	
	    //////////////////////////////
	    /// BuildingSales View ////
	    //////////////////////////////
	
	    var BuildingSalesBackboneView = Backbone.View.extend({
	        el: '#building-sales-table',
	        events: {
	            //"change select.securityselect"   : "changeSecurity",
	            "click div.building-sale-wrapper" : "selectedSale"
	
	        },
	        selectedSale : function(event){
	        	$('.building-sale-wrapper').removeClass('table-row-selected');
	        	$(event.target).parents('.building-sale-wrapper').addClass('table-row-selected');
	        	
				building.fetch({id:parseInt($(event.target).parents('.building-sale-wrapper').attr('building_id'))
				,sale_id:parseInt($(event.target).parents('.building-sale-wrapper').attr('sale_id'))}); // fetches the building (with the attached sale info)
	        	
	        },
	        initialize: function () {
	            this.render();
	        },
	        template: _.template($('#building-sale-template').html()),
	        render: function () {
	        	$(this.el).html('');
	        	
	        	if(building.get('building_id')!='new'){
	        		$('#building-sales').css('display','')
	        	}
	        	
	        	var tcollection = this.collection.sortBy(function(sales){
	                return sales.get("sale_date").toString().toUpperCase();
	            });
	            for(var i=0; i<tcollection.length; i++)
	            {
	            	if(typeof(building.get('sale_id'))!='undefined'&&parseInt(building.get('sale_id'))==tcollection[i].get('sale_id')){
	            		tcollection[i].set('selected',true);
						$('#delete_building').css('display','none')
	            	}
	            	tcollection[i].set('sale_datestring',toDateTimeString(tcollection[i].get('sale_date')));
	            	tcollection[i].set('formatted_sale_price','$'+tcollection[i].get('sale_price'));
                	$(this.el).prepend(this.template(tcollection[i].toJSON()));
	            }
	            
	            
	            $('#sales_title > i.icon-minus-sign').removeClass('icon-minus-sign').addClass('icon-plus-sign'); // resets the sign
	            $('#sales_title').unbind();
		        $('#delete_sale').unbind();
		        $('#delete_sale').click(function(){
		            $('#myModalLabeldeleteSale').html('Delete Sale');
		            $('#deleteSaleModal > div.modal-body').html('<p>Are you sure you want to delete this sale<b>'+'</b>?</p>');
		            $('#deleteSaleModal').modal('show');
	        	});
		        
		        // If the sales wrapper has data
	        	if($('#building-sales-table').html()!=''){
	        		$('#sales_title > i.icon-plus-sign').css('display','');
	        		$('#sales_title').css('cursor','pointer');
			        $('#sales_title').click(function(){
			        	if($('#building-sales-wrapper').css('display')=='none'){  //currently empty
			        		$('#sales_title > i.icon-plus-sign').removeClass('icon-plus-sign').addClass('icon-minus-sign');
			        	}else{  // currently shown
			        		$('#sales_title > i.icon-minus-sign').removeClass('icon-minus-sign').addClass('icon-plus-sign');
			        	}
			        	$('#building-sales-wrapper').slideToggle('medium',function(){
			        		if(typeof(building.get('sale_id'))!='undefined'&&$('#building-sales-wrapper').css('display')=='none'){ // sale mode
			        			//alert('YOU ARE LEAVING SALE MODE - youre guna lose your changes');
			        			$('#delete_building').css('display','');
			        			building.fetch({id:parseInt(building.get('building_id'))});
			        		}
			        	});
			        });
	        	}else{
	        		$('#sales_title > i.icon-plus-sign').css('display','none');
	        		$('#sales_title').css('cursor','default');
	        	}
	        	if(typeof(building.get('sale_id'))!='undefined')
	        	{
	        		$('#delete_sale').parent().css('display','');
	        		$('#create_sale').parent().css('display','none');
	        		$('#sales_title > i.icon-plus-sign').removeClass('icon-plus-sign').addClass('icon-minus-sign');
	        		if($('#building-sales-wrapper').css('display')=='none'){
	        			$('#sales_title').click();
	        		}
	        		
	        	}else{
	        		$('#delete_sale').parent().css('display','none');
	        		$('#create_sale').parent().css('display','');
	        		if(leaveSalesExpanded){
	        			leaveSalesExpanded=false;
	        			if($('#building-sales-wrapper').html()!=''){
	        				$('#sales_title > i.icon-plus-sign').removeClass('icon-plus-sign').addClass('icon-minus-sign');
	        			}
	        		}else{
			       		$('#building-sales-wrapper').css('display','none');
		       		}
	        	}
		        
		        
	            
	        	/*
	            $(this.elowners).html("");
	            $(this.elsellers).html("");
	            
	            var tcollection = this.collection.sortBy(function(sales){
	                return sales.get("sale_name").toString().toUpperCase();
	            });
	
	            for(var i=0; i<tcollection.length; i++)
	            {
	               if(tcollection[i].get('sale_type')=='owner'){
	                	$(this.elowners).append(this.template(tcollection[i].toJSON()));
	            	}else if(tcollection[i].get('sale_type')=='seller'){
	                   $(this.elsellers).append(this.template(tcollection[i].toJSON()));
	                }
	            }
	            
	            $('a.remove-building-sale').unbind();
	            
	            $('a.remove-building-sale').click(function(){
	            	var newidtemp = '';
	            	var idstring = $(this).parents('.building-sale-wrapper').attr('sale_mapping_id');	            	
		            var modtemp  = buildingsales.get(idstring);
		            if(idstring.indexOf('new')>-1){
		                buildingsales.remove(modtemp);
		            }else{
		                modtemp.set({dodelete:1});
		            }
	                buildingsalesView.render();
		
		            setChangesPending();
	            	
	            	
            	});
            	setChangesPending();*/
	        }
	    });
	    var buildingsalesView;	
    	
     	$('#sale_price').autoNumeric('init',{aSign: '$', vMin: '0', vMax: '99999999999', mDec: '2',aSep: '',wEmpty: 'zero'});
        $('#new_unit_price').autoNumeric('init',{aSign: '$', vMin: '0', vMax: '99999999999', mDec: '2',aSep: '',wEmpty: 'zero'});
        $('#new_unit_price_manual_radio').click(function(){
        	$('#new_unit_price').removeAttr('disabled');
        });
        
        $('#new_unit_price_calculated_radio').click(function(){
        	$('#new_unit_price').attr('disabled','disabled');
        });
    });
</script>

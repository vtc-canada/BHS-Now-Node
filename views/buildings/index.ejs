<%
    var translate = {
        'en' : {
            'You do not have sufficient privileges to access':'You do not have sufficient privileges to access',
            'Error':'Error',
            'Dashboard':'Dashboard',
            'Date':'Date',
            'Equipment':'Equipment',
            'Device':'Device',
            'Alarm Type':'Alarm Type',
            'System Health':'System Health',
            'System Throughput':'System Throughput',
            'Time In System':'Time In System',
            'BHS Overview':'BHS Overview',
            'Time':'Time',
            'Alarms':'Alarms',
            'Daily Reminders':'Daily Reminders',
            'Predictive Mainenance Tasks':'Predictive Mainenance Tasks',
            'DEVICE':'DEVICE',
            'REASON':'REASON',
            'Uptime':'Uptime',
            'Failsafe Rate':'Failsafe Rate',
            'Tracking Rate':'Tracking Rate',
            'Key Performance Indicators':'Key Performance Indicators',
            'Throughput (bph)':'Throughput (bph)',
            'State':'State',
            'Jam Rate':'Jam Rate',
            'ATR Read Rate':'ATR Read Rate'
        },
        'es' : {
            'You do not have sufficient privileges to access':'Usted no tiene suficientes privilegios para acceder a',
            'Error':'Error',
            'Dashboard':'Salpicadero',
            'Date':'Date',
            'Equipment':'Equipment',
            'Device':'Device',
            'REASON':'REASON',
            'Alarm Type':'Alarm Type',
            'System Health':'System Health',
            'System Throughput':'System Throughput',
            'Time In System':'Time In System',
            'BHS Overview':'BHS Overview',
            'Time':'Time',
            'Alarms':'Alarms',
            'Daily Reminders':'Daily Reminders',
            'Predictive Mainenance Tasks':'Predictive Mainenance Tasks',
            'DEVICE':'DEVICE',
            'Uptime':'Uptime',
            'Failsafe Rate':'Failsafe Rate',
            'Tracking Rate':'Tracking Rate',
            'Key Performance Indicators':'Key Performance Indicators',
            'Throughput (bph)':'Throughput (bph)',
            'State':'State',
            'Jam Rate':'Jam Rate',
            'ATR Read Rate':'ATR Read Rate'
        }
    }
%>

<div class="row-fluid page-banner">
    <div class="banner-div"><i class="icon-dashboard icon-1x banner-icon-top"></i><div class="banner-div-text"><%= translate[req.session.user.locale]['Dashboard'] %></div></div>
</div>

        <!-- Throws in Error messages if they were passed in from the controller -->
<% if(typeof(errormessage)!='undefined'){ %>
<div class="alert alert-error" style="border-radius:0px;">
    <button type="button" class="close" data-dismiss="alert">Ã—</button>
    <strong><%= translate[req.session.user.locale]['Error'] %>:</strong>
    <%= translate[req.session.user.locale][errormessage] %><% if(typeof(errorurl)!='undefined'){ %> <%= errorurl %><% } %>
</div>
<% } %>



<div class="row-fluid create-report-controls-wrapper">
    <div class="row">
        <div class="span8 offset2 create-report-controls" style="padding-top: 60px;">
           <div class="rowfluid">
               <div class="row">
                   <div class="span3 report-control-left-label" style="min-height: 20px;"><label for="reporttype">Quick Search:</label></div>
                   <div class="span8 report-control-right-control">
                       <input type="text" id="searchfield" value="York">
                   </div>
               </div>
               <div class="row" style="margin-top:15px;">
                   <div class="span7 report-control-left-label">
                   		<a id="advanced_criteria_toggler" data-toggle="collapse" data-target="#collapseadvanced" style="text-decoration: none; color: #5a6573;">
							<div style="float:left;"></i><i class="icon-plus-sign icon-2x"></i></div><div style="float: left; padding-bottom: 20px;margin-top: -6px;margin-left: 20px;"><h4>Advanced Criteria</h4></div>
						</a>
                   </div>
               </div>
               <div class="row collapse" id="collapseadvanced">
	               <div class="">
	                   <div class="span3 report-control-left-label" ><label for="reporttype">Units:</label></div>
	                   <div class="span3 report-control-right-control">
	                       <input type="text" style="width:120px; max-width:70%" id="unitsmin">
	                   </div>
	                   <div class="span1 report-control-right-control">
	                       <span style="display: inline-block;width: auto;height: 20px;min-width: 16px;padding: 4px 5px;font-size: 14px;font-weight: normal;line-height: 20px;">to</span>
	
	                   </div>
	                   <div class="span3 report-control-right-control">
	                       <input type="text" style="width:120px; max-width:70%" id="unitsmax">
	                   </div>
	               </div>
	               <div class="">
	               		<div class="span3 report-control-left-label" style="">
	               			<label for="start_time">Sale Date:</label>
	           			</div>
	           			<div class="input-append span3 report-control-right-control datetimepicker-gen">
	           				<input class="" data-format="yyyy-MM-dd" style="width:150px; max-width:70%;" id="start_time" type="text" value="">
	       					<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>
	       				</div>
	           			<div class="input-append span1 report-control-right-control datetimepicker-gen">
	       					<span style="display: inline-block;width: auto;height: 20px;min-width: 16px;padding: 4px 5px;font-size: 14px;font-weight: normal;line-height: 20px;">to</span>
						</div>
	           			<div class="input-append span3 report-control-right-control datetimepicker-gen">
	           				<input class="" data-format="yyyy-MM-dd" style="width:150px; max-width:70%;" id="end_time" type="text" value="">
	   						<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar" class="icon-calendar"> </i> </span>
	       				</div>
	       				
	   				</div>
	   			</div>
           </div>
        </div>
    </div>
</div>


<!-- There next templates are the pieces of the BHS Overview drawing -->
<!-- In order, they represent the columns across the diagram -->


<div class="row-fluid" style="margin-top:19px;">
    <div class="span10 offset1 page-controls-wrapper">
        <div class="row-fluid" id="reportheader"><span style="padding-left:10px;">Buildings</span></div>
        <div class="row-fluid key-indicaters-frame" id="iframediv">
            <div class="row-fluid">
                <table id="buildings" class="display" cellspacing="0" width="100%">
			        <thead>
			            <tr>
			            	<th>Id<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Address<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Units<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Owner<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Property Manager<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			                <th>Sale Date<i class="icon-caret-down"></i><i class="icon-caret-up"></i></th>
			            </tr>
			        </thead>
			 
			    </table>
            </div>
        </div>
    </div>
</div>


<div class="row-fluid" style="margin-top:19px;">
    <div class="span10 offset1 page-controls-wrapper">
        <div class="row-fluid" id="reportheader"><span style="padding-left:10px;">Building</span></div>
        <div class="row-fluid key-indicaters-frame" id="iframediv">
            <div class="span12">
                <form enctype="multipart/form-data" method="post" action="upload.php">
				    <div class="row-fluid">
				      <label for="fileToUpload">Select Files to Upload</label><br />
				      <input type="file" name="filesToUpload[]" id="filesToUpload" multiple="multiple" />
				      <output id="filesInfo"></output>
				    </div>
				    <div class="row-fluid">
				      <input type="submit" value="Upload" />
				    </div>
				</form>
            </div>
        </div>
    </div>
</div>
<script>
function fileSelect(evt) {
   if (window.File && window.FileReader && window.FileList && window.Blob) {
        var files = document.getElementById('filesToUpload').files;
        for(var i = 0; i < files.length; i++) {
            resizeAndUpload(files[i]);
        }
	} else {
	    alert('The File APIs are not fully supported in this browser.');
	}
}

function resizeAndUpload(file) {
	var reader = new FileReader();
    reader.onloadend = function() {
 
    var tempImg = new Image();
    tempImg.src = reader.result;
    tempImg.onload = function() {
 
        var MAX_WIDTH = 400;
        var MAX_HEIGHT = 300;
        var tempW = tempImg.width;
        var tempH = tempImg.height;
        if (tempW > tempH) {
            if (tempW > MAX_WIDTH) {
               tempH *= MAX_WIDTH / tempW;
               tempW = MAX_WIDTH;
            }
        } else {
            if (tempH > MAX_HEIGHT) {
               tempW *= MAX_HEIGHT / tempH;
               tempH = MAX_HEIGHT;
            }
        }
 
        var canvas = document.createElement('canvas');
        canvas.width = tempW;
        canvas.height = tempH;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(this, 0, 0, tempW, tempH);
        var dataURL = canvas.toDataURL("image/jpeg");
 
 		socket.get('/upload/getPolicy',{},function(policy){
 		
		 	var xhr =  new XMLHttpRequest(),
			fd = new FormData(),
			key = "testkey";
		 
			// Populate the Post paramters.
			fd.append('key', policy.filename+'.jpg');
			fd.append('AWSAccessKeyId', policy.key);
			fd.append('acl', 'private');
			fd.append('success_action_status', "200");
			fd.append('policy', policy.policy)
			fd.append('signature',policy.signature)
			//fd.append('Content-Type', '$Content-Type')
			// This file object is retrieved from a file input.
			fd.append('file', dataURL);
			xhr.open('POST', '//s3-us-west-2.amazonaws.com/CRED-building-images', true);
			xhr.send(fd);
			
 		});
 
	 
 
 
 
 
 /*
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function(ev){
            document.getElementById('filesInfo').innerHTML = 'Done!';
        };
 
        xhr.open('POST', 'uploadResized.php', true);
        xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
        var data = 'image=' + dataURL;
        xhr.send(data);*/
      }
 
   }
   reader.readAsDataURL(file);
}


 
document.getElementById('filesToUpload').addEventListener('change', fileSelect, false);




</script>


<script>


    var alarms;
    $(document).ready(function(){

		var datatable = $('#buildings').dataTable({
		        "processing": true,
		        "serverSide": true,
		        "dom":"tipr",
		        "ajax": {
		        	"url":"/buildings/getajax",
	        		"data":function(d){
	        			d.search = $("#searchfield").val();
	        			console.log($("#searchfield").val());
	        		}
	        	},
		        "aoColumns":[{"mData":"building_id","visible":false},
			        {"mData":function(data,b){ 
			        	return data.owner_contact==null?"":"<b>"+data.owner_contact.toString()+"</b>"; }
			        },{"mData":"street_number_begin"},{"mData":"city"},{"mData":"postal_code"},{"mData":"street_name"}
		        ],
		        "rowCallback": function( row, data, displayIndex ) {
					$(row).attr('building_id',data['building_id']);
					$(row).click(function(){
	               		selectBuilding($(row).attr('building_id'));
               		});
	               
		        }
	    });

		$('#searchfield').keydown(function(){
			setTimeout(function(){
				datatable.api().ajax.reload();
			},10);
		});

        $(window).resize(function(){
        });
        
        $('#buildings tbody').on('click', 'tr', function () {
        	$(this).siblings().removeClass('selected');
        	$(this).removeClass('selected').addClass('selected');
	    });
	    
	    
        $(".datetimepicker-gen" ).datetimepicker({
            language: 'en',
            format: 'yyyy-MM-dd hh:mm',
            pick12HourFormat: false,
            pickSeconds: false
        }).data('datetimepicker');

        $('.bootstrap-datetimepicker-widget > div > div.close-datetime').click(function(){
            $(".datetimepicker-gen" ).data('datetimepicker').hide();
        });
        
        $('#advanced_criteria_toggler').click(function(){
        	if($('#advanced_criteria_toggler > div > i').hasClass('icon-plus-sign')){
        		$('#advanced_criteria_toggler > div > i').removeClass('icon-plus-sign').addClass('icon-minus-sign');
        	}else{
        		$('#advanced_criteria_toggler > div > i').removeClass('icon-minus-sign').addClass('icon-plus-sign');
        	}
    	});
    	
    	function selectBuilding(buildingId){
    		socket.get('/buildings/getbuilding/'+buildingId,{},function(err,building){
    		
    		});
    	}
    	
    	
    	
        
    });
</script>
